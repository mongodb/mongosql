SchemaVersion: 2018-07-01
Owner: "@10gen/sql-engines-team"
Description: |
  Validate TPC_H normalized queries against queries generated by the server team. Note that numeric comparison is not exact in this workload;
  the AssertiveActor only ensures that any two values of numeric type are approximately equal according to a hard-coded limit.
  Adapted from the validate workload in the genny repository.


Clients:
  Default:
    QueryOptions:
      maxPoolSize: 100
      socketTimeoutMS: 10_800_000  # 3 hours
      # connectTimeoutMS: 3_600_000
    URI: "mongodb://localhost:27017"

ActorTemplates:
- TemplateName: ValidateTPCHQueryActorTemplate
  Config:
    Name: &query {^Parameter: {Name: "Query", Default: ""}}
    Type: AssertiveActor
    Database: &db tpch
    Phases:
    - &Nop {Nop: true}
    - Database: tpch
      Repeat: 1
      # Message: *query
      Expected: {^Parameter: {Name: "Expected", Default: {}}}
      Actual: {^Parameter: {Name: "Actual", Default: {}}}
    - *Nop

# Note: since the queries are all read-only and we don't care about timing metrics here, we can just run all the queries simultaneously.
Actors:
- ActorFromTemplate:
    TemplateName: ValidateTPCHQueryActorTemplate
    TemplateParameters:
      Query: 1
      Actual:
        LoadConfig:
          Path: ../../bic/normalized/phase/q1_normalized.yml
          Key: q1_normalized_aggregation
      Expected:
        LoadConfig:
          Path: ../../../../genny/src/phases/tpch/normalized/Q1.yml
          Key: TPCHNormalizedQuery1Aggregation
          Parameters:
            Query1Delta: -91
- ActorFromTemplate:
    TemplateName: ValidateTPCHQueryActorTemplate
    TemplateParameters:
      Query: 2
      Actual:
        LoadConfig:
          Path: ../../bic/normalized/phase/q2_normalized.yml
          Key: q2_normalized_aggregation
      Expected:
        LoadConfig:
          Path: ../../../../genny/src/phases/tpch/normalized/Q2.yml
          Key: TPCHNormalizedQuery2Aggregation
          Parameters:
            Query2Size: 20
            Query2Type: "^.*STEEL$"
            Query2Region: "AMERICA"
- ActorFromTemplate:
    TemplateName: ValidateTPCHQueryActorTemplate
    TemplateParameters:
      Query: 3
      Actual:
        LoadConfig:
          Path: ../../bic/normalized/phase/q3_normalized.yml
          Key: q3_normalized_aggregation
      Expected:
        LoadConfig:
          Path: ../../../../genny/src/phases/tpch/normalized/Q3.yml
          Key: TPCHNormalizedQuery3Aggregation
- ActorFromTemplate:
    TemplateName: ValidateTPCHQueryActorTemplate
    TemplateParameters:
      Query: 5
      Actual:
        LoadConfig:
          Path: ../../bic/normalized/phase/q5_normalized.yml
          Key: q5_normalized_aggregation
      Expected:
        LoadConfig:
          Path: ../../../../genny/src/phases/tpch/normalized/Q5.yml
          Key: TPCHNormalizedQuery5Aggregation
          Parameters:
            Query5Region: "AFRICA"
- ActorFromTemplate:
    TemplateName: ValidateTPCHQueryActorTemplate
    TemplateParameters:
      Query: 6
      Actual:
        LoadConfig:
          Path: ../../bic/normalized/phase/q6_normalized.yml
          Key: q6_normalized_aggregation
      Expected:
        LoadConfig:
          Path: ../../../../genny/src/phases/tpch/normalized/Q6.yml
          Key: TPCHNormalizedQuery6Aggregation
- ActorFromTemplate:
    TemplateName: ValidateTPCHQueryActorTemplate
    TemplateParameters:
      Query: 7
      Actual:
        LoadConfig:
          Path: ../../bic/normalized/phase/q7_normalized.yml
          Key: q7_normalized_aggregation
      Expected:
        LoadConfig:
          Path: ../../../../genny/src/phases/tpch/normalized/Q7.yml
          Key: TPCHNormalizedQuery7Aggregation
          Parameters:
            Query7Nation1: "UNITED STATES"
            Query7Nation2: "JAPAN"

# skip-reason: returns 0 rows, compared to server, atlas sql's 2
# - ActorFromTemplate:
#     TemplateName: ValidateTPCHQueryActorTemplate
#     TemplateParameters:
#       Query: 8
#       Actual:
#         LoadConfig:
#           Path: ../../bic/normalized/phase/q8_normalized.yml
#           Key: q8_normalized_aggregation
#       Expected:
#         LoadConfig:
#           Path: ../../../../genny/src/phases/tpch/normalized/Q8.yml
#           Key: TPCHNormalizedQuery8Aggregation
#           Parameters:
#             Query8Type: "ECONOMY BRUSHED STEEL"
#             Query8Region: "EUROPE"
#             Query8Nation: "UNITED STATES"

- ActorFromTemplate:
    TemplateName: ValidateTPCHQueryActorTemplate
    TemplateParameters:
      Query: 9
      Actual:
        LoadConfig:
          Path: ../../bic/normalized/phase/q9_normalized.yml
          Key: q9_normalized_aggregation
      Expected:
        LoadConfig:
          Path: ../../../../genny/src/phases/tpch/normalized/Q9.yml
          Key: TPCHNormalizedQuery9Aggregation
          Parameters:
            Query9Color: "^.*pink.*$"
- ActorFromTemplate:
    TemplateName: ValidateTPCHQueryActorTemplate
    TemplateParameters:
      Query: 10
      Actual:
        LoadConfig:
          Path: ../../bic/normalized/phase/q10_normalized.yml
          Key: q10_normalized_aggregation
      Expected:
        LoadConfig:
          Path: ../../../../genny/src/phases/tpch/normalized/Q10.yml
          Key: TPCHNormalizedQuery10Aggregation
          Parameters:
            Query10Date: "1993-10-01"
- ActorFromTemplate:
    TemplateName: ValidateTPCHQueryActorTemplate
    TemplateParameters:
      Query: 12
      Actual:
        LoadConfig:
          Path: ../../bic/normalized/phase/q12_normalized.yml
          Key: q12_normalized_aggregation
      Expected:
        LoadConfig:
          Path: ../../../../genny/src/phases/tpch/normalized/Q12.yml
          Key: TPCHNormalizedQuery12Aggregation
- ActorFromTemplate:
    TemplateName: ValidateTPCHQueryActorTemplate
    TemplateParameters:
      Query: 13
      Actual:
        LoadConfig:
          Path: ../../bic/normalized/phase/q13_normalized.yml
          Key: q13_normalized_aggregation
      Expected:
        LoadConfig:
          Path: ../../../../genny/src/phases/tpch/normalized/Q13.yml
          Key: TPCHNormalizedQuery13Aggregation
- ActorFromTemplate:
    TemplateName: ValidateTPCHQueryActorTemplate
    TemplateParameters:
      Query: 14
      Actual:
        LoadConfig:
          Path: ../../bic/normalized/phase/q14_normalized.yml
          Key: q14_normalized_aggregation
      Expected:
        LoadConfig:
          Path: ../../../../genny/src/phases/tpch/normalized/Q14.yml
          Key: TPCHNormalizedQuery14Aggregation

# skip-reason: returns 32 rows compared to server, atlas sql's 34 rows
# - ActorFromTemplate:
#     TemplateName: ValidateTPCHQueryActorTemplate
#     TemplateParameters:
#       Query: 16
#       Actual:
#         LoadConfig:
#           Path: ../../bic/normalized/phase/q16_normalized.yml
#           Key: q16_normalized_aggregation
#       Expected:
#         LoadConfig:
#           Path: ../../../../genny/src/phases/tpch/normalized/Q16.yml
#           Key: TPCHNormalizedQuery16Aggregation

- ActorFromTemplate:
    TemplateName: ValidateTPCHQueryActorTemplate
    TemplateParameters:
      Query: 18
      Actual:
        LoadConfig:
          Path: ../../bic/normalized/phase/q18_normalized.yml
          Key: q18_normalized_aggregation
      Expected:
        LoadConfig:
          Path: ../../../../genny/src/phases/tpch/normalized/Q18.yml
          Key: TPCHNormalizedQuery18Aggregation
          Parameters:
            Query18Quantity: 260
- ActorFromTemplate:
    TemplateName: ValidateTPCHQueryActorTemplate
    TemplateParameters:
      Query: 19
      Actual:
        LoadConfig:
          Path: ../../bic/normalized/phase/q19_normalized.yml
          Key: q19_normalized_aggregation
      Expected:
        LoadConfig:
          Path: ../../../../genny/src/phases/tpch/normalized/Q19.yml
          Key: TPCHNormalizedQuery19Aggregation
          Parameters:
            Query19Brand2: "Brand#24"
            Query19Quantity2: 30
