SchemaVersion: 2018-07-01
Owner: "@10gen/sql-engines-team"
Description: |
  This workload uses the RunCommand actor to issue an aggregation pipeline,
  generated by translating TPC-H query 1 via MongoDB BIC
q1_normalized:
  Repeat: 1
  Database: tpch
  Operations:
    - OperationMetricsName: BIC
      OperationName: RunCommand
      OperationCommand:
        aggregate: lineitem
        pipeline:
          [
            {
              "$match":
                { "l_shipdate": { "$lte": ISODate("1998-09-01T00:00:00") } },
            },
            {
              "$group":
                {
                  "_id":
                    {
                      "group_key_0":
                        { "$ifNull": ["$l_returnflag", { "$literal": null }] },
                      "group_key_1":
                        { "$ifNull": ["$l_linestatus", { "$literal": null }] },
                    },
                  "sum(tpch_DOT_lineitem_DOT_l_quantity)":
                    { "$sum": "$l_quantity" },
                  "sum(tpch_DOT_lineitem_DOT_l_quantity)_count":
                    {
                      "$sum":
                        {
                          "$cond":
                            {
                              "if": { "$lte": ["$l_quantity", null] },
                              "then": 0,
                              "else": 1,
                            },
                        },
                    },
                  "sum(tpch_DOT_lineitem_DOT_l_extendedprice)":
                    { "$sum": "$l_extendedprice" },
                  "sum(tpch_DOT_lineitem_DOT_l_extendedprice)_count":
                    {
                      "$sum":
                        {
                          "$cond":
                            {
                              "if": { "$lte": ["$l_extendedprice", null] },
                              "then": 0,
                              "else": 1,
                            },
                        },
                    },
                  "sum(tpch_DOT_lineitem_DOT_l_extendedprice*1-tpch_DOT_lineitem_DOT_l_discount)":
                    {
                      "$sum":
                        {
                          "$multiply":
                            [
                              "$l_extendedprice",
                              { "$subtract": [1, "$l_discount"] },
                            ],
                        },
                    },
                  "sum(tpch_DOT_lineitem_DOT_l_extendedprice*1-tpch_DOT_lineitem_DOT_l_discount)_count":
                    {
                      "$sum":
                        {
                          "$cond":
                            {
                              "if":
                                {
                                  "$lte":
                                    [
                                      {
                                        "$multiply":
                                          [
                                            "$l_extendedprice",
                                            {
                                              "$subtract":
                                                [
                                                  1,
                                                  "$l_discount",
                                                ],
                                            },
                                          ],
                                      },
                                      null,
                                    ],
                                },
                              "then": 0,
                              "else": 1,
                            },
                        },
                    },
                  "sum(tpch_DOT_lineitem_DOT_l_extendedprice*1-tpch_DOT_lineitem_DOT_l_discount*1+tpch_DOT_lineitem_DOT_l_tax)":
                    {
                      "$sum":
                        {
                          "$multiply":
                            [
                              "$l_extendedprice",
                              { "$subtract": [1, "$l_discount"] },
                              { "$add": [1, "$l_tax"] },
                            ],
                        },
                    },
                  "sum(tpch_DOT_lineitem_DOT_l_extendedprice*1-tpch_DOT_lineitem_DOT_l_discount*1+tpch_DOT_lineitem_DOT_l_tax)_count":
                    {
                      "$sum":
                        {
                          "$cond":
                            {
                              "if":
                                {
                                  "$lte":
                                    [
                                      {
                                        "$multiply":
                                          [
                                            "$l_extendedprice",
                                            {
                                              "$subtract":
                                                [
                                                  1,
                                                  "$l_discount",
                                                ],
                                            },
                                            {
                                              "$add":
                                                [1, "$l_tax"],
                                            },
                                          ],
                                      },
                                      null,
                                    ],
                                },
                              "then": 0,
                              "else": 1,
                            },
                        },
                    },
                  "avg(tpch_DOT_lineitem_DOT_l_quantity)":
                    { "$avg": "$l_quantity" },
                  "avg(tpch_DOT_lineitem_DOT_l_extendedprice)":
                    { "$avg": "$l_extendedprice" },
                  "avg(tpch_DOT_lineitem_DOT_l_discount)":
                    { "$avg": "$l_discount" },
                  "count(*)": { "$sum": 1 },
                },
            },
            {
              "$project":
                {
                  "_id": 0,
                  "tpch_DOT_lineitem_DOT_l_returnflag": "$_id.group_key_0",
                  "tpch_DOT_lineitem_DOT_l_linestatus": "$_id.group_key_1",
                  "sum(tpch_DOT_lineitem_DOT_l_quantity)":
                    {
                      "$cond":
                        {
                          "if": "$sum(tpch_DOT_lineitem_DOT_l_quantity)_count",
                          "then": "$sum(tpch_DOT_lineitem_DOT_l_quantity)",
                          "else": { "$literal": null },
                        },
                    },
                  "sum(tpch_DOT_lineitem_DOT_l_extendedprice)":
                    {
                      "$cond":
                        {
                          "if": "$sum(tpch_DOT_lineitem_DOT_l_extendedprice)_count",
                          "then": "$sum(tpch_DOT_lineitem_DOT_l_extendedprice)",
                          "else": { "$literal": null },
                        },
                    },
                  "sum(tpch_DOT_lineitem_DOT_l_extendedprice*1-tpch_DOT_lineitem_DOT_l_discount)":
                    {
                      "$cond":
                        {
                          "if": "$sum(tpch_DOT_lineitem_DOT_l_extendedprice*1-tpch_DOT_lineitem_DOT_l_discount)_count",
                          "then": "$sum(tpch_DOT_lineitem_DOT_l_extendedprice*1-tpch_DOT_lineitem_DOT_l_discount)",
                          "else": { "$literal": null },
                        },
                    },
                  "sum(tpch_DOT_lineitem_DOT_l_extendedprice*1-tpch_DOT_lineitem_DOT_l_discount*1+tpch_DOT_lineitem_DOT_l_tax)":
                    {
                      "$cond":
                        {
                          "if": "$sum(tpch_DOT_lineitem_DOT_l_extendedprice*1-tpch_DOT_lineitem_DOT_l_discount*1+tpch_DOT_lineitem_DOT_l_tax)_count",
                          "then": "$sum(tpch_DOT_lineitem_DOT_l_extendedprice*1-tpch_DOT_lineitem_DOT_l_discount*1+tpch_DOT_lineitem_DOT_l_tax)",
                          "else": { "$literal": null },
                        },
                    },
                  "avg(tpch_DOT_lineitem_DOT_l_quantity)": "$avg(tpch_DOT_lineitem_DOT_l_quantity)",
                  "avg(tpch_DOT_lineitem_DOT_l_extendedprice)": "$avg(tpch_DOT_lineitem_DOT_l_extendedprice)",
                  "avg(tpch_DOT_lineitem_DOT_l_discount)": "$avg(tpch_DOT_lineitem_DOT_l_discount)",
                  "count(*)": "$count(*)",
                },
            },
            {
              "$sort":
                {
                  "tpch_DOT_lineitem_DOT_l_returnflag": 1,
                  "tpch_DOT_lineitem_DOT_l_linestatus": 1,
                },
            },
            {
              "$project":
                {
                  "tpch_DOT_lineitem_DOT_l_returnflag": "$tpch_DOT_lineitem_DOT_l_returnflag",
                  "tpch_DOT_lineitem_DOT_l_linestatus": "$tpch_DOT_lineitem_DOT_l_linestatus",
                  "tpch_DOT_sum(tpch_DOT_lineitem_DOT_l_quantity)": "$sum(tpch_DOT_lineitem_DOT_l_quantity)",
                  "tpch_DOT_sum(tpch_DOT_lineitem_DOT_l_extendedprice)": "$sum(tpch_DOT_lineitem_DOT_l_extendedprice)",
                  "tpch_DOT_sum(tpch_DOT_lineitem_DOT_l_extendedprice*1-tpch_DOT_lineitem_DOT_l_discount)": "$sum(tpch_DOT_lineitem_DOT_l_extendedprice*1-tpch_DOT_lineitem_DOT_l_discount)",
                  "tpch_DOT_sum(tpch_DOT_lineitem_DOT_l_extendedprice*1-tpch_DOT_lineitem_DOT_l_discount*1+tpch_DOT_lineitem_DOT_l_tax)": "$sum(tpch_DOT_lineitem_DOT_l_extendedprice*1-tpch_DOT_lineitem_DOT_l_discount*1+tpch_DOT_lineitem_DOT_l_tax)",
                  "tpch_DOT_avg(tpch_DOT_lineitem_DOT_l_quantity)": "$avg(tpch_DOT_lineitem_DOT_l_quantity)",
                  "tpch_DOT_avg(tpch_DOT_lineitem_DOT_l_extendedprice)": "$avg(tpch_DOT_lineitem_DOT_l_extendedprice)",
                  "tpch_DOT_avg(tpch_DOT_lineitem_DOT_l_discount)": "$avg(tpch_DOT_lineitem_DOT_l_discount)",
                  "count(*)": "$count(*)",
                  "_id": 0,
                },
            },
          ]
        cursor: {}
