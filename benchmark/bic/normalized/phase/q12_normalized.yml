SchemaVersion: 2018-07-01
Owner: "@10gen/sql-engines-team"
Description: |
  This workload uses the RunCommand actor to issue an aggregation pipeline,
  generated by translating TPC-H query 12 via MongoDB BIC

q12_normalized_aggregation: &q12_normalized_aggregation
  aggregate: orders
  pipeline:
    [
      { "$match": { "o_orderkey": { "$ne": null } } },
      {
        "$lookup":
          {
            "from": "lineitem",
            "localField": "o_orderkey",
            "foreignField": "l_orderkey",
            "as": "__joined_lineitem",
          },
      },
      { "$unwind": "$__joined_lineitem" },
      {
        "$match":
          {
            "$and":
              [
                {
                  "$expr":
                    {
                      "$let":
                        {
                          "vars":
                            {
                              "expr0":
                                {
                                  "$cond":
                                    {
                                      "if":
                                        {
                                          "$or":
                                            [
                                              {
                                                "$lte":
                                                  [
                                                    "$__joined_lineitem.l_commitdate",
                                                    null,
                                                  ],
                                              },
                                              {
                                                "$lte":
                                                  [
                                                    "$__joined_lineitem.l_receiptdate",
                                                    null,
                                                  ],
                                              },
                                            ],
                                        },
                                      "then": null,
                                      "else":
                                        {
                                          "$lt":
                                            [
                                              "$__joined_lineitem.l_commitdate",
                                              "$__joined_lineitem.l_receiptdate",
                                            ],
                                        },
                                    },
                                },
                              "expr1":
                                {
                                  "$cond":
                                    {
                                      "if":
                                        {
                                          "$or":
                                            [
                                              {
                                                "$lte":
                                                  [
                                                    "$__joined_lineitem.l_shipdate",
                                                    null,
                                                  ],
                                              },
                                              {
                                                "$lte":
                                                  [
                                                    "$__joined_lineitem.l_commitdate",
                                                    null,
                                                  ],
                                              },
                                            ],
                                        },
                                      "then": null,
                                      "else":
                                        {
                                          "$lt":
                                            [
                                              "$__joined_lineitem.l_shipdate",
                                              "$__joined_lineitem.l_commitdate",
                                            ],
                                        },
                                    },
                                },
                            },
                          "in":
                            {
                              "$cond":
                                {
                                  "if":
                                    {
                                      "$or":
                                        [
                                          { "$eq": ["$$expr0", 0] },
                                          { "$eq": ["$$expr0", false] },
                                          { "$eq": ["$$expr1", 0] },
                                          { "$eq": ["$$expr1", false] },
                                        ],
                                    },
                                  "then": false,
                                  "else":
                                    {
                                      "$cond":
                                        {
                                          "if":
                                            {
                                              "$or":
                                                [
                                                  { "$lte": ["$$expr0", null] },
                                                  { "$lte": ["$$expr1", null] },
                                                ],
                                            },
                                          "then": null,
                                          "else": true,
                                        },
                                    },
                                },
                            },
                        },
                    },
                },
                {
                  "__joined_lineitem.l_receiptdate":
                    { "$lt": {^Date: "1995-01-01T00:00:00"} },
                },
                {
                  "__joined_lineitem.l_receiptdate":
                    { "$gte": {^Date: "1994-01-01T00:00:00"} },
                },
                {
                  "$or":
                    [
                      { "__joined_lineitem.l_shipmode": { "$eq": "MAIL" } },
                      { "__joined_lineitem.l_shipmode": { "$eq": "SHIP" } },
                    ],
                },
              ],
          },
      },
      {
        "$group":
          {
            "_id": "$__joined_lineitem.l_shipmode",
            "sum(case when (tpch_DOT_orders_DOT_o_orderpriority = 1-URGENT or tpch_DOT_orders_DOT_o_orderpriority = 2-HIGH) then 1 else 0 end)":
              {
                "$sum":
                  {
                    "$cond":
                      {
                        "if":
                          {
                            "$reduce":
                              {
                                "input":
                                  [
                                    {
                                      "$cond":
                                        {
                                          "if":
                                            {
                                              "$or":
                                                [
                                                  {
                                                    "$lte":
                                                      ["$o_orderpriority", null],
                                                  },
                                                  { "$lte": ["1-URGENT", null] },
                                                ],
                                            },
                                          "then": null,
                                          "else":
                                            {
                                              "$eq":
                                                ["$o_orderpriority", "1-URGENT"],
                                            },
                                        },
                                    },
                                    {
                                      "$cond":
                                        {
                                          "if":
                                            {
                                              "$or":
                                                [
                                                  {
                                                    "$lte":
                                                      ["$o_orderpriority", null],
                                                  },
                                                  { "$lte": ["2-HIGH", null] },
                                                ],
                                            },
                                          "then": null,
                                          "else":
                                            {
                                              "$eq": ["$o_orderpriority", "2-HIGH"],
                                            },
                                        },
                                    },
                                  ],
                                "initialValue": false,
                                "in":
                                  {
                                    "$switch":
                                      {
                                        "branches":
                                          [
                                            {
                                              "case":
                                                { "$or": ["$$this", "$$value"] },
                                              "then": true,
                                            },
                                            {
                                              "case": { "$eq": ["$$this", null] },
                                              "then": null,
                                            },
                                            {
                                              "case": { "$eq": ["$$value", null] },
                                              "then": null,
                                            },
                                          ],
                                        "default": false,
                                      },
                                  },
                              },
                          },
                        "then": 1,
                        "else": 0,
                      },
                  },
              },
            "sum(case when (tpch_DOT_orders_DOT_o_orderpriority = 1-URGENT or tpch_DOT_orders_DOT_o_orderpriority = 2-HIGH) then 1 else 0 end)_count":
              {
                "$sum":
                  {
                    "$cond":
                      {
                        "if":
                          {
                            "$lte":
                              [
                                {
                                  "$cond":
                                    {
                                      "if":
                                        {
                                          "$reduce":
                                            {
                                              "input":
                                                [
                                                  {
                                                    "$cond":
                                                      {
                                                        "if":
                                                          {
                                                            "$or":
                                                              [
                                                                {
                                                                  "$lte":
                                                                    [
                                                                      "$o_orderpriority",
                                                                      null,
                                                                    ],
                                                                },
                                                                {
                                                                  "$lte":
                                                                    [
                                                                      "1-URGENT",
                                                                      null,
                                                                    ],
                                                                },
                                                              ],
                                                          },
                                                        "then": null,
                                                        "else":
                                                          {
                                                            "$eq":
                                                              [
                                                                "$o_orderpriority",
                                                                "1-URGENT",
                                                              ],
                                                          },
                                                      },
                                                  },
                                                  {
                                                    "$cond":
                                                      {
                                                        "if":
                                                          {
                                                            "$or":
                                                              [
                                                                {
                                                                  "$lte":
                                                                    [
                                                                      "$o_orderpriority",
                                                                      null,
                                                                    ],
                                                                },
                                                                {
                                                                  "$lte":
                                                                    [
                                                                      "2-HIGH",
                                                                      null,
                                                                    ],
                                                                },
                                                              ],
                                                          },
                                                        "then": null,
                                                        "else":
                                                          {
                                                            "$eq":
                                                              [
                                                                "$o_orderpriority",
                                                                "2-HIGH",
                                                              ],
                                                          },
                                                      },
                                                  },
                                                ],
                                              "initialValue": false,
                                              "in":
                                                {
                                                  "$switch":
                                                    {
                                                      "branches":
                                                        [
                                                          {
                                                            "case":
                                                              {
                                                                "$or":
                                                                  [
                                                                    "$$this",
                                                                    "$$value",
                                                                  ],
                                                              },
                                                            "then": true,
                                                          },
                                                          {
                                                            "case":
                                                              {
                                                                "$eq":
                                                                  ["$$this", null],
                                                              },
                                                            "then": null,
                                                          },
                                                          {
                                                            "case":
                                                              {
                                                                "$eq":
                                                                  ["$$value", null],
                                                              },
                                                            "then": null,
                                                          },
                                                        ],
                                                      "default": false,
                                                    },
                                                },
                                            },
                                        },
                                      "then": 1,
                                      "else": 0,
                                    },
                                },
                                null,
                              ],
                          },
                        "then": 0,
                        "else": 1,
                      },
                  },
              },
            "sum(case when (tpch_DOT_orders_DOT_o_orderpriority != 1-URGENT and tpch_DOT_orders_DOT_o_orderpriority != 2-HIGH) then 1 else 0 end)":
              {
                "$sum":
                  {
                    "$cond":
                      {
                        "if":
                          {
                            "$let":
                              {
                                "vars":
                                  {
                                    "expr0":
                                      {
                                        "$cond":
                                          {
                                            "if":
                                              {
                                                "$or":
                                                  [
                                                    {
                                                      "$lte":
                                                        ["$o_orderpriority", null],
                                                    },
                                                    { "$lte": ["1-URGENT", null] },
                                                  ],
                                              },
                                            "then": null,
                                            "else":
                                              {
                                                "$ne":
                                                  ["$o_orderpriority", "1-URGENT"],
                                              },
                                          },
                                      },
                                    "expr1":
                                      {
                                        "$cond":
                                          {
                                            "if":
                                              {
                                                "$or":
                                                  [
                                                    {
                                                      "$lte":
                                                        ["$o_orderpriority", null],
                                                    },
                                                    { "$lte": ["2-HIGH", null] },
                                                  ],
                                              },
                                            "then": null,
                                            "else":
                                              {
                                                "$ne":
                                                  ["$o_orderpriority", "2-HIGH"],
                                              },
                                          },
                                      },
                                  },
                                "in":
                                  {
                                    "$cond":
                                      {
                                        "if":
                                          {
                                            "$or":
                                              [
                                                {
                                                  "$eq":
                                                    ["$$expr0", 0],
                                                },
                                                { "$eq": ["$$expr0", false] },
                                                {
                                                  "$eq":
                                                    ["$$expr1", 0],
                                                },
                                                { "$eq": ["$$expr1", false] },
                                              ],
                                          },
                                        "then": false,
                                        "else":
                                          {
                                            "$cond":
                                              {
                                                "if":
                                                  {
                                                    "$or":
                                                      [
                                                        {
                                                          "$lte": ["$$expr0", null],
                                                        },
                                                        {
                                                          "$lte": ["$$expr1", null],
                                                        },
                                                      ],
                                                  },
                                                "then": null,
                                                "else": true,
                                              },
                                          },
                                      },
                                  },
                              },
                          },
                        "then": 1,
                        "else": 0,
                      },
                  },
              },
            "sum(case when (tpch_DOT_orders_DOT_o_orderpriority != 1-URGENT and tpch_DOT_orders_DOT_o_orderpriority != 2-HIGH) then 1 else 0 end)_count":
              {
                "$sum":
                  {
                    "$cond":
                      {
                        "if":
                          {
                            "$lte":
                              [
                                {
                                  "$cond":
                                    {
                                      "if":
                                        {
                                          "$let":
                                            {
                                              "vars":
                                                {
                                                  "expr0":
                                                    {
                                                      "$cond":
                                                        {
                                                          "if":
                                                            {
                                                              "$or":
                                                                [
                                                                  {
                                                                    "$lte":
                                                                      [
                                                                        "$o_orderpriority",
                                                                        null,
                                                                      ],
                                                                  },
                                                                  {
                                                                    "$lte":
                                                                      [
                                                                        "1-URGENT",
                                                                        null,
                                                                      ],
                                                                  },
                                                                ],
                                                            },
                                                          "then": null,
                                                          "else":
                                                            {
                                                              "$ne":
                                                                [
                                                                  "$o_orderpriority",
                                                                  "1-URGENT",
                                                                ],
                                                            },
                                                        },
                                                    },
                                                  "expr1":
                                                    {
                                                      "$cond":
                                                        {
                                                          "if":
                                                            {
                                                              "$or":
                                                                [
                                                                  {
                                                                    "$lte":
                                                                      [
                                                                        "$o_orderpriority",
                                                                        null,
                                                                      ],
                                                                  },
                                                                  {
                                                                    "$lte":
                                                                      [
                                                                        "2-HIGH",
                                                                        null,
                                                                      ],
                                                                  },
                                                                ],
                                                            },
                                                          "then": null,
                                                          "else":
                                                            {
                                                              "$ne":
                                                                [
                                                                  "$o_orderpriority",
                                                                  "2-HIGH",
                                                                ],
                                                            },
                                                        },
                                                    },
                                                },
                                              "in":
                                                {
                                                  "$cond":
                                                    {
                                                      "if":
                                                        {
                                                          "$or":
                                                            [
                                                              {
                                                                "$eq":
                                                                  [
                                                                    "$$expr0",
                                                                    0,
                                                                  ],
                                                              },
                                                              {
                                                                "$eq":
                                                                  [
                                                                    "$$expr0",
                                                                    false,
                                                                  ],
                                                              },
                                                              {
                                                                "$eq":
                                                                  [
                                                                    "$$expr1",
                                                                    0,
                                                                  ],
                                                              },
                                                              {
                                                                "$eq":
                                                                  [
                                                                    "$$expr1",
                                                                    false,
                                                                  ],
                                                              },
                                                            ],
                                                        },
                                                      "then": false,
                                                      "else":
                                                        {
                                                          "$cond":
                                                            {
                                                              "if":
                                                                {
                                                                  "$or":
                                                                    [
                                                                      {
                                                                        "$lte":
                                                                          [
                                                                            "$$expr0",
                                                                            null,
                                                                          ],
                                                                      },
                                                                      {
                                                                        "$lte":
                                                                          [
                                                                            "$$expr1",
                                                                            null,
                                                                          ],
                                                                      },
                                                                    ],
                                                                },
                                                              "then": null,
                                                              "else": true,
                                                            },
                                                        },
                                                    },
                                                },
                                            },
                                        },
                                      "then": 1,
                                      "else": 0,
                                    },
                                },
                                null,
                              ],
                          },
                        "then": 0,
                        "else": 1,
                      },
                  },
              },
          },
      },
      { "$addFields": { "_id": { "group_key_0": "$_id" } } },
      {
        "$project":
          {
            "_id": 0,
            "tpch_DOT_lineitem_DOT_l_shipmode": "$_id.group_key_0",
            "sum(case when (tpch_DOT_orders_DOT_o_orderpriority = 1-URGENT or tpch_DOT_orders_DOT_o_orderpriority = 2-HIGH) then 1 else 0 end)":
              {
                "$cond":
                  {
                    "if": "$sum(case when (tpch_DOT_orders_DOT_o_orderpriority = 1-URGENT or tpch_DOT_orders_DOT_o_orderpriority = 2-HIGH) then 1 else 0 end)_count",
                    "then": "$sum(case when (tpch_DOT_orders_DOT_o_orderpriority = 1-URGENT or tpch_DOT_orders_DOT_o_orderpriority = 2-HIGH) then 1 else 0 end)",
                    "else": { "$literal": null },
                  },
              },
            "sum(case when (tpch_DOT_orders_DOT_o_orderpriority != 1-URGENT and tpch_DOT_orders_DOT_o_orderpriority != 2-HIGH) then 1 else 0 end)":
              {
                "$cond":
                  {
                    "if": "$sum(case when (tpch_DOT_orders_DOT_o_orderpriority != 1-URGENT and tpch_DOT_orders_DOT_o_orderpriority != 2-HIGH) then 1 else 0 end)_count",
                    "then": "$sum(case when (tpch_DOT_orders_DOT_o_orderpriority != 1-URGENT and tpch_DOT_orders_DOT_o_orderpriority != 2-HIGH) then 1 else 0 end)",
                    "else": { "$literal": null },
                  },
              },
          },
      },
      { "$sort": { "tpch_DOT_lineitem_DOT_l_shipmode": 1 } },
      {
        "$project":
          {
            "l_shipmode": "$tpch_DOT_lineitem_DOT_l_shipmode",
            "high_line_count": "$sum(case when (tpch_DOT_orders_DOT_o_orderpriority = 1-URGENT or tpch_DOT_orders_DOT_o_orderpriority = 2-HIGH) then 1 else 0 end)",
            "low_line_count": "$sum(case when (tpch_DOT_orders_DOT_o_orderpriority != 1-URGENT and tpch_DOT_orders_DOT_o_orderpriority != 2-HIGH) then 1 else 0 end)",
            "_id": 0,
          },
      },
    ]
  cursor: {}

q12_normalized:
  Repeat: 1
  Database: tpch
  Operations:
    - OperationMetricsName: BIC
      OperationName: RunCommand
      OperationCommand: *q12_normalized_aggregation
