SchemaVersion: 2018-07-01
Owner: "@10gen/sql-engines-team"
Description: |
  This workload uses the RunCommand actor to issue an aggregation pipeline,
  generated by translating TPC-H query 2 via MongoDB BIC
q2_normalized:
  Repeat: 1
  Database: tpch
  Operations:
    - OperationMetricsName: BIC
      OperationName: RunCommand
      OperationCommand:
        aggregate: part
        pipeline:
          [
            {
              "$match":
                {
                  "$and":
                    [
                      { "p_partkey": { "$ne": null } },
                      { "p_type": { "$regex": "^.*STEEL$", "$options": "si" } },
                      { "p_size": { "$eq": 20 } },
                    ],
                },
            },
            {
              "$lookup":
                {
                  "from": "partsupp",
                  "localField": "p_partkey",
                  "foreignField": "ps_partkey",
                  "as": "__joined_partsupp",
                },
            },
            { "$unwind": "$__joined_partsupp" },
            { "$match": { "__joined_partsupp.ps_suppkey": { "$ne": null } } },
            {
              "$lookup":
                {
                  "from": "supplier",
                  "localField": "__joined_partsupp.ps_suppkey",
                  "foreignField": "s_suppkey",
                  "as": "__joined_supplier",
                },
            },
            { "$unwind": "$__joined_supplier" },
            { "$match": { "__joined_supplier.s_nationkey": { "$ne": null } } },
            {
              "$lookup":
                {
                  "from": "nation",
                  "localField": "__joined_supplier.s_nationkey",
                  "foreignField": "n_nationkey",
                  "as": "__joined_nation",
                },
            },
            { "$unwind": "$__joined_nation" },
            { "$match": { "__joined_nation.n_regionkey": { "$ne": null } } },
            {
              "$lookup":
                {
                  "from": "region",
                  "localField": "__joined_nation.n_regionkey",
                  "foreignField": "r_regionkey",
                  "as": "__joined_region",
                },
            },
            { "$unwind": "$__joined_region" },
            { "$match": { "__joined_region.r_name": { "$eq": "AMERICA" } } },

            {
              "$lookup":
                {
                  "from": "partsupp",
                  "let":
                    {
                      "bic_correlated_var_0": "$__joined_partsupp.ps_supplycost",
                      "bic_correlated_var_1": "$p_partkey",
                    },
                  "pipeline":
                    [
                      {
                        "$lookup":
                          {
                            "from": "supplier",
                            "let": {},
                            "pipeline": [],
                            "as": "__joined_supplier",
                          },
                      },
                      { "$unwind": "$__joined_supplier" },
                      {
                        "$lookup":
                          {
                            "from": "nation",
                            "let": {},
                            "pipeline": [],
                            "as": "__joined_nation",
                          },
                      },
                      { "$unwind": "$__joined_nation" },
                      {
                        "$lookup":
                          {
                            "from": "region",
                            "let": {},
                            "pipeline": [],
                            "as": "__joined_region",
                          },
                      },
                      { "$unwind": "$__joined_region" },
                      {
                        "$match":
                          {
                            "$and":
                              [
                                {
                                  "$expr":
                                    {
                                      "$let":
                                        {
                                          "vars":
                                            {
                                              "expr0":
                                                {
                                                  "$cond":
                                                    {
                                                      "if":
                                                        {
                                                          "$or":
                                                            [
                                                              {
                                                                "$lte":
                                                                  [
                                                                    "$$bic_correlated_var_1",
                                                                    null,
                                                                  ],
                                                              },
                                                              {
                                                                "$lte":
                                                                  ["$ps_partkey", null],
                                                              },
                                                            ],
                                                        },
                                                      "then": null,
                                                      "else":
                                                        {
                                                          "$eq":
                                                            [
                                                              "$$bic_correlated_var_1",
                                                              "$ps_partkey",
                                                            ],
                                                        },
                                                    },
                                                },
                                              "expr1":
                                                {
                                                  "$cond":
                                                    {
                                                      "if":
                                                        {
                                                          "$or":
                                                            [
                                                              {
                                                                "$lte":
                                                                  [
                                                                    "$__joined_supplier.s_suppkey",
                                                                    null,
                                                                  ],
                                                              },
                                                              {
                                                                "$lte":
                                                                  ["$ps_suppkey", null],
                                                              },
                                                            ],
                                                        },
                                                      "then": null,
                                                      "else":
                                                        {
                                                          "$eq":
                                                            [
                                                              "$__joined_supplier.s_suppkey",
                                                              "$ps_suppkey",
                                                            ],
                                                        },
                                                    },
                                                },
                                              "expr2":
                                                {
                                                  "$cond":
                                                    {
                                                      "if":
                                                        {
                                                          "$or":
                                                            [
                                                              {
                                                                "$lte":
                                                                  [
                                                                    "$__joined_supplier.s_nationkey",
                                                                    null,
                                                                  ],
                                                              },
                                                              {
                                                                "$lte":
                                                                  [
                                                                    "$__joined_nation.n_nationkey",
                                                                    null,
                                                                  ],
                                                              },
                                                            ],
                                                        },
                                                      "then": null,
                                                      "else":
                                                        {
                                                          "$eq":
                                                            [
                                                              "$__joined_supplier.s_nationkey",
                                                              "$__joined_nation.n_nationkey",
                                                            ],
                                                        },
                                                    },
                                                },
                                              "expr3":
                                                {
                                                  "$cond":
                                                    {
                                                      "if":
                                                        {
                                                          "$or":
                                                            [
                                                              {
                                                                "$lte":
                                                                  [
                                                                    "$__joined_nation.n_regionkey",
                                                                    null,
                                                                  ],
                                                              },
                                                              {
                                                                "$lte":
                                                                  [
                                                                    "$__joined_region.r_regionkey",
                                                                    null,
                                                                  ],
                                                              },
                                                            ],
                                                        },
                                                      "then": null,
                                                      "else":
                                                        {
                                                          "$eq":
                                                            [
                                                              "$__joined_nation.n_regionkey",
                                                              "$__joined_region.r_regionkey",
                                                            ],
                                                        },
                                                    },
                                                },
                                            },
                                          "in":
                                            {
                                              "$cond":
                                                {
                                                  "if":
                                                    {
                                                      "$or":
                                                        [
                                                          {
                                                            "$eq":
                                                              ["$$expr0", 0],
                                                          },
                                                          { "$eq": ["$$expr0", false] },
                                                          {
                                                            "$eq":
                                                              ["$$expr1", 0],
                                                          },
                                                          { "$eq": ["$$expr1", false] },
                                                          {
                                                            "$eq":
                                                              ["$$expr2", 0],
                                                          },
                                                          { "$eq": ["$$expr2", false] },
                                                          {
                                                            "$eq":
                                                              ["$$expr3", 0],
                                                          },
                                                          { "$eq": ["$$expr3", false] },
                                                        ],
                                                    },
                                                  "then": false,
                                                  "else":
                                                    {
                                                      "$cond":
                                                        {
                                                          "if":
                                                            {
                                                              "$or":
                                                                [
                                                                  {
                                                                    "$lte":
                                                                      ["$$expr0", null],
                                                                  },
                                                                  {
                                                                    "$lte":
                                                                      ["$$expr1", null],
                                                                  },
                                                                  {
                                                                    "$lte":
                                                                      ["$$expr2", null],
                                                                  },
                                                                  {
                                                                    "$lte":
                                                                      ["$$expr3", null],
                                                                  },
                                                                ],
                                                            },
                                                          "then": null,
                                                          "else": true,
                                                        },
                                                    },
                                                },
                                            },
                                        },
                                    },
                                },
                                { "__joined_region.r_name": { "$eq": "AMERICA" } },
                              ],
                          },
                      },
                      {
                        "$project":
                          {
                            "tpch_DOT_partsupp_DOT_ps_supplycost": "$ps_supplycost",
                            "tpch_DOT_partsupp_DOT_ps_partkey": "$ps_partkey",
                            "tpch_DOT_supplier_DOT_s_suppkey": "$__joined_supplier.s_suppkey",
                            "tpch_DOT_partsupp_DOT_ps_suppkey": "$ps_suppkey",
                            "tpch_DOT_supplier_DOT_s_nationkey": "$__joined_supplier.s_nationkey",
                            "tpch_DOT_nation_DOT_n_nationkey": "$__joined_nation.n_nationkey",
                            "tpch_DOT_nation_DOT_n_regionkey": "$__joined_nation.n_regionkey",
                            "tpch_DOT_region_DOT_r_regionkey": "$__joined_region.r_regionkey",
                          },
                      },
                      {
                        "$group":
                          {
                            "_id": {},
                            "min(tpch_DOT_partsupp_DOT_ps_supplycost)":
                              { "$min": "$tpch_DOT_partsupp_DOT_ps_supplycost" },
                          },
                      },
                      {
                        "$project":
                          {
                            "tpch_DOT_min(tpch_DOT_partsupp_DOT_ps_supplycost)": "$min(tpch_DOT_partsupp_DOT_ps_supplycost)",
                          },
                      },
                    ],
                  "as": "__subquery_partsupp_[3 3 3 3]",
                },
            },

            {
              "$lookup":
                {
                  "from": "lineitem",
                  "let":
                    {
                      "bic_correlated_var_0": "$__joined_partsupp.ps_supplycost",
                      "bic_correlated_var_1": "$p_partkey",
                    },
                  "pipeline":
                    [
                      { "$collStats": {} },
                      { "$limit": 1 },
                      {
                        "$project":
                          {
                            "tpch_DOT_partsupp_DOT_ps_supplycost": "$$bic_correlated_var_0",
                          },
                      },
                    ],
                  "as": "__subquery_lineitem_[2]",
                },
            },
            {
              "$match":
                {
                  "$and":
                    [
                      {
                        "$expr":
                          {
                            "$and":
                              [
                                {
                                  "$eq":
                                    [
                                      {
                                        "$map":
                                          {
                                            "input": "$__subquery_lineitem_[2]",
                                            "as": "this",
                                            "in":
                                              {
                                                "$ifNull":
                                                  [
                                                    "$$this.tpch_DOT_partsupp_DOT_ps_supplycost",
                                                    null,
                                                  ],
                                              },
                                          },
                                      },
                                      {
                                        "$map":
                                          {
                                            "input": "$__subquery_partsupp_[3 3 3 3]",
                                            "as": "this",
                                            "in":
                                              {
                                                "$ifNull":
                                                  [
                                                    "$$this.tpch_DOT_min(tpch_DOT_partsupp_DOT_ps_supplycost)",
                                                    null,
                                                  ],
                                              },
                                          },
                                      },
                                    ],
                                },
                                {
                                  "$eq":
                                    [
                                      {
                                        "$size":
                                          {
                                            "$map":
                                              {
                                                "input": "$__subquery_lineitem_[2]",
                                                "as": "this",
                                                "in":
                                                  {
                                                    "$ifNull":
                                                      [
                                                        "$$this.tpch_DOT_partsupp_DOT_ps_supplycost",
                                                        null,
                                                      ],
                                                  },
                                              },
                                          },
                                      },
                                      {
                                        "$size":
                                          {
                                            "$map":
                                              {
                                                "input": "$__subquery_partsupp_[3 3 3 3]",
                                                "as": "this",
                                                "in":
                                                  {
                                                    "$ifNull":
                                                      [
                                                        "$$this.tpch_DOT_min(tpch_DOT_partsupp_DOT_ps_supplycost)",
                                                        null,
                                                      ],
                                                  },
                                              },
                                          },
                                      },
                                    ],
                                },
                              ],
                          },
                      },
                      { "__joined_region.r_name": { "$eq": "AMERICA" } },
                      { "p_type": { "$regex": "^.*STEEL$", "$options": "si" } },
                      { "p_size": { "$eq": 20} },
                    ],
                },
            },
            {
              "$sort":
                {
                  "__joined_supplier.s_acctbal": -1,
                  "__joined_nation.n_name": 1,
                  "__joined_supplier.s_name": 1,
                  "p_partkey": 1,
                },
            },
            { "$limit": 100 },
            {
              "$project":
                {
                  "tpch_DOT_part_DOT_p_type": "$p_type",
                  "tpch_DOT_region_DOT_r_name": "$__joined_region.r_name",
                  "tpch_DOT_supplier_DOT_s_acctbal": "$__joined_supplier.s_acctbal",
                  "tpch_DOT_supplier_DOT_s_name": "$__joined_supplier.s_name",
                  "tpch_DOT_nation_DOT_n_name": "$__joined_nation.n_name",
                  "tpch_DOT_part_DOT_p_partkey": "$p_partkey",
                  "tpch_DOT_part_DOT_p_mfgr": "$p_mfgr",
                  "tpch_DOT_supplier_DOT_s_address": "$__joined_supplier.s_address",
                  "tpch_DOT_supplier_DOT_s_phone": "$__joined_supplier.s_phone",
                  "tpch_DOT_supplier_DOT_s_comment": "$__joined_supplier.s_comment",
                  "_id": 0,
                },
            },
          ]
        cursor: {}
