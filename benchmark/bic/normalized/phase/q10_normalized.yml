SchemaVersion: 2018-07-01
Owner: "@10gen/sql-engines-team"
Description: |
  This workload uses the RunCommand actor to issue an aggregation pipeline,
  generated by translating TPC-H query 10 via MongoDB BIC

q10_normalized_aggregation: &q10_normalized_aggregation
  aggregate: lineitem
  pipeline:
    [
      {
        "$match":
          {
            "$and":
              [
                { "l_orderkey": { "$ne": null } },
                { "l_returnflag": { "$eq": "R" } },
              ],
          },
      },
      {
        "$lookup":
          {
            "from": "orders",
            "localField": "l_orderkey",
            "foreignField": "o_orderkey",
            "as": "__joined_orders",
          },
      },
      { "$unwind": "$__joined_orders" },
      {
        "$match":
          {
            "$and":
              [
                { "__joined_orders.o_custkey": { "$ne": null } },
                {
                  "__joined_orders.o_orderdate":
                    { "$lt": {^Date: "1994-01-01T00:00:00"} },
                },
                {
                  "__joined_orders.o_orderdate":
                    { "$gte": {^Date: "1993-10-01T00:00:00"} },
                },
              ],
          },
      },
      {
        "$lookup":
          {
            "from": "customer",
            "localField": "__joined_orders.o_custkey",
            "foreignField": "c_custkey",
            "as": "__joined_customer",
          },
      },
      { "$unwind": "$__joined_customer" },
      { "$match": { "__joined_customer.c_nationkey": { "$ne": null } } },
      {
        "$lookup":
          {
            "from": "nation",
            "localField": "__joined_customer.c_nationkey",
            "foreignField": "n_nationkey",
            "as": "__joined_nation",
          },
      },
      { "$unwind": "$__joined_nation" },
      {
        "$group":
          {
            "_id":
              {
                "group_key_0":
                  {
                    "$ifNull":
                      ["$__joined_customer.c_custkey", { "$literal": null }],
                  },
                "group_key_1":
                  {
                    "$ifNull": ["$__joined_customer.c_name", { "$literal": null }],
                  },
                "group_key_2":
                  {
                    "$ifNull":
                      ["$__joined_customer.c_acctbal", { "$literal": null }],
                  },
                "group_key_3":
                  {
                    "$ifNull": ["$__joined_customer.c_phone", { "$literal": null }],
                  },
                "group_key_4":
                  { "$ifNull": ["$__joined_nation.n_name", { "$literal": null }] },
                "group_key_5":
                  {
                    "$ifNull":
                      ["$__joined_customer.c_address", { "$literal": null }],
                  },
                "group_key_6":
                  {
                    "$ifNull":
                      ["$__joined_customer.c_comment", { "$literal": null }],
                  },
              },
            "sum(tpch_DOT_lineitem_DOT_l_extendedprice*1-tpch_DOT_lineitem_DOT_l_discount)":
              {
                "$sum":
                  {
                    "$multiply":
                      [
                        "$l_extendedprice",
                        { "$subtract": [1, "$l_discount"] },
                      ],
                  },
              },
            "sum(tpch_DOT_lineitem_DOT_l_extendedprice*1-tpch_DOT_lineitem_DOT_l_discount)_count":
              {
                "$sum":
                  {
                    "$cond":
                      {
                        "if":
                          {
                            "$lte":
                              [
                                {
                                  "$multiply":
                                    [
                                      "$l_extendedprice",
                                      {
                                        "$subtract":
                                          [1, "$l_discount"],
                                      },
                                    ],
                                },
                                null,
                              ],
                          },
                        "then": 0,
                        "else": 1,
                      },
                  },
              },
          },
      },
      {
        "$project":
          {
            "_id": 0,
            "tpch_DOT_customer_DOT_c_custkey": "$_id.group_key_0",
            "tpch_DOT_customer_DOT_c_name": "$_id.group_key_1",
            "tpch_DOT_customer_DOT_c_acctbal": "$_id.group_key_2",
            "tpch_DOT_nation_DOT_n_name": "$_id.group_key_4",
            "tpch_DOT_customer_DOT_c_address": "$_id.group_key_5",
            "tpch_DOT_customer_DOT_c_phone": "$_id.group_key_3",
            "tpch_DOT_customer_DOT_c_comment": "$_id.group_key_6",
            "sum(tpch_DOT_lineitem_DOT_l_extendedprice*1-tpch_DOT_lineitem_DOT_l_discount)":
              {
                "$cond":
                  {
                    "if": "$sum(tpch_DOT_lineitem_DOT_l_extendedprice*1-tpch_DOT_lineitem_DOT_l_discount)_count",
                    "then": "$sum(tpch_DOT_lineitem_DOT_l_extendedprice*1-tpch_DOT_lineitem_DOT_l_discount)",
                    "else": { "$literal": null },
                  },
              },
          },
      },
      {
        "$sort":
          {
            "sum(tpch_DOT_lineitem_DOT_l_extendedprice*1-tpch_DOT_lineitem_DOT_l_discount)": -1,
          },
      },
      { "$limit": 20 },
      {
        "$project":
          {
            "c_custkey": "$tpch_DOT_customer_DOT_c_custkey",
            "c_name": "$tpch_DOT_customer_DOT_c_name",
            "revenue": "$sum(tpch_DOT_lineitem_DOT_l_extendedprice*1-tpch_DOT_lineitem_DOT_l_discount)",
            "c_acctbal": "$tpch_DOT_customer_DOT_c_acctbal",
            "n_name": "$tpch_DOT_nation_DOT_n_name",
            "c_address": "$tpch_DOT_customer_DOT_c_address",
            "c_phone": "$tpch_DOT_customer_DOT_c_phone",
            "c_comment": "$tpch_DOT_customer_DOT_c_comment",
            "_id": 0,
          },
      },
    ]
  cursor: {}

q10_normalized:
  Repeat: 1
  Database: tpch
  Operations:
    - OperationMetricsName: BIC
      OperationName: RunCommand
      OperationCommand: *q10_normalized_aggregation
