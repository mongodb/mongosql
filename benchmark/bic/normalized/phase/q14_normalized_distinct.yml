SchemaVersion: 2018-07-01
Owner: "@10gen/sql-engines-team"
Description: |
  This workload uses the RunCommand actor to issue an aggregation pipeline,
  generated by translating TPC-H query 14 (distinct) via MongoDB BIC

q14_normalized_distinct_aggregation: &q14_normalized_distinct_aggregation
  aggregate: lineitem
  pipeline:
    [
      { "$match": { "$and": [ { "l_partkey": { "$ne": null } },{ "l_shipdate": { "$lt": ISODate("1995-10-01T00:00:00") } },{ "l_shipdate": { "$gte": ISODate("1995-09-01T00:00:00") } } ] } },
      { "$lookup": { "from": "part","localField": "l_partkey","foreignField": "p_partkey","as": "__joined_part" } },
      { "$unwind": "$__joined_part" },
      { "$group": { "_id": { },"sum(case when (tpch_DOT_part_DOT_p_type like PROMO%) then tpch_DOT_lineitem_DOT_l_extendedprice*1-tpch_DOT_lineitem_DOT_l_discount else 0 end)": { "$sum": { "$cond": { "if": { "$cond": { "if": { "$regexMatch": { "input": "$__joined_part.p_type","regex": "^PROMO.*$","options": "si" } },"then": NumberInt("1"),"else": NumberInt("0") } },"then": { "$multiply": [ "$l_extendedprice",{ "$subtract": [ NumberLong("1"),"$l_discount" ] } ] },"else": NumberLong("0") } } },"sum(case when (tpch_DOT_part_DOT_p_type like PROMO%) then tpch_DOT_lineitem_DOT_l_extendedprice*1-tpch_DOT_lineitem_DOT_l_discount else 0 end)_count": { "$sum": { "$cond": { "if": { "$lte": [ { "$cond": { "if": { "$cond": { "if": { "$regexMatch": { "input": "$__joined_part.p_type","regex": "^PROMO.*$","options": "si" } },"then": NumberInt("1"),"else": NumberInt("0") } },"then": { "$multiply": [ "$l_extendedprice",{ "$subtract": [ NumberLong("1"),"$l_discount" ] } ] },"else": NumberLong("0") } },null ] },"then": NumberInt("0"),"else": NumberInt("1") } } },"sum(tpch_DOT_lineitem_DOT_l_extendedprice*1-tpch_DOT_lineitem_DOT_l_discount)": { "$sum": { "$multiply": [ "$l_extendedprice",{ "$subtract": [ NumberLong("1"),"$l_discount" ] } ] } },"sum(tpch_DOT_lineitem_DOT_l_extendedprice*1-tpch_DOT_lineitem_DOT_l_discount)_count": { "$sum": { "$cond": { "if": { "$lte": [ { "$multiply": [ "$l_extendedprice",{ "$subtract": [ NumberLong("1"),"$l_discount" ] } ] },null ] },"then": NumberInt("0"),"else": NumberInt("1") } } } } },
      { "$project": { "_id": NumberInt("0"),"sum(case when (tpch_DOT_part_DOT_p_type like PROMO%) then tpch_DOT_lineitem_DOT_l_extendedprice*1-tpch_DOT_lineitem_DOT_l_discount else 0 end)": { "$cond": { "if": "$sum(case when (tpch_DOT_part_DOT_p_type like PROMO%) then tpch_DOT_lineitem_DOT_l_extendedprice*1-tpch_DOT_lineitem_DOT_l_discount else 0 end)_count","then": "$sum(case when (tpch_DOT_part_DOT_p_type like PROMO%) then tpch_DOT_lineitem_DOT_l_extendedprice*1-tpch_DOT_lineitem_DOT_l_discount else 0 end)","else": { "$literal": null } } },"sum(tpch_DOT_lineitem_DOT_l_extendedprice*1-tpch_DOT_lineitem_DOT_l_discount)": { "$cond": { "if": "$sum(tpch_DOT_lineitem_DOT_l_extendedprice*1-tpch_DOT_lineitem_DOT_l_discount)_count","then": "$sum(tpch_DOT_lineitem_DOT_l_extendedprice*1-tpch_DOT_lineitem_DOT_l_discount)","else": { "$literal": null } } } } },
      { "$group": { "_id": { "group_key_0": { "$cond": { "if": { "$eq": [ "$sum(tpch_DOT_lineitem_DOT_l_extendedprice*1-tpch_DOT_lineitem_DOT_l_discount)",{ "$literal": NumberInt("0") } ] },"then": { "$literal": null },"else": { "$divide": [ { "$multiply": [ { "$literal": NumberDecimal("100") },"$sum(case when (tpch_DOT_part_DOT_p_type like PROMO%) then tpch_DOT_lineitem_DOT_l_extendedprice*1-tpch_DOT_lineitem_DOT_l_discount else 0 end)" ] },"$sum(tpch_DOT_lineitem_DOT_l_extendedprice*1-tpch_DOT_lineitem_DOT_l_discount)" ] } } } },"tpch_DOT_sum(case when (tpch_DOT_part_DOT_p_type like PROMO%) then tpch_DOT_lineitem_DOT_l_extendedprice*1-tpch_DOT_lineitem_DOT_l_discount else 0 end)": { "$first": "$sum(case when (tpch_DOT_part_DOT_p_type like PROMO%) then tpch_DOT_lineitem_DOT_l_extendedprice*1-tpch_DOT_lineitem_DOT_l_discount else 0 end)" },"tpch_DOT_sum(tpch_DOT_lineitem_DOT_l_extendedprice*1-tpch_DOT_lineitem_DOT_l_discount)": { "$first": "$sum(tpch_DOT_lineitem_DOT_l_extendedprice*1-tpch_DOT_lineitem_DOT_l_discount)" } } },
      { "$project": { "tpch_DOT_100*tpch_DOT_sum(case when (tpch_DOT_part_DOT_p_type like PROMO%) then tpch_DOT_lineitem_DOT_l_extendedprice*1-tpch_DOT_lineitem_DOT_l_discount else 0 end)/tpch_DOT_sum(tpch_DOT_lineitem_DOT_l_extendedprice*1-tpch_DOT_lineitem_DOT_l_discount)": { "$cond": { "if": { "$eq": [ "$tpch_DOT_sum(tpch_DOT_lineitem_DOT_l_extendedprice*1-tpch_DOT_lineitem_DOT_l_discount)",{ "$literal": NumberInt("0") } ] },"then": { "$literal": null },"else": { "$divide": [ { "$multiply": [ { "$literal": NumberDecimal("100") },"$tpch_DOT_sum(case when (tpch_DOT_part_DOT_p_type like PROMO%) then tpch_DOT_lineitem_DOT_l_extendedprice*1-tpch_DOT_lineitem_DOT_l_discount else 0 end)" ] },"$tpch_DOT_sum(tpch_DOT_lineitem_DOT_l_extendedprice*1-tpch_DOT_lineitem_DOT_l_discount)" ] } } },"_id": NumberInt("0") } },
    ]
  cursor: {}

q14_normalized_distinct:
  Repeat: 1
  Database: tpch
  Operations:
    - OperationMetricsName: BIC
      OperationName: RunCommand
      OperationCommand: *q14_normalized_distinct_aggregation
