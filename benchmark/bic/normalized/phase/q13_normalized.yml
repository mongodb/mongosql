SchemaVersion: 2018-07-01
Owner: "@10gen/sql-engines-team"
Description: |
  This workload uses the RunCommand actor to issue an aggregation pipeline,
  generated by translating TPC-H query 13 via MongoDB BIC
q13_normalized:
  Repeat: 1
  Database: tpch
  Operations:
    - OperationMetricsName: BIC
      OperationName: RunCommand
      OperationCommand:
        aggregate: customer
        pipeline:
          [
            {
              "$lookup":
                {
                  "from": "orders",
                  "localField": "c_custkey",
                  "foreignField": "o_custkey",
                  "as": "__joined_orders",
                },
            },
            {
              "$project":
                {
                  "__joined_orders":
                    {
                      "$filter":
                        {
                          "input":
                            {
                              "$cond":
                                {
                                  "if": { "$lte": ["$c_custkey", { "$literal": null }] },
                                  "then": [],
                                  "else": "$__joined_orders",
                                },
                            },
                          "as": "this",
                          "cond":
                            {
                              "$let":
                                {
                                  "vars":
                                    {
                                      "arg":
                                        {
                                          "$cond":
                                            {
                                              "if":
                                                {
                                                  "$regexMatch":
                                                    {
                                                      "input": "$$this.o_comment",
                                                      "regex":
                                                        {
                                                          "$literal": "^\\.\\*special\\.\\*requests\\.\\*$",
                                                        },
                                                      "options": { "$literal": "si" },
                                                    },
                                                },
                                              "then": { "$literal": 1 },
                                              "else": { "$literal": 0 },
                                            },
                                        },
                                    },
                                  "in":
                                    {
                                      "$cond":
                                        {
                                          "if":
                                            { "$lte": ["$$arg", { "$literal": null }] },
                                          "then": { "$literal": null },
                                          "else": { "$not": ["$$arg"] },
                                        },
                                    },
                                },
                            },
                        },
                    },
                  "c_custkey": 1,
                },
            },
            {
              "$unwind":
                { "path": "$__joined_orders", "preserveNullAndEmptyArrays": true },
            },
            {
              "$group":
                {
                  "_id": "$c_custkey",
                  "count(tpch_DOT_orders_DOT_o_orderkey)":
                    {
                      "$sum":
                        {
                          "$cond":
                            {
                              "if": { "$lte": ["$__joined_orders.o_orderkey", null] },
                              "then": 0,
                              "else": 1,
                            },
                        },
                    },
                },
            },
            {
              "$project":
                {
                  "tpch_DOT_count(tpch_DOT_orders_DOT_o_orderkey)": "$count(tpch_DOT_orders_DOT_o_orderkey)",
                },
            },
            {
              "$group":
                {
                  "_id": "$tpch_DOT_count(tpch_DOT_orders_DOT_o_orderkey)",
                  "count(*)": { "$sum": 1 },
                },
            },
            { "$addFields": { "_id": { "group_key_0": "$_id" } } },
            {
              "$sort":
                { "count(*)": -1, "_id.group_key_0": -1 },
            },
            {
              "$project":
                {
                  "tpch_DOT_c_orders_DOT_c_count": "$_id.group_key_0",
                  "count(*)": "$count(*)",
                  "_id": 0,
                },
            },
          ]
        cursor: {}
