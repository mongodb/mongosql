SchemaVersion: 2018-07-01
Owner: "@10gen/sql-engines-team"
Description: |
  This workload uses the RunCommand actor to issue an aggregation pipeline,
  generated by translating TPC-H query 7 (distinct) via MongoDB BIC

q7_normalized_distinct_aggregation: &q7_normalized_distinct_aggregation
  aggregate: supplier
  pipeline:
    [
      { "$match": { "$and": [ { "s_suppkey": { "$ne": null } },{ "s_nationkey": { "$ne": null } } ] } },
      { "$lookup": { "from": "nation","localField": "s_nationkey","foreignField": "n_nationkey","as": "__joined_n1" } },
      { "$unwind": "$__joined_n1" },
      { "$lookup": { "from": "lineitem","localField": "s_suppkey","foreignField": "l_suppkey","as": "__joined_lineitem" } },
      { "$unwind": "$__joined_lineitem" },
      { "$match": { "$and": [ { "__joined_lineitem.l_orderkey": { "$ne": null } },{ "__joined_lineitem.l_shipdate": { "$lte": ISODate("1996-12-31T00:00:00") } },{ "__joined_lineitem.l_shipdate": { "$gte": ISODate("1995-01-01T00:00:00") } } ] } },
      { "$lookup": { "from": "orders","localField": "__joined_lineitem.l_orderkey","foreignField": "o_orderkey","as": "__joined_orders" } },
      { "$unwind": "$__joined_orders" },
      { "$match": { "__joined_orders.o_custkey": { "$ne": null } } },
      { "$lookup": { "from": "customer","localField": "__joined_orders.o_custkey","foreignField": "c_custkey","as": "__joined_customer" } },
      { "$unwind": "$__joined_customer" },
      { "$match": { "__joined_customer.c_nationkey": { "$ne": null } } },
      { "$lookup": { "from": "nation","localField": "__joined_customer.c_nationkey","foreignField": "n_nationkey","as": "__joined_n2" } },
      { "$unwind": "$__joined_n2" },
      { "$project": { "tpch_DOT_n1_DOT_n_name": "$__joined_n1.n_name","tpch_DOT_n2_DOT_n_name": "$__joined_n2.n_name","extract(year,tpch_DOT_lineitem_DOT_l_shipdate)": { "$cond": { "if": { "$lte": [ "$__joined_lineitem.l_shipdate",{ "$literal": null } ] },"then": { "$literal": null },"else": { "$year": "$__joined_lineitem.l_shipdate" } } },"tpch_DOT_lineitem_DOT_l_extendedprice*1-tpch_DOT_lineitem_DOT_l_discount": { "$multiply": [ "$__joined_lineitem.l_extendedprice",{ "$subtract": [ 1,"$__joined_lineitem.l_discount" ] } ] } } },
      { "$group": { "_id": { "group_key_0": { "$ifNull": [ "$tpch_DOT_n1_DOT_n_name",{ "$literal": null } ] },"group_key_1": { "$ifNull": [ "$tpch_DOT_n2_DOT_n_name",{ "$literal": null } ] },"group_key_2": { "$ifNull": [ "$extract(year,tpch_DOT_lineitem_DOT_l_shipdate)",{ "$literal": null } ] } },"sum(tpch_DOT_shipping_DOT_volume)": { "$sum": "$tpch_DOT_lineitem_DOT_l_extendedprice*1-tpch_DOT_lineitem_DOT_l_discount" },"sum(tpch_DOT_shipping_DOT_volume)_count": { "$sum": { "$cond": { "if": { "$lte": [ "$tpch_DOT_lineitem_DOT_l_extendedprice*1-tpch_DOT_lineitem_DOT_l_discount",null ] },"then": 0,"else": 1 } } } } },
      { "$project": { "_id": 0,"tpch_DOT_shipping_DOT_supp_nation": "$_id.group_key_0","tpch_DOT_shipping_DOT_cust_nation": "$_id.group_key_1","tpch_DOT_shipping_DOT_l_year": "$_id.group_key_2","sum(tpch_DOT_shipping_DOT_volume)": { "$cond": { "if": "$sum(tpch_DOT_shipping_DOT_volume)_count","then": "$sum(tpch_DOT_shipping_DOT_volume)","else": { "$literal": null } } } } },
      { "$group": { "_id": { "group_key_0": { "$ifNull": [ "$tpch_DOT_shipping_DOT_supp_nation",{ "$literal": null } ] },"group_key_1": { "$ifNull": [ "$tpch_DOT_shipping_DOT_cust_nation",{ "$literal": null } ] },"group_key_2": { "$ifNull": [ "$tpch_DOT_shipping_DOT_l_year",{ "$literal": null } ] },"group_key_3": { "$ifNull": [ "$sum(tpch_DOT_shipping_DOT_volume)",{ "$literal": null } ] } } } },
      { "$sort": { "_id.group_key_0": 1,"_id.group_key_1": 1,"_id.group_key_2": 1 } },
      { "$project": { "tpch_DOT_shipping_DOT_supp_nation": "$_id.group_key_0","tpch_DOT_shipping_DOT_cust_nation": "$_id.group_key_1","tpch_DOT_shipping_DOT_l_year": "$_id.group_key_2","tpch_DOT_sum(tpch_DOT_shipping_DOT_volume)": "$_id.group_key_3","_id": 0 } },
    ]
  cursor: {}

q7_normalized_distinct:
  Repeat: 1
  Database: tpch
  Operations:
    - OperationMetricsName: BIC
      OperationName: RunCommand
      OperationCommand: *q7_normalized_distinct_aggregation
