SchemaVersion: 2018-07-01
Owner: "@10gen/sql-engines-team"
Description: |
  This workload uses the RunCommand actor to issue an aggregation pipeline,
  generated by translating TPC-H query 6 (distinct) via MongoDB BIC

q6_normalized_distinct_aggregation: &q6_normalized_distinct_aggregation
  aggregate: lineitem
  pipeline:
    [
      {
        "$match": {
          "$and": [
            { "l_quantity": { "$lt": 24 } },
            { "l_discount": { "$lte": 0.071 } },
            { "l_discount": { "$gte": 0.05 } },
            { "l_shipdate": { "$lt": ISODate("1995-01-01T00:00:00") } },
            { "l_shipdate": { "$gte": ISODate("1994-01-01T00:00:00") } }
          ]
        }
      },
      {
        "$group": {
          "_id": null,
          "sum_extendedprice_discount": { "$sum": { "$multiply": ["$l_extendedprice", "$l_discount"] } },
          "sum_extendedprice_discount_count": {
            "$sum": {
              "$cond": {
                "if": { "$ne": [{ "$multiply": ["$l_extendedprice", "$l_discount"] }, null] },
                "then": 1,
                "else": 0
              }
            }
          }
        }
      },
      {
        "$project": {
          "_id": 0,
          "sum_extendedprice_discount": {
            "$cond": {
              "if": { "$gt": ["$sum_extendedprice_discount_count", 0] },
              "then": "$sum_extendedprice_discount",
              "else": null
            }
          }
        }
      },
      {
        "$group": {
          "_id": "$sum_extendedprice_discount"
        }
      },
      {
        "$addFields": {
          "_id": { "group_key_0": "$_id" }
        }
      },
      {
        "$project": {
          "tpch_DOT_sum(tpch_DOT_lineitem_DOT_l_extendedprice*tpch_DOT_lineitem_DOT_l_discount)": "$_id.group_key_0",
          "_id": 0
        }
      }
    ]
  cursor: {}

q6_normalized_distinct:
  Repeat: 1
  Database: tpch
  Operations:
    - OperationMetricsName: BIC
      OperationName: RunCommand
      OperationCommand: *q6_normalized_distinct_aggregation
