SchemaVersion: 2018-07-01
Owner: "@10gen/sql-engines-team"
Description: |
  This workload uses the RunCommand actor to issue an aggregation pipeline,
  generated by translating TPC-H query 19 (distinct) via MongoDB BIC

q19_normalized_distinct_aggregation: &q19_normalized_distinct_aggregation
  aggregate: part
  pipeline:
    [
      { "$lookup": { "from": "lineitem","let": { "local_table__p_partkey": "$p_partkey","local_table__p_brand": "$p_brand","local_table__p_container": "$p_container","local_table__p_container_0": "$p_container","local_table__p_size": "$p_size","local_table__p_size_0": "$p_size","local_table__p_partkey_0": "$p_partkey","local_table__p_brand_0": "$p_brand" },"pipeline": [ { "$match": { "$expr": { "$and": [ { "$eq": [ "$l_partkey","$$local_table__p_partkey" ] },{ "$eq": [ "$$local_table__p_brand","Brand#12" ] },{ "$or": [ { "$eq": [ "$$local_table__p_container","SM CASE" ] },{ "$eq": [ "$$local_table__p_container","SM BOX" ] },{ "$eq": [ "$$local_table__p_container","SM PACK" ] },{ "$eq": [ "$$local_table__p_container","SM PKG" ] } ] },{ "$gte": [ "$l_quantity",1 ] },{ "$lte": [ "$l_quantity",11 ] },{ "$gte": [ "$$local_table__p_size",1 ] },{ "$lte": [ "$$local_table__p_size",5 ] },{ "$or": [ { "$eq": [ "$l_shipmode","AIR" ] },{ "$eq": [ "$l_shipmode","AIR REG" ] } ] },{ "$eq": [ "$l_shipinstruct","DELIVER IN PERSON" ] } ] } } } ],"as": "__joined_lineitem" } },
      { "$unwind": "$__joined_lineitem" },
      { "$group": { "_id": {},"sum(tpch_DOT_lineitem_DOT_l_extendedprice*1-tpch_DOT_lineitem_DOT_l_discount)": { "$sum": { "$multiply": [ "$__joined_lineitem.l_extendedprice",{ "$subtract": [ 1,"$__joined_lineitem.l_discount" ] } ] } },"sum(tpch_DOT_lineitem_DOT_l_extendedprice*1-tpch_DOT_lineitem_DOT_l_discount)_count": { "$sum": { "$cond": { "if": { "$lte": [ { "$multiply": [ "$__joined_lineitem.l_extendedprice",{ "$subtract": [ 1,"$__joined_lineitem.l_discount" ] } ] },null ] },"then": 0,"else": 1 } } } } },
      { "$project": { "_id": 0,"sum(tpch_DOT_lineitem_DOT_l_extendedprice*1-tpch_DOT_lineitem_DOT_l_discount)": { "$cond": { "if": "$sum(tpch_DOT_lineitem_DOT_l_extendedprice*1-tpch_DOT_lineitem_DOT_l_discount)_count","then": "$sum(tpch_DOT_lineitem_DOT_l_extendedprice*1-tpch_DOT_lineitem_DOT_l_discount)","else": { "$literal": null } } } } },
      { "$group": { "_id": "$sum(tpch_DOT_lineitem_DOT_l_extendedprice*1-tpch_DOT_lineitem_DOT_l_discount)" } },
      { "$addFields": { "_id": { "group_key_0": "$_id" } } },
      { "$project": { "tpch_DOT_sum(tpch_DOT_lineitem_DOT_l_extendedprice*1-tpch_DOT_lineitem_DOT_l_discount)": "$_id.group_key_0","_id": 0 } }
    ]
  cursor: {}

q19_normalized_distinct:
  Repeat: 1
  Database: tpch
  Operations:
    - OperationMetricsName: BIC
      OperationName: RunCommand
      OperationCommand: *q19_normalized_distinct_aggregation
