SchemaVersion: 2018-07-01
Owner: "@10gen/sql-engines-team"
Description: |
  This workload uses the RunCommand actor to issue an aggregation pipeline,
  generated by translating TPC-H query 8 (distinct) via MongoDB BIC

q8_normalized_distinct_aggregation: &q8_normalized_distinct_aggregation
  aggregate: part
  pipeline:
    [
      { "$match": { "$and": [ { "p_partkey": { "$ne": null } },{ "p_type": { "$eq": "ECONOMY BRUSHED STEEL" } } ] } },
      { "$lookup": { "from": "lineitem","localField": "p_partkey","foreignField": "l_partkey","as": "__joined_lineitem" } },
      { "$unwind": "$__joined_lineitem" },
      { "$match": { "$and": [ { "__joined_lineitem.l_orderkey": { "$ne": null } },{ "__joined_lineitem.l_suppkey": { "$ne": null } } ] } },
      { "$lookup": { "from": "supplier","localField": "__joined_lineitem.l_suppkey","foreignField": "s_suppkey","as": "__joined_supplier" } },
      { "$unwind": "$__joined_supplier" },
      { "$match": { "__joined_supplier.s_nationkey": { "$ne": null } } },
      { "$lookup": { "from": "nation","localField": "__joined_supplier.s_nationkey","foreignField": "n_nationkey","as": "__joined_n2" } },
      { "$unwind": "$__joined_n2" },
      { "$lookup": { "from": "orders","localField": "__joined_lineitem.l_orderkey","foreignField": "o_orderkey","as": "__joined_orders" } },
      { "$unwind": "$__joined_orders" },
      { "$match": { "$and": [ { "__joined_orders.o_custkey": { "$ne": null } },{ "__joined_orders.o_orderdate": { "$lte": ISODate("1996-12-31T00:00:00") } },{ "__joined_orders.o_orderdate": { "$gte": ISODate("1995-01-01T00:00:00") } } ] } },
      { "$lookup": { "from": "customer","localField": "__joined_orders.o_custkey","foreignField": "c_custkey","as": "__joined_customer" } },
      { "$unwind": "$__joined_customer" },
      { "$match": { "__joined_customer.c_nationkey": { "$ne": null } } },
      { "$lookup": { "from": "nation","localField": "__joined_customer.c_nationkey","foreignField": "n_nationkey","as": "__joined_n1" } },
      { "$unwind": "$__joined_n1" },
      { "$match": { "__joined_n1.n_regionkey": { "$ne": null } } },
      { "$lookup": { "from": "region","localField": "__joined_n1.n_regionkey","foreignField": "r_regionkey","as": "__joined_region" } },
      { "$unwind": "$__joined_region" },
      { "$match": { "__joined_region.r_name": { "$eq": "EUROPE" } } },
      { "$project": { "extract(year,tpch_DOT_orders_DOT_o_orderdate)": { "$cond": { "if": { "$lte": [ "$__joined_orders.o_orderdate",{ "$literal": null } ] },"then": { "$literal": null },"else": { "$year": "$__joined_orders.o_orderdate" } } },"tpch_DOT_lineitem_DOT_l_extendedprice*1-tpch_DOT_lineitem_DOT_l_discount": { "$multiply": [ "$__joined_lineitem.l_extendedprice",{ "$subtract": [ 1,"$__joined_lineitem.l_discount" ] } ] },"tpch_DOT_n2_DOT_n_name": "$__joined_n2.n_name" } },
      { "$group": { "_id": "$extract(year,tpch_DOT_orders_DOT_o_orderdate)","sum(case when (tpch_DOT_all_nations_DOT_nation = UNITED STATES) then tpch_DOT_all_nations_DOT_volume else 0 end)": { "$sum": { "$cond": { "if": { "$reduce": { "input": [ { "$cond": { "if": { "$or": [ { "$lte": [ "$tpch_DOT_n2_DOT_n_name",null ] },{ "$lte": [ "UNITED STATES",null ] } ] },"then": null,"else": { "$eq": [ "$tpch_DOT_n2_DOT_n_name","UNITED STATES" ] } } },{ "$cond": { "if": { "$or": [ { "$lte": [ "$tpch_DOT_n2_DOT_n_name",null ] },{ "$lte": [ true,null ] } ] },"then": null,"else": { "$eq": [ "$tpch_DOT_n2_DOT_n_name",true ] } } } ],"initialValue": false,"in": { "$switch": { "branches": [ { "case": { "$or": [ "$$this","$$value" ] },"then": true },{ "case": { "$eq": [ "$$this",null ] },"then": null },{ "case": { "$eq": [ "$$value",null ] },"then": null } ],"default": false } } } },"then": "$tpch_DOT_lineitem_DOT_l_extendedprice*1-tpch_DOT_lineitem_DOT_l_discount","else": 0 } } },"sum(case when (tpch_DOT_all_nations_DOT_nation = UNITED STATES) then tpch_DOT_all_nations_DOT_volume else 0 end)_count": { "$sum": { "$cond": { "if": { "$lte": [ { "$cond": { "if": { "$reduce": { "input": [ { "$cond": { "if": { "$or": [ { "$lte": [ "$tpch_DOT_n2_DOT_n_name",null ] },{ "$lte": [ "UNITED STATES",null ] } ] },"then": null,"else": { "$eq": [ "$tpch_DOT_n2_DOT_n_name","UNITED STATES" ] } } },{ "$cond": { "if": { "$or": [ { "$lte": [ "$tpch_DOT_n2_DOT_n_name",null ] },{ "$lte": [ true,null ] } ] },"then": null,"else": { "$eq": [ "$tpch_DOT_n2_DOT_n_name",true ] } } } ],"initialValue": false,"in": { "$switch": { "branches": [ { "case": { "$or": [ "$$this","$$value" ] },"then": true },{ "case": { "$eq": [ "$$this",null ] },"then": null },{ "case": { "$eq": [ "$$value",null ] },"then": null } ],"default": false } } } },"then": "$tpch_DOT_lineitem_DOT_l_extendedprice*1-tpch_DOT_lineitem_DOT_l_discount","else": 0 } },null ] },"then": 0,"else": 1 } } },"sum(tpch_DOT_all_nations_DOT_volume)": { "$sum": "$tpch_DOT_lineitem_DOT_l_extendedprice*1-tpch_DOT_lineitem_DOT_l_discount" },"sum(tpch_DOT_all_nations_DOT_volume)_count": { "$sum": { "$cond": { "if": { "$lte": [ "$tpch_DOT_lineitem_DOT_l_extendedprice*1-tpch_DOT_lineitem_DOT_l_discount",null ] },"then": 0,"else": 1 } } } } },
      { "$addFields": { "_id": { "group_key_0": "$_id" } } },
      { "$project": { "_id": 0,"tpch_DOT_all_nations_DOT_o_year": "$_id.group_key_0","sum(case when (tpch_DOT_all_nations_DOT_nation = UNITED STATES) then tpch_DOT_all_nations_DOT_volume else 0 end)": { "$cond": { "if": "$sum(case when (tpch_DOT_all_nations_DOT_nation = UNITED STATES) then tpch_DOT_all_nations_DOT_volume else 0 end)_count","then": "$sum(case when (tpch_DOT_all_nations_DOT_nation = UNITED STATES) then tpch_DOT_all_nations_DOT_volume else 0 end)","else": { "$literal": null } } },"sum(tpch_DOT_all_nations_DOT_volume)": { "$cond": { "if": "$sum(tpch_DOT_all_nations_DOT_volume)_count","then": "$sum(tpch_DOT_all_nations_DOT_volume)","else": { "$literal": null } } } } },
      { "$group": { "_id": { "group_key_0": { "$ifNull": [ "$tpch_DOT_all_nations_DOT_o_year",{ "$literal": null } ] },"group_key_1": { "$ifNull": [ { "$cond": { "if": { "$eq": [ "$sum(tpch_DOT_all_nations_DOT_volume)",0 ] },"then": { "$literal": null },"else": { "$divide": [ "$sum(case when (tpch_DOT_all_nations_DOT_nation = UNITED STATES) then tpch_DOT_all_nations_DOT_volume else 0 end)","$sum(tpch_DOT_all_nations_DOT_volume)" ] } } },{ "$literal": null } ] } },"tpch_DOT_sum(case when (tpch_DOT_all_nations_DOT_nation = UNITED STATES) then tpch_DOT_all_nations_DOT_volume else 0 end)": { "$first": "$sum(case when (tpch_DOT_all_nations_DOT_nation = UNITED STATES) then tpch_DOT_all_nations_DOT_volume else 0 end)" },"tpch_DOT_sum(tpch_DOT_all_nations_DOT_volume)": { "$first": "$sum(tpch_DOT_all_nations_DOT_volume)" } } },
      { "$project": { "_id": 0,"tpch_DOT_all_nations_DOT_o_year": "$_id.group_key_0","tpch_DOT_sum(case when (tpch_DOT_all_nations_DOT_nation = UNITED STATES) then tpch_DOT_all_nations_DOT_volume else 0 end)/tpch_DOT_sum(tpch_DOT_all_nations_DOT_volume)": { "$cond": { "if": { "$eq": [ "$tpch_DOT_sum(tpch_DOT_all_nations_DOT_volume)",0 ] },"then": { "$literal": null },"else": { "$divide": [ "$tpch_DOT_sum(case when (tpch_DOT_all_nations_DOT_nation = UNITED STATES) then tpch_DOT_all_nations_DOT_volume else 0 end)","$tpch_DOT_sum(tpch_DOT_all_nations_DOT_volume)" ] } } } } },
      { "$sort": { "tpch_DOT_all_nations_DOT_o_year": 1 } },
      { "$project": { "tpch_DOT_all_nations_DOT_o_year": "$tpch_DOT_all_nations_DOT_o_year","tpch_DOT_tpch_DOT_sum(case when (tpch_DOT_all_nations_DOT_nation = UNITED STATES) then tpch_DOT_all_nations_DOT_volume else 0 end)/tpch_DOT_sum(tpch_DOT_all_nations_DOT_volume)": "$tpch_DOT_sum(case when (tpch_DOT_all_nations_DOT_nation = UNITED STATES) then tpch_DOT_all_nations_DOT_volume else 0 end)/tpch_DOT_sum(tpch_DOT_all_nations_DOT_volume)","_id": 0 } },
    ]
  cursor: {}

q8_normalized_distinct:
  Repeat: 1
  Database: tpch
  Operations:
    - OperationMetricsName: BIC
      OperationName: RunCommand
      OperationCommand: *q8_normalized_distinct_aggregation
