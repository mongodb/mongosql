data:
- ns: tableau.attendees
  json_file: testdata/input/tableau_attendees.json

schema :
-
  db: public
  tables:
    - table: flights
      collection: tableau.flights201406
      columns:
        - name: "carrier_code"
          type: string
        - name: "tail_num"
          type: string
        - name: "flight_number"
          type: int
        - name: "origin_airport_id"
          type: int
        - name: "origin_city_market_id"
          type: int
        - name: "origin_airport_code"
          type: string
        - name: "origin_city_name"
          type: string
        - name: "origin_state"
          type: string
        - name: "dest_airport_id"
          type: int
        - name: "dest_city_market_id"
          type: int
        - name: "dest_airport_code"
          type: string
        - name: "dest_city_name"
          type: string
        - name: "dest_state"
          type: string
        - name: "dest_time"
          type: int
        - name: "diff_from_dep_time"
          type: int
        - name: "dep_delay"
          type: int
        - name: "arr_time"
          type: int
        - name: "diff_from_arr_time"
          type: int
        - name: "airline"
          type: string
        - name: "cancelled"
          type: int
        - name: "arr_delay"
          type: int
        - name: "carrier_delay"
          type: int

    - table: attendees
      collection: "tableau.attendees"
      columns:
        - name: "latitude"
          type: float
          source: "loc.coordinates.0"
        - name: "longitude"
          type: float
          source: "loc.coordinates.1"
        - name: "airport_city"
          type: string
        - name: "airport_code"
          type: string
        - name: "airport_id"
          type: int
        - name: "city"
          type: string
        - name: "city_market_description"
          type: string
        - name: "city_market_id"
          type: int
        - name: "country"
          type: string
        - name: "state"
          type: string
        - name: "zip"
          type: "int"

testcases:
    - sql: "SELECT SUM(1) AS num_records FROM public.attendees attendees HAVING (COUNT(1) > 0);"
    - sql: "SELECT attendees.longitude AS longitude, SUM(1) AS num_records FROM public.attendees attendees GROUP BY 1;"
    - sql: "SELECT attendees.latitude AS latitude, attendees.longitude AS longitude, SUM(1) AS records FROM public.attendees attendees GROUP BY 1, 2;"
    - sql: "SELECT attendees.airport_city AS airport_city, attendees.latitude AS latitude, attendees.longitude AS longitude, SUM(1) AS records FROM public.attendees attendees GROUP BY 1,  2,  3;"
    #- sql: "SELECT flights201406.origin_city_market_id AS origin_city_market_id FROM public.flights201406 flights201406 GROUP BY 1;"
    #- sql: "SELECT MIN(flights201406.flight_date) AS TEMP(flight_date_lower)(290714814)(0), MAX(flights201406.flight_date) AS TEMP(flight_date_upper)(290714814)(0) FROM public.flights201406 flights201406 HAVING (COUNT(1) > 0);"
    #- sql: "SELECT attendees.airport_city AS airport_city, attendees.latitude AS latitude, attendees.longitude AS longitude, SUM(1) AS records FROM public.attendees attendees INNER JOIN public.flights201406 flights201406 ON (attendees.airport_code = flights201406.dest_airport_code) WHERE (((flights201406.flight_date >= (TIMESTAMP '2014-06-01 00:00:00.000')) AND (flights201406.flight_date <= (TIMESTAMP '2014-06-07 11:00:00.000'))) AND (flights201406.origin_city_market_id = 31703)) GROUP BY 1, 2, 3;"
    #- sql: "SELECT attendees.city AS city, SUM(1) AS calculation_4190704170258269 FROM public.attendees attendees  INNER JOIN public.flights201406 flights201406 ON (attendees.airport_code = flights201406.dest_airport_code) WHERE (((flights201406.flight_date >= (TIMESTAMP '2014-06-01 00:00:00.000')) AND (flights201406.flight_date <= (TIMESTAMP '2014-06-07 11:00:00.000'))) AND (flights201406.origin_city_market_id = 31703.000000)) GROUP BY 1;"
    #- sql: "SELECT attendees.city AS city, COUNT(DISTINCT attendees._id) AS ctd_id FROM public.attendees attendees INNER JOIN public.flights201406 flights201406 ON (attendees.airport_code = flights201406.dest_airport_code) WHERE (((flights201406.flight_date >= (TIMESTAMP '2014-06-01 00:00:00.000')) AND (flights201406.flight_date <= (TIMESTAMP '2014-06-07 11:00:00.000'))) AND (flights201406.origin_city_market_id = 31703.000000)) GROUP BY 1;"
    #- sql: "SELECT (CASE WHEN (flights201406.dest_city_name IS NULL) THEN attendees.airport_city ELSE flights201406.dest_city_name END) AS Calculation_6710704172113145, SUM(1) AS TEMP(Calculation_9510704170320209)(2414991311)(0), SUM((CASE WHEN (flights201406.cancelled = '1') THEN 1 ELSE 0 END)) AS TEMP(Calculation_9510704170320209)(424513295)(0), COUNT(DISTINCT attendees._id) AS ctd_id FROM public.attendees attendees INNER JOIN public.flights201406 flights201406 ON (attendees.airport_code = flights201406.dest_airport_code) WHERE (((flights201406.flight_date >= (TIMESTAMP '2014-06-01 00:00:00.000')) AND (flights201406.flight_date <= (TIMESTAMP '2014-06-07 11:00:00.000'))) AND (flights201406.origin_city_market_id = 31703.000000)) GROUP BY 1;"
    #- sql: "SELECT (CASE WHEN (flights201406.dest_city_name = NULL) THEN attendees.airport_city ELSE flights201406.dest_city_name END) AS Calculation_6710704172113145, (100 * (CASE WHEN 1 = 0 THEN NULL ELSE CAST((CASE WHEN (flights201406.cancelled = '1') THEN 1 ELSE 0 END) AS DOUBLE PRECISION) / 1 END)) AS Calculation_9510704170320209, 1 AS num_records, flights201406._id AS _id (flights201406), attendees._id AS _id, flights201406.airline AS airline, attendees.airport_city AS airport_city, attendees.airport_code AS airport_code, attendees.airport_id AS airport_id, flights201406.arr_delay AS arr_delay, flights201406.arr_time AS arr_time, flights201406.cancelled AS cancelled, flights201406.carrier_code AS carrier_code, flights201406.carrier_delay AS carrier_delay, attendees.city AS city, attendees.city_market_description AS city_market_description, attendees.city_market_id AS city_market_id, attendees.country AS country, flights201406.dep_delay AS dep_delay, flights201406.dep_time AS dep_time, flights201406.dest_airport_code AS dest_airport_code, flights201406.dest_airport_id AS dest_airport_id, flights201406.dest_city_market_id AS dest_city_market_id, flights201406.dest_city_name AS dest_city_name, flights201406.dest_state AS dest_state, flights201406.diff_from_arr_time AS diff_from_arr_time, flights201406.diff_from_dep_time AS diff_from_dep_time, flights201406.flight_date AS flight_date, flights201406.flight_number AS flight_number, flights201406.flight_time AS flight_time, flights201406.late_aircraft_delay AS late_aircraft_delay, attendees.latitude AS latitude, attendees.longitude AS longitude, flights201406.nas_delay AS nas_delay, flights201406.origin_airport_code AS origin_airport_code, flights201406.origin_airport_id AS origin_airport_id, flights201406.origin_city_market_id AS origin_city_market_id, flights201406.origin_city_name AS origin_city_name, flights201406.origin_state AS origin_state, flights201406.tail_num AS tail_num FROM public.attendees attendees INNER JOIN public.flights201406 flights201406 ON (attendees.airport_code = flights201406.dest_airport_code) WHERE ((((flights201406.flight_date >= (TIMESTAMP '2014-06-01 00:00:00.000')) AND (flights201406.flight_date <= (TIMESTAMP '2014-06-07 11:00:00.000'))) AND (flights201406.origin_city_market_id = 31703.000000)) AND ((CASE WHEN (flights201406.dest_city_name = NULL) THEN attendees.airport_city ELSE flights201406.dest_city_name END) IS NULL)) LIMIT 7500;"
    #- sql: "SELECT (CASE WHEN (flights201406.dest_city_name IS NULL) THEN attendees.airport_city ELSE flights201406.dest_city_name END) AS Calculation_6710704172113145, SUM(1) AS TEMP(Calculation_8730704172859978)(2414991311)(0), SUM((CASE WHEN (flights201406.arr_delay > 14) THEN 1 ELSE 0 END)) AS TEMP(Calculation_8730704172859978)(424447523)(0), COUNT(DISTINCT attendees._id) AS ctd_id, SUM((CASE WHEN (flights201406.arr_delay > 0) THEN flights201406.arr_delay ELSE 0 END)) AS calculation_6050704172825900 FROM public.attendees attendees INNER JOIN public.flights201406 flights201406 ON (attendees.airport_code = flights201406.dest_airport_code) WHERE (((flights201406.flight_date >= (TIMESTAMP '2014-06-01 00:00:00.000')) AND (flights201406.flight_date <= (TIMESTAMP '2014-06-07 11:00:00.000'))) AND (flights201406.origin_city_market_id = 31703.000000)) GROUP BY 1;"

