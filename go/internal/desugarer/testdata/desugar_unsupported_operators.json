[
  {
    "name": "nothing to desugar",
    "input": [
      {
        "$project": {
          "_id": 0,
          "foo": "$$ROOT"
        }
      }
    ],
    "expected": [
      {
        "$project": {
          "_id": 0,
          "foo": "$$ROOT"
        }
      }
    ]
  },
  {
    "name": "desugar $sqlBetween",
    "input": [
      {
        "$project": {
          "_id": 0,
          "expr": {
            "$sqlBetween": [
              "$x",
              1,
              10
            ]
          }
        }
      }
    ],
    "expected": [
      {
        "$project": {
          "_id": 0,
          "expr": {
            "$let": {
              "vars": {
                "desugared_sqlBetween_input": "$x"
              },
              "in": {
                "$sqlAnd": [
                  {
                    "$sqlGte": [
                      "$$desugared_sqlBetween_input",
                      1
                    ]
                  },
                  {
                    "$sqlLte": [
                      "$$desugared_sqlBetween_input",
                      10
                    ]
                  }
                ]
              }
            }
          }
        }
      }
    ]
  },
  {
    "name": "desugar nested $sqlBetween",
    "input": [
      {
        "$project": {
          "_id": 0,
          "expr": {
            "$sqlBetween": [
              "$x",
              1,
              {
                "$cond": [
                  {
                    "$sqlBetween": [
                      "$y",
                      50,
                      100
                    ]
                  },
                  100,
                  10
                ]
              }
            ]
          }
        }
      }
    ],
    "expected": [
      {
        "$project": {
          "_id": 0,
          "expr": {
            "$let": {
              "vars": {
                "desugared_sqlBetween_input": "$x"
              },
              "in": {
                "$sqlAnd": [
                  {
                    "$sqlGte": [
                      "$$desugared_sqlBetween_input",
                      1
                    ]
                  },
                  {
                    "$sqlLte": [
                      "$$desugared_sqlBetween_input",
                      {
                        "$cond": [
                          {
                            "$let": {
                              "vars": {
                                "desugared_sqlBetween_input": "$y"
                              },
                              "in": {
                                "$sqlAnd": [
                                  {
                                    "$sqlGte": [
                                      "$$desugared_sqlBetween_input",
                                      50
                                    ]
                                  },
                                  {
                                    "$sqlLte": [
                                      "$$desugared_sqlBetween_input",
                                      100
                                    ]
                                  }
                                ]
                              }
                            }
                          },
                          100,
                          10
                        ]
                      }
                    ]
                  }
                ]
              }
            }
          }
        }
      }
    ]
  },
  {
    "name": "desugar $sqlSlice with no start argument",
    "input": [
      {
        "$project": {
          "_id": 0,
          "expr": {
            "$sqlSlice": [
              "$arr",
              "$len"
            ]
          }
        }
      }
    ],
    "expected": [
      {
        "$project": {
          "_id": 0,
          "expr": {
            "$slice": [
              "$arr",
              "$len"
            ]
          }
        }
      }
    ]
  },
  {
    "name": "desugar $sqlSlice with start argument",
    "input": [
      {
        "$project": {
          "_id": 0,
          "expr": {
            "$sqlSlice": [
              "$arr",
              "$start",
              "$len"
            ]
          }
        }
      }
    ],
    "expected": [
      {
        "$project": {
          "_id": 0,
          "expr": {
            "$cond": [
              {
                "$lte": [
                  "$start",
                  0
                ]
              },
              null,
              {
                "$slice": [
                  "$arr",
                  "$start",
                  "$len"
                ]
              }
            ]
          }
        }
      }
    ]
  },
  {
    "name": "desugar $sqlDivide",
    "input": [
      {
        "$project": {
          "_id": 0,
          "expr": {
            "$sqlDivide": {
              "dividend": "$a",
              "divisor": "$b",
              "onError": null
            }
          }
        }
      }
    ],
    "expected": [
      {
        "$project": {
          "_id": 0,
          "expr": {
            "$cond": [
              {
                "$eq": [
                  "$b",
                  0
                ]
              },
              null,
              {
                "$divide": [
                  "$a",
                  "$b"
                ]
              }
            ]
          }
        }
      }
    ]
  },
  {
    "name": "desugar $sqlDivide non-null onError",
    "input": [
      {
        "$project": {
          "_id": 0,
          "expr": {
            "$sqlDivide": {
              "dividend": "$a",
              "divisor": "$b",
              "onError": "err"
            }
          }
        }
      }
    ],
    "expected": [
      {
        "$project": {
          "_id": 0,
          "expr": {
            "$cond": [
              {
                "$eq": [
                  "$b",
                  0
                ]
              },
              "err",
              {
                "$divide": [
                  "$a",
                  "$b"
                ]
              }
            ]
          }
        }
      }
    ]
  },
  {
    "name": "desugar $nullIf",
    "input": [
      {
        "$project": {
          "_id": 0,
          "expr": {
            "$nullIf": [
              "$a",
              "$b"
            ]
          }
        }
      }
    ],
    "expected": [
      {
        "$project": {
          "_id": 0,
          "expr": {
            "$let": {
              "vars": {
                "expr1": {
                  "$ifNull": [
                    "$a",
                    null
                  ]
                }
              },
              "in": {
                "$cond": [
                  {
                    "$eq": [
                      "$$expr1",
                      "$b"
                    ]
                  },
                  null,
                  "$$expr1"
                ]
              }
            }
          }
        }
      }
    ]
  },
  {
    "name": "desugar $coalesce",
    "input": [
      {
        "$project": {
          "_id": 0,
          "expr": {
            "$coalesce": [
              "$a",
              "$b",
              "$c"
            ]
          }
        }
      }
    ],
    "expected": [
      {
        "$project": {
          "_id": 0,
          "expr": {
            "$switch": {
              "branches": [
                {
                  "case": {
                    "$gt": [
                      "$a",
                      null
                    ]
                  },
                  "then": "$a"
                },
                {
                  "case": {
                    "$gt": [
                      "$b",
                      null
                    ]
                  },
                  "then": "$b"
                },
                {
                  "case": {
                    "$gt": [
                      "$c",
                      null
                    ]
                  },
                  "then": "$c"
                }
              ],
              "default": null
            }
          }
        }
      }
    ]
  },
  {
    "name": "desugar $like with no escape",
    "input": [
      {
        "$project": {
          "_id": 0,
          "expr": {
            "$like": {
              "input": "$s",
              "pattern": "abc"
            }
          }
        }
      }
    ],
    "expected": [
      {
        "$project": {
          "_id": 0,
          "expr": {
            "$regexMatch": {
              "input": "$s",
              "regex": "^abc$",
              "options": "is"
            }
          }
        }
      }
    ]
  },
  {
    "name": "desugar $like with escape",
    "input": [
      {
        "$project": {
          "_id": 0,
          "expr": {
            "$like": {
              "input": "$s",
              "pattern": "a\\__\\_%\\%",
              "escape": "\\"
            }
          }
        }
      }
    ],
    "expected": [
      {
        "$project": {
          "_id": 0,
          "expr": {
            "$regexMatch": {
              "input": "$s",
              "regex": "^a_._.*%$",
              "options": "is"
            }
          }
        }
      }
    ]
  }
]
