catalog_data:
  test:
    foo:
      - {'_id': 0, 'arr': [1, 2, 3]}
      - {'_id': 1, 'arr': [4, 5, 6]}

catalog_schema:
  {
    'test': {
      'foo': {
        'bsonType': "object",
        'required': ["_id", "arr"],
        'additionalProperties': false,
        'properties': {
          '_id': { 'bsonType': "int" },
          'arr': { 'bsonType': "array", 'items': { 'bsonType': "int" } }
        }
      },
    }
  }

tests:
  - description: correctness test for index option using project and where
    current_db: test
    query: "SELECT foo.arr, foo.idx FROM UNWIND(foo WITH PATH => arr, INDEX => idx) WHERE MOD(foo.arr, 2) = 0"
    translation_target_db: test
    translation_target_coll: foo
    translation:
      - {'$project': {'_id': 0, 'foo': '$$ROOT'}}
      - {'$project': {'_id': 0, 'foo': '$foo'}}
      - {'$unwind': {'path': '$foo.arr', 'includeArrayIndex': 'foo.idx'}}
      - {'$match': {'$expr': {'$sqlEq': [ {'$sqlMod': ['$foo.arr', {'$literal': 2}]}, {'$literal': 0}]}}}
      - {'$project': { '_id': 0, __bot: { 'arr': '$foo.arr', 'idx': '$foo.idx'}}}
      - {'$replaceWith': {'$unsetField': {'field': '__bot', 'input': {'$setField': {'field': '', 'input': '$$ROOT', value: '$__bot'}}}}}
    result:
      - {'': {arr: 2, 'idx': {"$numberLong": "1"}}}
      - {'': {arr: 4, 'idx': {"$numberLong": "0"}}}
      - {'': {arr: 6, 'idx': {"$numberLong": "2"}}}
