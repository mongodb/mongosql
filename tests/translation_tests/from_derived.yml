catalog_data:
  foo:
    bar:
      - {'_id': 0, 'a': 1, 'b': 1}
      - {'_id': 1, 'a': 1, 'b': 2}
      - {'_id': 2, 'a': 3, 'b': 3}
      - {'_id': 3, 'a': 5, 'b': 4}

tests:
  - description: nested derived tables correctness test
    current_db: foo
    query: "SELECT VALUE {'a': a, 'b': b} FROM (SELECT * FROM (SELECT _id::!INT, a::!INT, b::!INT FROM bar ORDER BY _id) AS d2 WHERE a >= b) AS d1"
    translation_target_db: foo
    translation_target_coll: bar
    translation:
      - {'$project': {'_id': 0, 'bar': '$$ROOT'}}
      - {'$project': {'_id': 0, 'bar': '$bar'}}
      - {'$project': {'_id': 0, '__bot': {'_id': '$bar._id', 'a': '$bar.a', 'b': '$bar.b'}}}
      - {'$sort': {'__bot._id': 1}}
      - {'$project': {'_id': 0, 'd2': {'$mergeObjects': ['$__bot']}}}
      - {'$match': {'$expr': {'$sqlGte': ['$d2.a', '$d2.b']}}}
      - {'$project': {'_id': 0, 'd1': {'$mergeObjects': ['$d2']}}}
      - {'$project': {'_id': 0, '__bot': {'a': '$d1.a', 'b': '$d1.b'}}}
    result:
      - {'__bot': {'a': 1, 'b': 1}}
      - {'__bot': {'a': 3, 'b': 3}}
      - {'__bot': {'a': 5, 'b': 4}}
