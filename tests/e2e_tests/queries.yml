"catalog_data":
  "testquerydb":
    "foo":
      - {
          "_id": 0,
          "a": { "$numberInt": "1" },
          "b": { "$numberInt": "2" },
          "coll": "foo",
        }
      - {
          "_id": 1,
          "a": { "$numberInt": "2" },
          "b": { "$numberInt": "1" },
          "coll": "foo",
        }
    "foo2":
      - {
          "_id": 0,
          "a": { "$numberInt": "4" },
          "b": { "$numberInt": "5" },
          "coll": "foo",
        }
      - {
          "_id": 1,
          "a": { "$numberInt": "5" },
          "b": { "$numberInt": "4" },
          "coll": "foo",
        }
    "_foo":
      - {
          "_id": 0,
          "a": { "$numberInt": "1" },
          "b": { "$numberInt": "2" },
          "coll": "_foo",
        }
      - {
          "_id": 1,
          "a": { "$numberInt": "2" },
          "b": { "$numberInt": "1" },
          "coll": "_foo",
        }
    "bar.baz":
      - {
          "_id": 0,
          "a": { "$numberInt": "1" },
          "b": { "$numberInt": "2" },
          "coll": "bar.baz",
        }
      - {
          "_id": 1,
          "a": { "$numberInt": "2" },
          "b": { "$numberInt": "1" },
          "coll": "bar.baz",
        }
    "bar":
      - {
          "_id": 0,
          "a": { "$numberInt": "1" },
          "b": { "$numberInt": "2" },
          "coll": "bar",
        }
      - {
          "_id": 1,
          "a": { "$numberInt": "2" },
          "b": { "$numberInt": "1" },
          "coll": "bar",
        }
    "boolz":
      - { "_id": 0, "a": true, "b": 1 }
      - { "_id": 1, "a": false, "b": 1 }

"catalog_schema":
  {
    "testquerydb":
      {
        "foo":
          {
            "bsonType": "object",
            "required": ["_id", "a", "b", "coll"],
            "additionalProperties": false,
            "properties":
              {
                "_id": { "bsonType": "int" },
                "a": { "bsonType": "int" },
                "b": { "bsonType": "int" },
                "coll": { "bsonType": "string" },
              },
          },
        "foo2":
          {
            "bsonType": "object",
            "required": ["_id", "a", "b", "coll"],
            "additionalProperties": false,
            "properties":
              {
                "_id": { "bsonType": "int" },
                "a": { "bsonType": "int" },
                "b": { "bsonType": "int" },
                "coll": { "bsonType": "string" },
              },
          },
        "_foo":
          {
            "bsonType": "object",
            "required": ["_id", "a", "b", "coll"],
            "additionalProperties": false,
            "properties":
              {
                "_id": { "bsonType": "int" },
                "a": { "bsonType": "int" },
                "b": { "bsonType": "int" },
                "coll": { "bsonType": "string" },
              },
          },
        "bar.baz":
          {
            "bsonType": "object",
            "required": ["_id", "a", "b", "coll"],
            "additionalProperties": false,
            "properties":
              {
                "_id": { "bsonType": "int" },
                "a": { "bsonType": "int" },
                "b": { "bsonType": "int" },
                "coll": { "bsonType": "string" },
              },
          },
        "bar":
          {
            "bsonType": "object",
            "required": ["_id", "a", "b", "coll"],
            "additionalProperties": false,
            "properties":
              {
                "_id": { "bsonType": "int" },
                "a": { "bsonType": "int" },
                "b": { "bsonType": "int" },
                "coll": { "bsonType": "string" },
              },
          },
        "boolz":
          {
            "bsonType": "object",
            "required": ["_id", "a", "b"],
            "additionalProperties": false,
            "properties":
              {
                "_id": { "bsonType": "int" },
                "a": { "bsonType": "bool" },
                "b": { "bsonType": "int" },
              },
          },
      },
  }

tests:
  - description: Can use $ and . characters in collection aliases
    query: "SELECT * FROM foo as `$foo.alias`"
    current_db: testquerydb
    result:
      - {
          "$foo.alias":
            {
              "_id": 0,
              "a": { "$numberInt": "1" },
              "b": { "$numberInt": "2" },
              "coll": "foo",
            },
        }
      - {
          "$foo.alias":
            {
              "_id": 1,
              "a": { "$numberInt": "2" },
              "b": { "$numberInt": "1" },
              "coll": "foo",
            },
        }

  - description: Can use $ and . characters in field aliases
    query: "SELECT VALUE { '$a.alias': a } FROM foo"
    current_db: testquerydb
    result:
      - { "": { "$a.alias": { "$numberInt": "1" } } }
      - { "": { "$a.alias": { "$numberInt": "2" } } }

  - description: Resolves conflicts for aliases with $ and .
    query: "SELECT * FROM `foo`, `bar.baz`, `_foo`, `bar`"
    current_db: testquerydb
    result:
      - {
          "foo":
            {
              "_id": { "$numberInt": "0" },
              "a": { "$numberInt": "1" },
              "b": { "$numberInt": "2" },
              "coll": "foo",
            },
          "_foo":
            {
              "_id": { "$numberInt": "0" },
              "a": { "$numberInt": "1" },
              "b": { "$numberInt": "2" },
              "coll": "_foo",
            },
          "bar":
            {
              "_id": { "$numberInt": "0" },
              "a": { "$numberInt": "1" },
              "b": { "$numberInt": "2" },
              "coll": "bar",
            },
          "bar.baz":
            {
              "_id": { "$numberInt": "0" },
              "a": { "$numberInt": "1" },
              "b": { "$numberInt": "2" },
              "coll": "bar.baz",
            },
        }

      - {
          "foo":
            {
              "_id": { "$numberInt": "0" },
              "a": { "$numberInt": "1" },
              "b": { "$numberInt": "2" },
              "coll": "foo",
            },
          "_foo":
            {
              "_id": { "$numberInt": "0" },
              "a": { "$numberInt": "1" },
              "b": { "$numberInt": "2" },
              "coll": "_foo",
            },
          "bar":
            {
              "_id": { "$numberInt": "1" },
              "a": { "$numberInt": "2" },
              "b": { "$numberInt": "1" },
              "coll": "bar",
            },
          "bar.baz":
            {
              "_id": { "$numberInt": "0" },
              "a": { "$numberInt": "1" },
              "b": { "$numberInt": "2" },
              "coll": "bar.baz",
            },
        }

      - {
          "foo":
            {
              "_id": { "$numberInt": "0" },
              "a": { "$numberInt": "1" },
              "b": { "$numberInt": "2" },
              "coll": "foo",
            },
          "_foo":
            {
              "_id": { "$numberInt": "1" },
              "a": { "$numberInt": "2" },
              "b": { "$numberInt": "1" },
              "coll": "_foo",
            },
          "bar":
            {
              "_id": { "$numberInt": "0" },
              "a": { "$numberInt": "1" },
              "b": { "$numberInt": "2" },
              "coll": "bar",
            },
          "bar.baz":
            {
              "_id": { "$numberInt": "0" },
              "a": { "$numberInt": "1" },
              "b": { "$numberInt": "2" },
              "coll": "bar.baz",
            },
        }

      - {
          "foo":
            {
              "_id": { "$numberInt": "0" },
              "a": { "$numberInt": "1" },
              "b": { "$numberInt": "2" },
              "coll": "foo",
            },
          "_foo":
            {
              "_id": { "$numberInt": "1" },
              "a": { "$numberInt": "2" },
              "b": { "$numberInt": "1" },
              "coll": "_foo",
            },
          "bar":
            {
              "_id": { "$numberInt": "1" },
              "a": { "$numberInt": "2" },
              "b": { "$numberInt": "1" },
              "coll": "bar",
            },
          "bar.baz":
            {
              "_id": { "$numberInt": "0" },
              "a": { "$numberInt": "1" },
              "b": { "$numberInt": "2" },
              "coll": "bar.baz",
            },
        }

      - {
          "foo":
            {
              "_id": { "$numberInt": "0" },
              "a": { "$numberInt": "1" },
              "b": { "$numberInt": "2" },
              "coll": "foo",
            },
          "_foo":
            {
              "_id": { "$numberInt": "0" },
              "a": { "$numberInt": "1" },
              "b": { "$numberInt": "2" },
              "coll": "_foo",
            },
          "bar":
            {
              "_id": { "$numberInt": "0" },
              "a": { "$numberInt": "1" },
              "b": { "$numberInt": "2" },
              "coll": "bar",
            },
          "bar.baz":
            {
              "_id": { "$numberInt": "1" },
              "a": { "$numberInt": "2" },
              "b": { "$numberInt": "1" },
              "coll": "bar.baz",
            },
        }

      - {
          "foo":
            {
              "_id": { "$numberInt": "0" },
              "a": { "$numberInt": "1" },
              "b": { "$numberInt": "2" },
              "coll": "foo",
            },
          "_foo":
            {
              "_id": { "$numberInt": "0" },
              "a": { "$numberInt": "1" },
              "b": { "$numberInt": "2" },
              "coll": "_foo",
            },
          "bar":
            {
              "_id": { "$numberInt": "1" },
              "a": { "$numberInt": "2" },
              "b": { "$numberInt": "1" },
              "coll": "bar",
            },
          "bar.baz":
            {
              "_id": { "$numberInt": "1" },
              "a": { "$numberInt": "2" },
              "b": { "$numberInt": "1" },
              "coll": "bar.baz",
            },
        }

      - {
          "foo":
            {
              "_id": { "$numberInt": "0" },
              "a": { "$numberInt": "1" },
              "b": { "$numberInt": "2" },
              "coll": "foo",
            },
          "_foo":
            {
              "_id": { "$numberInt": "1" },
              "a": { "$numberInt": "2" },
              "b": { "$numberInt": "1" },
              "coll": "_foo",
            },
          "bar":
            {
              "_id": { "$numberInt": "0" },
              "a": { "$numberInt": "1" },
              "b": { "$numberInt": "2" },
              "coll": "bar",
            },
          "bar.baz":
            {
              "_id": { "$numberInt": "1" },
              "a": { "$numberInt": "2" },
              "b": { "$numberInt": "1" },
              "coll": "bar.baz",
            },
        }

      - {
          "foo":
            {
              "_id": { "$numberInt": "0" },
              "a": { "$numberInt": "1" },
              "b": { "$numberInt": "2" },
              "coll": "foo",
            },
          "_foo":
            {
              "_id": { "$numberInt": "1" },
              "a": { "$numberInt": "2" },
              "b": { "$numberInt": "1" },
              "coll": "_foo",
            },
          "bar":
            {
              "_id": { "$numberInt": "1" },
              "a": { "$numberInt": "2" },
              "b": { "$numberInt": "1" },
              "coll": "bar",
            },
          "bar.baz":
            {
              "_id": { "$numberInt": "1" },
              "a": { "$numberInt": "2" },
              "b": { "$numberInt": "1" },
              "coll": "bar.baz",
            },
        }
      - {
          "foo":
            {
              "_id": { "$numberInt": "1" },
              "a": { "$numberInt": "2" },
              "b": { "$numberInt": "1" },
              "coll": "foo",
            },
          "_foo":
            {
              "_id": { "$numberInt": "0" },
              "a": { "$numberInt": "1" },
              "b": { "$numberInt": "2" },
              "coll": "_foo",
            },
          "bar":
            {
              "_id": { "$numberInt": "0" },
              "a": { "$numberInt": "1" },
              "b": { "$numberInt": "2" },
              "coll": "bar",
            },
          "bar.baz":
            {
              "_id": { "$numberInt": "0" },
              "a": { "$numberInt": "1" },
              "b": { "$numberInt": "2" },
              "coll": "bar.baz",
            },
        }
      - {
          "foo":
            {
              "_id": { "$numberInt": "1" },
              "a": { "$numberInt": "2" },
              "b": { "$numberInt": "1" },
              "coll": "foo",
            },
          "_foo":
            {
              "_id": { "$numberInt": "0" },
              "a": { "$numberInt": "1" },
              "b": { "$numberInt": "2" },
              "coll": "_foo",
            },
          "bar":
            {
              "_id": { "$numberInt": "1" },
              "a": { "$numberInt": "2" },
              "b": { "$numberInt": "1" },
              "coll": "bar",
            },
          "bar.baz":
            {
              "_id": { "$numberInt": "0" },
              "a": { "$numberInt": "1" },
              "b": { "$numberInt": "2" },
              "coll": "bar.baz",
            },
        }
      - {
          "foo":
            {
              "_id": { "$numberInt": "1" },
              "a": { "$numberInt": "2" },
              "b": { "$numberInt": "1" },
              "coll": "foo",
            },
          "_foo":
            {
              "_id": { "$numberInt": "1" },
              "a": { "$numberInt": "2" },
              "b": { "$numberInt": "1" },
              "coll": "_foo",
            },
          "bar":
            {
              "_id": { "$numberInt": "0" },
              "a": { "$numberInt": "1" },
              "b": { "$numberInt": "2" },
              "coll": "bar",
            },
          "bar.baz":
            {
              "_id": { "$numberInt": "0" },
              "a": { "$numberInt": "1" },
              "b": { "$numberInt": "2" },
              "coll": "bar.baz",
            },
        }
      - {
          "foo":
            {
              "_id": { "$numberInt": "1" },
              "a": { "$numberInt": "2" },
              "b": { "$numberInt": "1" },
              "coll": "foo",
            },
          "_foo":
            {
              "_id": { "$numberInt": "1" },
              "a": { "$numberInt": "2" },
              "b": { "$numberInt": "1" },
              "coll": "_foo",
            },
          "bar":
            {
              "_id": { "$numberInt": "1" },
              "a": { "$numberInt": "2" },
              "b": { "$numberInt": "1" },
              "coll": "bar",
            },
          "bar.baz":
            {
              "_id": { "$numberInt": "0" },
              "a": { "$numberInt": "1" },
              "b": { "$numberInt": "2" },
              "coll": "bar.baz",
            },
        }
      - {
          "foo":
            {
              "_id": { "$numberInt": "1" },
              "a": { "$numberInt": "2" },
              "b": { "$numberInt": "1" },
              "coll": "foo",
            },
          "_foo":
            {
              "_id": { "$numberInt": "0" },
              "a": { "$numberInt": "1" },
              "b": { "$numberInt": "2" },
              "coll": "_foo",
            },
          "bar":
            {
              "_id": { "$numberInt": "0" },
              "a": { "$numberInt": "1" },
              "b": { "$numberInt": "2" },
              "coll": "bar",
            },
          "bar.baz":
            {
              "_id": { "$numberInt": "1" },
              "a": { "$numberInt": "2" },
              "b": { "$numberInt": "1" },
              "coll": "bar.baz",
            },
        }
      - {
          "foo":
            {
              "_id": { "$numberInt": "1" },
              "a": { "$numberInt": "2" },
              "b": { "$numberInt": "1" },
              "coll": "foo",
            },
          "_foo":
            {
              "_id": { "$numberInt": "0" },
              "a": { "$numberInt": "1" },
              "b": { "$numberInt": "2" },
              "coll": "_foo",
            },
          "bar":
            {
              "_id": { "$numberInt": "1" },
              "a": { "$numberInt": "2" },
              "b": { "$numberInt": "1" },
              "coll": "bar",
            },
          "bar.baz":
            {
              "_id": { "$numberInt": "1" },
              "a": { "$numberInt": "2" },
              "b": { "$numberInt": "1" },
              "coll": "bar.baz",
            },
        }
      - {
          "foo":
            {
              "_id": { "$numberInt": "1" },
              "a": { "$numberInt": "2" },
              "b": { "$numberInt": "1" },
              "coll": "foo",
            },
          "_foo":
            {
              "_id": { "$numberInt": "1" },
              "a": { "$numberInt": "2" },
              "b": { "$numberInt": "1" },
              "coll": "_foo",
            },
          "bar":
            {
              "_id": { "$numberInt": "0" },
              "a": { "$numberInt": "1" },
              "b": { "$numberInt": "2" },
              "coll": "bar",
            },
          "bar.baz":
            {
              "_id": { "$numberInt": "1" },
              "a": { "$numberInt": "2" },
              "b": { "$numberInt": "1" },
              "coll": "bar.baz",
            },
        }
      - {
          "foo":
            {
              "_id": { "$numberInt": "1" },
              "a": { "$numberInt": "2" },
              "b": { "$numberInt": "1" },
              "coll": "foo",
            },
          "_foo":
            {
              "_id": { "$numberInt": "1" },
              "a": { "$numberInt": "2" },
              "b": { "$numberInt": "1" },
              "coll": "_foo",
            },
          "bar":
            {
              "_id": { "$numberInt": "1" },
              "a": { "$numberInt": "2" },
              "b": { "$numberInt": "1" },
              "coll": "bar",
            },
          "bar.baz":
            {
              "_id": { "$numberInt": "1" },
              "a": { "$numberInt": "2" },
              "b": { "$numberInt": "1" },
              "coll": "bar.baz",
            },
        }

  - description: Can use aliases in on when defined in subselects
    query: "SELECT t1.*, t2.* FROM (SELECT * FROM foo AS t1) AS t1 JOIN (SELECT * FROM bar AS t2) as t2 ON t1.a = t2.b"
    current_db: testquerydb
    result:
      - {
          "t1":
            {
              "_id": 0,
              "a": { "$numberInt": "1" },
              "b": { "$numberInt": "2" },
              "coll": "foo",
            },
          "t2":
            {
              "_id": 1,
              "a": { "$numberInt": "2" },
              "b": { "$numberInt": "1" },
              "coll": "bar",
            },
        }
      - {
          "t1":
            {
              "_id": 1,
              "a": { "$numberInt": "2" },
              "b": { "$numberInt": "1" },
              "coll": "foo",
            },
          "t2":
            {
              "_id": 0,
              "a": { "$numberInt": "1" },
              "b": { "$numberInt": "2" },
              "coll": "bar",
            },
        }

  - description: Can compare bool column to literal value
    query: "SELECT * from boolz where a = 1"
    current_db: testquerydb
    result:
      - {
          "boolz": {
            "_id": 0,
            "a": true,
            "b": { "$numberInt": "1" },
          }
        }

  - description: Can still compare numerics
    query: "SELECT * from boolz where b = 1"
    current_db: testquerydb
    result:
      - { "boolz": { "_id": 0, "a": true, b: 1 } }
      - { "boolz": { "_id": 1, "a": false, b: 1 } }

  - description: Select with multiple bottom works
    query: "SELECT foo.a, bar.*, foo.b from foo, bar"
    current_db: testquerydb
    result:
      - { "bar": { "_id": 0, "a": 1, "b": 2, "coll": "bar" }, "": { "a": 1, "b": 2 } }
      - { "bar": { "_id": 1, "a": 2, "b": 1, "coll": "bar" }, "": { "a": 1, "b": 2 } }
      - { "bar": { "_id": 0, "a": 1, "b": 2, "coll": "bar" }, "": { "a": 2, "b": 1 } }
      - { "bar": { "_id": 1, "a": 2, "b": 1, "coll": "bar" }, "": { "a": 2, "b": 1 } }

  - description: Select pulls colls from proper collections
    query: "SELECT foo.a, foo2.b from foo, foo2"
    current_db: testquerydb
    result:
      - { "": { "a": 1, "b": 4 } }
      - { "": { "a": 1, "b": 5 } }
      - { "": { "a": 2, "b": 4 } }
      - { "": { "a": 2, "b": 5 } }
