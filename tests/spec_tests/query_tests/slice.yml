catalog_environment:
  {
    'foo': {
      'bar': [
      {
        'arr': [1, 2, 3],
        'len': -1,
        'd': 2.3,
        'i': 2
      }
      ]
    }
  }

schema_environment:
  {
    'foo': {
      'bar': {
        '$jsonSchema': {
          'bsonType': "object",
          'properties': {
            'd': {
              'bsonType': "double"
            },
            'i': {
              'bsonType': "int"
            },
          }
        }
      }
    }
  }

tests:
  - description: Length = 0, no start
    current_db: foo
    query: "SELECT SLICE(arr, 0) AS slice FROM bar"
    result:
      - {"slice": []}

  - description: Length = 0, start = 0
    current_db: foo
    query: "SELECT SLICE(arr, 0, 0) AS slice FROM bar"
    result:
      - {"slice": []}

  - description: Length = 0, start > 0
    current_db: foo
    query: "SELECT SLICE(arr, 1, 0) AS slice FROM bar"
    result:
      - {"slice": []}

  - description: Length = 0, start < 0
    current_db: foo
    query: "SELECT SLICE(arr, -1, 0) AS slice FROM bar"
    result:
      - {"slice": []}

  - description: 0 < length < len(arr), no start
    current_db: foo
    query: "SELECT SLICE(arr, 2) AS slice FROM bar"
    result:
      - {"slice": [1, 2]}

  - description: 0 < length < len(arr), start = 0
    current_db: foo
    query: "SELECT SLICE(arr, 0, 2) AS slice FROM bar"
    result:
      - {"slice": [1, 2]}

  - description: 0 < length < len(arr), start > 0, length + start <= len(arr)
    current_db: foo
    query: "SELECT SLICE(arr, 1, 2) AS slice FROM bar"
    result:
      - {"slice": [2, 3]}

  - description: 0 < length < len(arr), start > 0, length + start > len(arr)
    current_db: foo
    query: "SELECT SLICE(arr, 2, 2) AS slice FROM bar"
    result:
      - {"slice": [3]}

  - description: 0 < length < len(arr), start < 0
    current_db: foo
    query: "SELECT SLICE(arr, -2, 2) AS slice FROM bar"
    result:
      - {"slice": [2, 3]}

  - description: 0 < length < len(arr), start < 0, abs(start) > len(arr)
    current_db: foo
    query: "SELECT SLICE(arr, -4, 2) AS slice FROM bar"
    result:
      - {"slice": [1, 2]}

  - description: length = len(arr), no start
    current_db: foo
    query: "SELECT SLICE(arr, 3) AS slice FROM bar"
    result:
      - {"slice": [1, 2, 3]}

  - description: length = len(arr), start = 0
    current_db: foo
    query: "SELECT SLICE(arr, 0, 3) AS slice FROM bar"
    result:
      - {"slice": [1, 2, 3]}

  - description: length = len(arr), start > 0
    current_db: foo
    query: "SELECT SLICE(arr, 2, 3) AS slice FROM bar"
    result:
      - {"slice": [3]}

  - description: length = len(arr), start > 0
    current_db: foo
    query: "SELECT SLICE(arr, -1, 3) AS slice FROM bar"
    result:
      - {"slice": [3]}

  - description: length > len(arr), no start
    current_db: foo
    query: "SELECT SLICE(arr, 4) AS slice FROM bar"
    result:
      - {"slice": [1, 2, 3]}

  - description: length > len(arr), start = 0
    current_db: foo
    query: "SELECT SLICE(arr, 0, 4) AS slice FROM bar"
    result:
      - {"slice": [1, 2, 3]}

  - description: length > len(arr), start > 0
    current_db: foo
    query: "SELECT SLICE(arr, 1, 4) AS slice FROM bar"
    result:
      - {"slice": [2, 3]}

  - description: length > len(arr), start < 0
    current_db: foo
    query: "SELECT SLICE(arr, -3, 4) AS slice FROM bar"
    result:
      - {"slice": [1, 2, 3]}

  - description: length < 0, no start
    current_db: foo
    query: "SELECT SLICE(arr, -2) AS slice FROM bar"
    result:
      - {"slice": [2, 3]}

  - description: Invalid - length < 0, start = 0
    current_db: foo
    query: "SELECT SLICE(arr, 0, -2) AS slice FROM bar"
    result:
      - {"slice": null}

  - description: Invalid - length < 0, start > 0
    current_db: foo
    query: "SELECT SLICE(arr, 1, -2) AS slice FROM bar"
    result:
      - {"slice": null}

  - description: Invalid - length < 0, start < 0
    current_db: foo
    query: "SELECT SLICE(arr, -1, -2) AS slice FROM bar"
    result:
      - {"slice": null}

  - description: Invalid - length < 0 at runtime when start is provided
    current_db: foo
    query: "SELECT SLICE(arr, 1, len) AS slice FROM bar"
      result:
        - {"slice": null}

  - description: Int column for arguments
    current_db: foo
    query: "SELECT SLICE(arr, i, i) AS slice FROM bar"
    result:
      - {"slice": [3]}

  - description: CAST double column to int for arguments
    current_db: foo
    query: "SELECT SLICE(arr, CAST(d AS INT), CAST(d AS INT)) AS slice FROM bar"
    result:
      - {"slice": [3]}

  - description: length is null
    current_db: foo
    query: "SELECT SLICE(arr, NULL) AS slice FROM bar"
      result:
        - {"slice": null}

  - description: length is missing
    current_db: foo
    query: "SELECT length, SLICE(arr, length) AS slice FROM bar"
      result:
        - {"slice": null}

  - description: start is null
    current_db: foo
    query: "SELECT SLICE(arr, NULL, 2) AS slice FROM bar"
      result:
        - {"slice": null}

  - description: start is missing
    current_db: foo
    query: "SELECT start, SLICE(arr, start, 2) AS slice FROM bar"
      result:
        - {"slice": null}
