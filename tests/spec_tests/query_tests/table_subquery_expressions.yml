catalog_data:
  foo:
    bar:
      - {'_id': 1, 'v': 1}
      - {'_id': 2, 'v': 2}
      - {'_id': 3, 'v': 3}
      - {'_id': 4, 'v': 4}
      - {'_id': 5, 'v': null}
      - {'_id': 6}
    target:
      - {'_id': 1, 'a': 2}
      - {'_id': 2, 'a': 3}
      - {'_id': 3, 'a': null}

catalog_schema:
  {
    'foo': {
      'bar': {
        'bsonType': "object",
        'required': [ '_id', 'v' ],
        'additionalProperties': false,
        'properties': {
          '_id': {
            'bsonType': "int"
          },
          'v': {
            'anyOf': [
              { 'bsonType': "int" },
              { 'bsonType': !!str "null" }
            ]
          }
        },
      },
      'target': {
        'bsonType': "object",
        'required': [ 'id', 'a' ],
        'additionalProperties': false,
        'properties': {
          '_id': {
            'bsonType': "int"
          },
          'a': {
            'anyOf': [
              { 'bsonType': "int" },
              { 'bsonType': !!str "null" }
            ]
          }
        },
      }
    }
  }

tests:
  - description: correctness test for eq ANY Operator without NULL in subquery result
    current_db: foo
    query: "SELECT * FROM bar AS bar WHERE v = ANY(SELECT a FROM target AS target WHERE NOT(a IS NULL))"
    skip_reason: "SQL-578"
    translation_target_db: foo
    translation_target_coll: bar
    translation:
      - {'$project': {'_id': 0, 'bar': '$$ROOT'}}
      - {'$project': {'_id': 0, 'bar': '$bar'}}
      - {'$match': {'$expr': {'$subqueryComparison': {
                                                       'op': 'eq',
                                                       'modifier': 'any',
                                                       'arg': '$bar.v',
                                                       'subquery': {
                                                                     'db': 'foo',
                                                                     'collection': 'target',
                                                                     'let': {'bar_0': '$bar'},
                                                                     'outputPath': ['__bot', 'a'],
                                                                     'pipeline': [
                                                                                   {'$project': {'_id': 0, 'target': '$$ROOT'}},
                                                                                   {'$project': {'_id': 0, 'target': '$target'}},
                                                                                   {'$match': {'$expr': {'$sqlNot': [{'$or': [{'$eq': [{'$type': '$target.a'}, 'null']}, {'$eq': [{'$type': '$target.a'}, 'missing']}]}]}}},
                                                                                   {'$project': {'_id': 0, '__bot': {'a': '$target.a'}}}
                                                                     ]
                                                       }
      }}}}
    result:
      - {'bar': {'_id': 2, 'v': 2}}
      - {'bar': {'_id': 3, 'v': 3}}

  - description: correctness test for eq ANY Operator with NULL in subquery result
    current_db: foo
    query: "SELECT * FROM bar AS bar WHERE v = ANY(SELECT a FROM target AS target)"
    skip_reason: "SQL-578"
    translation_target_db: foo
    translation_target_coll: bar
    translation:
      - {'$project': {'_id': 0, 'bar': '$$ROOT'}}
      - {'$project': {'_id': 0, 'bar': '$bar'}}
      - {'$match': {'$expr': {'$subqueryComparison': {
                                                       'op': 'eq',
                                                       'modifier': 'any',
                                                       'arg': '$bar.v',
                                                       'subquery': {
                                                                     'db': 'foo',
                                                                     'collection': 'target',
                                                                     'let': {'bar_0': '$bar'},
                                                                     'outputPath': ['__bot', 'a'],
                                                                     'pipeline': [
                                                                                   {'$project': {'_id': 0, 'target': '$$ROOT'}},
                                                                                   {'$project': {'_id': 0, 'target': '$target'}},
                                                                                   {'$project': {'_id': 0, '__bot': {'a': '$target.a'}}}
                                                                     ]
                                                       }
      }}}}
    result:
      - {'bar': {'_id': 2, 'v': 2}}
      - {'bar': {'_id': 3, 'v': 3}}

  - description: correctness test for neq ANY Operator without NULL in subquery result
    current_db: foo
    query: "SELECT * FROM bar AS bar WHERE v <> ANY(SELECT a FROM target AS target WHERE NOT(a IS NULL))"
    skip_reason: "SQL-578"
    translation_target_db: foo
    translation_target_coll: bar
    translation:
      - {'$project': {'_id': 0, 'bar': '$$ROOT'}}
      - {'$project': {'_id': 0, 'bar': '$bar'}}
      - {'$match': {'$expr': {'$subqueryComparison': {
                                                       'op': 'ne',
                                                       'modifier': 'any',
                                                       'arg': '$bar.v',
                                                       'subquery': {
                                                                     'db': 'foo',
                                                                     'collection': 'target',
                                                                     'let': {'bar_0': '$bar'},
                                                                     'outputPath': ['__bot', 'a'],
                                                                     'pipeline': [
                                                                                   {'$project': {'_id': 0, 'target': '$$ROOT'}},
                                                                                   {'$project': {'_id': 0, 'target': '$target'}},
                                                                                   {'$match': {'$expr': {'$sqlNot': [{'$or': [{'$eq': [{'$type': '$target.a'}, 'null']}, {'$eq': [{'$type': '$target.a'}, 'missing']}]}]}}},
                                                                                   {'$project': {'_id': 0, '__bot': {'a': '$target.a'}}}
                                                                     ]
                                                       }
      }}}}
    result:
      - {'bar': {'_id': 1, 'v': 1}}
      - {'bar': {'_id': 2, 'v': 2}}
      - {'bar': {'_id': 3, 'v': 3}}
      - {'bar': {'_id': 4, 'v': 4}}

  - description: correctness test for neq ANY Operator with NULL in subquery result
    current_db: foo
    query: "SELECT * FROM bar AS bar WHERE v <> ANY(SELECT a FROM target)"
    skip_reason: "SQL-578"
    translation_target_db: foo
    translation_target_coll: bar
    translation:
      - {'$project': {'_id': 0, 'bar': '$$ROOT'}}
      - {'$project': {'_id': 0, 'bar': '$bar'}}
      - {'$match': {'$expr': {'$subqueryComparison': {
                                                       'op': 'ne',
                                                       'modifier': 'any',
                                                       'arg': '$bar.v',
                                                       'subquery': {
                                                                     'db': 'foo',
                                                                     'collection': 'target',
                                                                     'let': {'bar_0': '$bar'},
                                                                     'outputPath': ['__bot', 'a'],
                                                                     'pipeline': [
                                                                                   {'$project': {'_id': 0, 'target': '$$ROOT'}},
                                                                                   {'$project': {'_id': 0, 'target': '$target'}},
                                                                                   {'$project': {'_id': 0, '__bot': {'a': '$target.a'}}}
                                                                     ]
                                                       }
      }}}}
    result:
      - {'bar': {'_id': 1, 'v': 1}}
      - {'bar': {'_id': 2, 'v': 2}}
      - {'bar': {'_id': 3, 'v': 3}}
      - {'bar': {'_id': 4, 'v': 4}}

  - description: correctness test for lt ANY Operator without NULL in subquery result
    current_db: foo
    query: "SELECT * FROM bar AS bar WHERE v < ANY(SELECT a FROM target AS target WHERE NOT(a IS NULL))"
    skip_reason: "SQL-578"
    translation_target_db: foo
    translation_target_coll: bar
    translation:
      - {'$project': {'_id': 0, 'bar': '$$ROOT'}}
      - {'$project': {'_id': 0, 'bar': '$bar'}}
      - {'$match': {'$expr': {'$subqueryComparison': {
                                                       'op': 'lt',
                                                       'modifier': 'any',
                                                       'arg': '$bar.v',
                                                       'subquery': {
                                                                     'db': 'foo',
                                                                     'collection': 'target',
                                                                     'let': {'bar_0': '$bar'},
                                                                     'outputPath': ['__bot', 'a'],
                                                                     'pipeline': [
                                                                                   {'$project': {'_id': 0, 'target': '$$ROOT'}},
                                                                                   {'$project': {'_id': 0, 'target': '$target'}},
                                                                                   {'$match': {'$expr': {'$sqlNot': [{'$or': [{'$eq': [{'$type': '$target.a'}, 'null']}, {'$eq': [{'$type': '$target.a'}, 'missing']}]}]}}},
                                                                                   {'$project': {'_id': 0, '__bot': {'a': '$target.a'}}}
                                                                     ]
                                                       }
      }}}}
    result:
      - {'bar': {'_id': 1, 'v': 1}}
      - {'bar': {'_id': 2, 'v': 2}}

  - description: correctness test for lt ANY Operator with NULL in subquery result
    current_db: foo
    query: "SELECT * FROM bar AS bar WHERE v < ANY(SELECT a FROM target)"
    skip_reason: "SQL-578"
    translation_target_db: foo
    translation_target_coll: bar
    translation:
      - {'$project': {'_id': 0, 'bar': '$$ROOT'}}
      - {'$project': {'_id': 0, 'bar': '$bar'}}
      - {'$match': {'$expr': {'$subqueryComparison': {
                                                       'op': 'lt',
                                                       'modifier': 'any',
                                                       'arg': '$bar.v',
                                                       'subquery': {
                                                                     'db': 'foo',
                                                                     'collection': 'target',
                                                                     'let': {'bar_0': '$bar'},
                                                                     'outputPath': ['__bot', 'a'],
                                                                     'pipeline': [
                                                                                   {'$project': {'_id': 0, 'target': '$$ROOT'}},
                                                                                   {'$project': {'_id': 0, 'target': '$target'}},
                                                                                   {'$project': {'_id': 0, '__bot': {'a': '$target.a'}}}
                                                                     ]
                                                       }
      }}}}
    result:
      - {'bar': {'_id': 1, 'v': 1}}
      - {'bar': {'_id': 2, 'v': 2}}

  - description: correctness test for lte ANY Operator without NULL in subquery result
    current_db: foo
    query: "SELECT * FROM bar AS bar WHERE v <= ANY(SELECT a FROM target AS target WHERE NOT(a IS NULL))"
    skip_reason: "SQL-578"
    translation_target_db: foo
    translation_target_coll: bar
    translation:
      - {'$project': {'_id': 0, 'bar': '$$ROOT'}}
      - {'$project': {'_id': 0, 'bar': '$bar'}}
      - {'$match': {'$expr': {'$subqueryComparison': {
                                                       'op': 'lte',
                                                       'modifier': 'any',
                                                       'arg': '$bar.v',
                                                       'subquery': {
                                                                     'db': 'foo',
                                                                     'collection': 'target',
                                                                     'let': {'bar_0': '$bar'},
                                                                     'outputPath': ['__bot', 'a'],
                                                                     'pipeline': [
                                                                                   {'$project': {'_id': 0, 'target': '$$ROOT'}},
                                                                                   {'$project': {'_id': 0, 'target': '$target'}},
                                                                                   {'$match': {'$expr': {'$sqlNot': [{'$or': [{'$eq': [{'$type': '$target.a'}, 'null']}, {'$eq': [{'$type': '$target.a'}, 'missing']}]}]}}},
                                                                                   {'$project': {'_id': 0, '__bot': {'a': '$target.a'}}}
                                                                     ]
                                                       }
      }}}}
    result:
      - {'bar': {'_id': 1, 'v': 1}}
      - {'bar': {'_id': 2, 'v': 2}}
      - {'bar': {'_id': 3, 'v': 3}}

  - description: correctness test for lte ANY Operator with NULL in subquery result
    current_db: foo
    query: "SELECT * FROM bar AS bar WHERE v <= ANY(SELECT a FROM target)"
    skip_reason: "SQL-578"
    translation_target_db: foo
    translation_target_coll: bar
    translation:
      - {'$project': {'_id': 0, 'bar': '$$ROOT'}}
      - {'$project': {'_id': 0, 'bar': '$bar'}}
      - {'$match': {'$expr': {'$subqueryComparison': {
                                                       'op': 'lte',
                                                       'modifier': 'any',
                                                       'arg': '$bar.v',
                                                       'subquery': {
                                                                     'db': 'foo',
                                                                     'collection': 'target',
                                                                     'let': {'bar_0': '$bar'},
                                                                     'outputPath': ['__bot', 'a'],
                                                                     'pipeline': [
                                                                                   {'$project': {'_id': 0, 'target': '$$ROOT'}},
                                                                                   {'$project': {'_id': 0, 'target': '$target'}},
                                                                                   {'$project': {'_id': 0, '__bot': {'a': '$target.a'}}}
                                                                     ]
                                                       }
      }}}}
    result:
      - {'bar': {'_id': 1, 'v': 1}}
      - {'bar': {'_id': 2, 'v': 2}}
      - {'bar': {'_id': 3, 'v': 3}}

  - description: correctness test for gt ANY Operator without NULL in subquery result
    current_db: foo
    query: "SELECT * FROM bar AS bar WHERE v > ANY(SELECT a FROM target AS target WHERE NOT(a IS NULL))"
    skip_reason: "SQL-578"
    translation_target_db: foo
    translation_target_coll: bar
    translation:
      - {'$project': {'_id': 0, 'bar': '$$ROOT'}}
      - {'$project': {'_id': 0, 'bar': '$bar'}}
      - {'$match': {'$expr': {'$subqueryComparison': {
                                                       'op': 'gt',
                                                       'modifier': 'any',
                                                       'arg': '$bar.v',
                                                       'subquery': {
                                                                     'db': 'foo',
                                                                     'collection': 'target',
                                                                     'let': {'bar_0': '$bar'},
                                                                     'outputPath': ['__bot', 'a'],
                                                                     'pipeline': [
                                                                                   {'$project': {'_id': 0, 'target': '$$ROOT'}},
                                                                                   {'$project': {'_id': 0, 'target': '$target'}},
                                                                                   {'$match': {'$expr': {'$sqlNot': [{'$or': [{'$eq': [{'$type': '$target.a'}, 'null']}, {'$eq': [{'$type': '$target.a'}, 'missing']}]}]}}},
                                                                                   {'$project': {'_id': 0, '__bot': {'a': '$target.a'}}}
                                                                     ]
                                                       }
      }}}}
    result:
      - {'bar': {'_id': 3, 'v': 3}}
      - {'bar': {'_id': 4, 'v': 4}}

  - description: correctness test for gt ANY Operator with NULL in subquery result
    current_db: foo
    query: "SELECT * FROM bar AS bar WHERE v > ANY(SELECT a FROM target)"
    skip_reason: "SQL-578"
    translation_target_db: foo
    translation_target_coll: bar
    translation:
      - {'$project': {'_id': 0, 'bar': '$$ROOT'}}
      - {'$project': {'_id': 0, 'bar': '$bar'}}
      - {'$match': {'$expr': {'$subqueryComparison': {
                                                       'op': 'gt',
                                                       'modifier': 'any',
                                                       'arg': '$bar.v',
                                                       'subquery': {
                                                                     'db': 'foo',
                                                                     'collection': 'target',
                                                                     'let': {'bar_0': '$bar'},
                                                                     'outputPath': ['__bot', 'a'],
                                                                     'pipeline': [
                                                                                   {'$project': {'_id': 0, 'target': '$$ROOT'}},
                                                                                   {'$project': {'_id': 0, 'target': '$target'}},
                                                                                   {'$project': {'_id': 0, '__bot': {'a': '$target.a'}}}
                                                                     ]
                                                       }
      }}}}
    result:
      - {'bar': {'_id': 3, 'v': 3}}
      - {'bar': {'_id': 4, 'v': 4}}

  - description: correctness test for gte ANY Operator without NULL in subquery result
    current_db: foo
    query: "SELECT * FROM bar AS bar WHERE v >= ANY(SELECT a FROM target AS target WHERE NOT(a IS NULL))"
    skip_reason: "SQL-578"
    translation_target_db: foo
    translation_target_coll: bar
    translation:
      - {'$project': {'_id': 0, 'bar': '$$ROOT'}}
      - {'$project': {'_id': 0, 'bar': '$bar'}}
      - {'$match': {'$expr': {'$subqueryComparison': {
                                                       'op': 'gte',
                                                       'modifier': 'any',
                                                       'arg': '$bar.v',
                                                       'subquery': {
                                                                     'db': 'foo',
                                                                     'collection': 'target',
                                                                     'let': {'bar_0': '$bar'},
                                                                     'outputPath': ['__bot', 'a'],
                                                                     'pipeline': [
                                                                                   {'$project': {'_id': 0, 'target': '$$ROOT'}},
                                                                                   {'$project': {'_id': 0, 'target': '$target'}},
                                                                                   {'$match': {'$expr': {'$sqlNot': [{'$or': [{'$eq': [{'$type': '$target.a'}, 'null']}, {'$eq': [{'$type': '$target.a'}, 'missing']}]}]}}},
                                                                                   {'$project': {'_id': 0, '__bot': {'a': '$target.a'}}}
                                                                     ]
                                                       }
      }}}}
    result:
      - {'bar': {'_id': 2, 'v': 2}}
      - {'bar': {'_id': 3, 'v': 3}}
      - {'bar': {'_id': 4, 'v': 4}}

  - description: correctness test for gte ANY Operator with NULL in subquery result
    current_db: foo
    query: "SELECT * FROM bar AS bar WHERE v >= ANY(SELECT a FROM target)"
    skip_reason: "SQL-578"
    translation_target_db: foo
    translation_target_coll: bar
    translation:
      - {'$project': {'_id': 0, 'bar': '$$ROOT'}}
      - {'$project': {'_id': 0, 'bar': '$bar'}}
      - {'$match': {'$expr': {'$subqueryComparison': {
                                                       'op': 'gte',
                                                       'modifier': 'any',
                                                       'arg': '$bar.v',
                                                       'subquery': {
                                                                     'db': 'foo',
                                                                     'collection': 'target',
                                                                     'let': {'bar_0': '$bar'},
                                                                     'outputPath': ['__bot', 'a'],
                                                                     'pipeline': [
                                                                                   {'$project': {'_id': 0, 'target': '$$ROOT'}},
                                                                                   {'$project': {'_id': 0, 'target': '$target'}},
                                                                                   {'$project': {'_id': 0, '__bot': {'a': '$target.a'}}}
                                                                     ]
                                                       }
      }}}}
    result:
      - {'bar': {'_id': 2, 'v': 2}}
      - {'bar': {'_id': 3, 'v': 3}}
      - {'bar': {'_id': 4, 'v': 4}}

  - description: correctness test for eq ALL Operator without NULL in subquery result
    current_db: foo
    query: "SELECT * FROM bar AS bar WHERE v = ALL(SELECT a FROM target AS target WHERE NOT(a IS NULL))"
    translation_target_db: foo
    translation_target_coll: bar
    translation:
      - {'$project': {'_id': 0, 'bar': '$$ROOT'}}
      - {'$project': {'_id': 0, 'bar': '$bar'}}
      - {'$match': {'$expr': {'$subqueryComparison': {
                                                       'op': 'eq',
                                                       'modifier': 'all',
                                                       'arg': '$bar.v',
                                                       'subquery': {
                                                                     'db': 'foo',
                                                                     'collection': 'target',
                                                                     'let': {'bar_0': '$bar'},
                                                                     'outputPath': ['__bot', 'a'],
                                                                     'pipeline': [
                                                                                   {'$project': {'_id': 0, 'target': '$$ROOT'}},
                                                                                   {'$project': {'_id': 0, 'target': '$target'}},
                                                                                   {'$match': {'$expr': {'$sqlNot': [{'$or': [{'$eq': [{'$type': '$target.a'}, 'null']}, {'$eq': [{'$type': '$target.a'}, 'missing']}]}]}}},
                                                                                   {'$project': {'_id': 0, '__bot': {'a': '$target.a'}}}
                                                                     ]
                                                       }
      }}}}
    result: []

  - description: correctness test for eq ALL Operator with NULL in subquery result
    current_db: foo
    query: "SELECT * FROM bar AS bar WHERE v = ALL(SELECT a FROM target)"
    translation_target_db: foo
    translation_target_coll: bar
    translation:
      - {'$project': {'_id': 0, 'bar': '$$ROOT'}}
      - {'$project': {'_id': 0, 'bar': '$bar'}}
      - {'$match': {'$expr': {'$subqueryComparison': {
                                                       'op': 'eq',
                                                       'modifier': 'all',
                                                       'arg': '$bar.v',
                                                       'subquery': {
                                                                     'db': 'foo',
                                                                     'collection': 'target',
                                                                     'let': {'bar_0': '$bar'},
                                                                     'outputPath': ['__bot', 'a'],
                                                                     'pipeline': [
                                                                                   {'$project': {'_id': 0, 'target': '$$ROOT'}},
                                                                                   {'$project': {'_id': 0, 'target': '$target'}},
                                                                                   {'$project': {'_id': 0, '__bot': {'a': '$target.a'}}}
                                                                     ]
                                                       }
      }}}}
    result: []

  - description: correctness test for eq ALL Operator with matching result
    current_db: foo
    query: "SELECT * FROM bar AS bar WHERE v = ALL(SELECT a FROM target AS target WHERE a = 2)"
    skip_reason: "SQL-578"
    translation_target_db: foo
    translation_target_coll: bar
    translation:
      - {'$project': {'_id': 0, 'bar': '$$ROOT'}}
      - {'$project': {'_id': 0, 'bar': '$bar'}}
      - {'$match': {'$expr': {'$subqueryComparison': {
                                                       'op': 'eq',
                                                       'modifier': 'all',
                                                       'arg': '$bar.v',
                                                       'subquery': {
                                                                     'db': 'foo',
                                                                     'collection': 'target',
                                                                     'let': {'bar_0': '$bar'},
                                                                     'outputPath': ['__bot', 'a'],
                                                                     'pipeline': [
                                                                                   {'$project': {'_id': 0, 'target': '$$ROOT'}},
                                                                                   {'$project': {'_id': 0, 'target': '$target'}},
                                                                                   {'$match': {'$expr': {'$sqlEq': ['$target.a', {'$literal': 2}]}}},
                                                                                   {'$project': {'_id': 0, '__bot': {'a': '$target.a'}}}
                                                                     ]
                                                       }
      }}}}
    result:
      - {'bar': {'_id': 1, 'a': 2}}

  - description: ALL comparisons are vacuously true when subquery returns no results
    current_db: foo
    query: "SELECT * FROM bar AS bar WHERE v = ALL(SELECT a FROM target AS target WHERE false)"
    skip_reason: "SQL-578"
    translation_target_db: foo
    translation_target_coll: bar
    translation:
      - {'$project': {'_id': 0, 'bar': '$$ROOT'}}
      - {'$project': {'_id': 0, 'bar': '$bar'}}
      - {'$match': {'$expr': {'$subqueryComparison': {
        'op': 'eq',
        'modifier': 'all',
        'arg': '$bar.v',
        'subquery': {
          'db': 'foo',
          'collection': 'target',
          'let': {'bar_0': '$bar'},
          'outputPath': ['__bot', 'a'],
          'pipeline': [
            {'$project': {'_id': 0, 'target': '$$ROOT'}},
            {'$project': {'_id': 0, 'target': '$target'}},
            {'$match': {'$expr': {'$literal': false}}},
            {'$project': {'_id': 0, '__bot': {'a': '$target.a'}}}
          ]
        }
      }}}}
    result:
      - {'_id': 1, 'v': 1}
      - {'_id': 2, 'v': 2}
      - {'_id': 3, 'v': 3}
      - {'_id': 4, 'v': 4}
      - {'_id': 5, 'v': null}
      - {'_id': 6}

  - description: ANY comparisons are vacuously false when subquery returns no results
    current_db: foo
    query: "SELECT * FROM bar AS bar WHERE v = ANY(SELECT a FROM target AS target WHERE false)"
    translation_target_db: foo
    translation_target_coll: bar
    translation:
      - {'$project': {'_id': 0, 'bar': '$$ROOT'}}
      - {'$project': {'_id': 0, 'bar': '$bar'}}
      - {'$match': {'$expr': {'$subqueryComparison': {
        'op': 'eq',
        'modifier': 'any',
        'arg': '$bar.v',
        'subquery': {
          'db': 'foo',
          'collection': 'target',
          'let': {'bar_0': '$bar'},
          'outputPath': ['__bot', 'a'],
          'pipeline': [
            {'$project': {'_id': 0, 'target': '$$ROOT'}},
            {'$project': {'_id': 0, 'target': '$target'}},
            {'$match': {'$expr': {'$literal': false}}},
            {'$project': {'_id': 0, '__bot': {'a': '$target.a'}}}
          ]
        }
      }}}}
    result: []

  - description: correctness test for neq ALL Operator without NULL in subquery result
    current_db: foo
    query: "SELECT * FROM bar AS bar WHERE v <> ALL(SELECT a FROM target AS target WHERE NOT(a IS NULL))"
    skip_reason: "SQL-578"
    translation_target_db: foo
    translation_target_coll: bar
    translation:
      - {'$project': {'_id': 0, 'bar': '$$ROOT'}}
      - {'$project': {'_id': 0, 'bar': '$bar'}}
      - {'$match': {'$expr': {'$subqueryComparison': {
                                                       'op': 'ne',
                                                       'modifier': 'all',
                                                       'arg': '$bar.v',
                                                       'subquery': {
                                                                     'db': 'foo',
                                                                     'collection': 'target',
                                                                     'let': {'bar_0': '$bar'},
                                                                     'outputPath': ['__bot', 'a'],
                                                                     'pipeline': [
                                                                                   {'$project': {'_id': 0, 'target': '$$ROOT'}},
                                                                                   {'$project': {'_id': 0, 'target': '$target'}},
                                                                                   {'$match': {'$expr': {'$sqlNot': [{'$or': [{'$eq': [{'$type': '$target.a'}, 'null']}, {'$eq': [{'$type': '$target.a'}, 'missing']}]}]}}},
                                                                                   {'$project': {'_id': 0, '__bot': {'a': '$target.a'}}}
                                                                     ]
                                                       }
      }}}}
    result:
      - {'bar': {'_id': 1, 'v': 1}}
      - {'bar': {'_id': 4, 'v': 4}}

  - description: correctness test for neq ALL Operator with NULL in subquery result
    current_db: foo
    query: "SELECT * FROM bar AS bar WHERE v <> ALL(SELECT a FROM target)"
    translation_target_db: foo
    translation_target_coll: bar
    translation:
      - {'$project': {'_id': 0, 'bar': '$$ROOT'}}
      - {'$project': {'_id': 0, 'bar': '$bar'}}
      - {'$match': {'$expr': {'$subqueryComparison': {
                                                       'op': 'ne',
                                                       'modifier': 'all',
                                                       'arg': '$bar.v',
                                                       'subquery': {
                                                                     'db': 'foo',
                                                                     'collection': 'target',
                                                                     'let': {'bar_0': '$bar'},
                                                                     'outputPath': ['__bot', 'a'],
                                                                     'pipeline': [
                                                                                   {'$project': {'_id': 0, 'target': '$$ROOT'}},
                                                                                   {'$project': {'_id': 0, 'target': '$target'}},
                                                                                   {'$project': {'_id': 0, '__bot': {'a': '$target.a'}}}
                                                                     ]
                                                       }
      }}}}
    result: []

  - description: correctness test for lt ALL Operator without NULL in subquery result
    current_db: foo
    query: "SELECT * FROM bar AS bar WHERE v < ALL(SELECT a FROM target AS target WHERE NOT(a IS NULL))"
    skip_reason: "SQL-578"
    translation_target_db: foo
    translation_target_coll: bar
    translation:
      - {'$project': {'_id': 0, 'bar': '$$ROOT'}}
      - {'$project': {'_id': 0, 'bar': '$bar'}}
      - {'$match': {'$expr': {'$subqueryComparison': {
                                                       'op': 'lt',
                                                       'modifier': 'all',
                                                       'arg': '$bar.v',
                                                       'subquery': {
                                                                     'db': 'foo',
                                                                     'collection': 'target',
                                                                     'let': {'bar_0': '$bar'},
                                                                     'outputPath': ['__bot', 'a'],
                                                                     'pipeline': [
                                                                                   {'$project': {'_id': 0, 'target': '$$ROOT'}},
                                                                                   {'$project': {'_id': 0, 'target': '$target'}},
                                                                                   {'$match': {'$expr': {'$sqlNot': [{'$or': [{'$eq': [{'$type': '$target.a'}, 'null']}, {'$eq': [{'$type': '$target.a'}, 'missing']}]}]}}},
                                                                                   {'$project': {'_id': 0, '__bot': {'a': '$target.a'}}}
                                                                     ]
                                                       }
      }}}}
    result:
      - {'bar': {'_id': 1, 'v': 1}}

  - description: correctness test for lt ALL Operator with NULL in subquery result
    current_db: foo
    query: "SELECT * FROM bar AS bar WHERE v < ALL(SELECT a FROM target)"
    translation_target_db: foo
    translation_target_coll: bar
    translation:
      - {'$project': {'_id': 0, 'bar': '$$ROOT'}}
      - {'$project': {'_id': 0, 'bar': '$bar'}}
      - {'$match': {'$expr': {'$subqueryComparison': {
                                                       'op': 'lt',
                                                       'modifier': 'all',
                                                       'arg': '$bar.v',
                                                       'subquery': {
                                                                     'db': 'foo',
                                                                     'collection': 'target',
                                                                     'let': {'bar_0': '$bar'},
                                                                     'outputPath': ['__bot', 'a'],
                                                                     'pipeline': [
                                                                                   {'$project': {'_id': 0, 'target': '$$ROOT'}},
                                                                                   {'$project': {'_id': 0, 'target': '$target'}},
                                                                                   {'$project': {'_id': 0, '__bot': {'a': '$target.a'}}}
                                                                     ]
                                                       }
      }}}}
    result: []

  - description: correctness test for lte ALL Operator without NULL in subquery result
    current_db: foo
    query: "SELECT * FROM bar AS bar WHERE v <= ALL(SELECT a FROM target AS target WHERE NOT(a IS NULL))"
    skip_reason: "SQL-578"
    translation_target_db: foo
    translation_target_coll: bar
    translation:
      - {'$project': {'_id': 0, 'bar': '$$ROOT'}}
      - {'$project': {'_id': 0, 'bar': '$bar'}}
      - {'$match': {'$expr': {'$subqueryComparison': {
                                                       'op': 'lte',
                                                       'modifier': 'all',
                                                       'arg': '$bar.v',
                                                       'subquery': {
                                                                     'db': 'foo',
                                                                     'collection': 'target',
                                                                     'let': {'bar_0': '$bar'},
                                                                     'outputPath': ['__bot', 'a'],
                                                                     'pipeline': [
                                                                                   {'$project': {'_id': 0, 'target': '$$ROOT'}},
                                                                                   {'$project': {'_id': 0, 'target': '$target'}},
                                                                                   {'$match': {'$expr': {'$sqlNot': [{'$or': [{'$eq': [{'$type': '$target.a'}, 'null']}, {'$eq': [{'$type': '$target.a'}, 'missing']}]}]}}},
                                                                                   {'$project': {'_id': 0, '__bot': {'a': '$target.a'}}}
                                                                     ]
                                                       }
      }}}}
    result:
      - {'bar': {'_id': 1, 'v': 1}}
      - {'bar': {'_id': 2, 'v': 2}}

  - description: correctness test for lte ALL Operator with NULL in subquery result
    current_db: foo
    query: "SELECT * FROM bar AS bar WHERE v <= ALL(SELECT a FROM target)"
    translation_target_db: foo
    translation_target_coll: bar
    translation:
      - {'$project': {'_id': 0, 'bar': '$$ROOT'}}
      - {'$project': {'_id': 0, 'bar': '$bar'}}
      - {'$match': {'$expr': {'$subqueryComparison': {
                                                       'op': 'lte',
                                                       'modifier': 'all',
                                                       'arg': '$bar.v',
                                                       'subquery': {
                                                                     'db': 'foo',
                                                                     'collection': 'target',
                                                                     'let': {'bar_0': '$bar'},
                                                                     'outputPath': ['__bot', 'a'],
                                                                     'pipeline': [
                                                                                   {'$project': {'_id': 0, 'target': '$$ROOT'}},
                                                                                   {'$project': {'_id': 0, 'target': '$target'}},
                                                                                   {'$project': {'_id': 0, '__bot': {'a': '$target.a'}}}
                                                                     ]
                                                       }
      }}}}
    result: []

  - description: correctness test for gt ALL Operator without NULL in subquery result
    current_db: foo
    query: "SELECT * FROM bar AS bar WHERE v > ALL(SELECT a FROM target AS target WHERE NOT(a IS NULL))"
    skip_reason: "SQL-578"
    translation_target_db: foo
    translation_target_coll: bar
    translation:
      - {'$project': {'_id': 0, 'bar': '$$ROOT'}}
      - {'$project': {'_id': 0, 'bar': '$bar'}}
      - {'$match': {'$expr': {'$subqueryComparison': {
                                                       'op': 'gt',
                                                       'modifier': 'all',
                                                       'arg': '$bar.v',
                                                       'subquery': {
                                                                     'db': 'foo',
                                                                     'collection': 'target',
                                                                     'let': {'bar_0': '$bar'},
                                                                     'outputPath': ['__bot', 'a'],
                                                                     'pipeline': [
                                                                                   {'$project': {'_id': 0, 'target': '$$ROOT'}},
                                                                                   {'$project': {'_id': 0, 'target': '$target'}},
                                                                                   {'$match': {'$expr': {'$sqlNot': [{'$or': [{'$eq': [{'$type': '$target.a'}, 'null']}, {'$eq': [{'$type': '$target.a'}, 'missing']}]}]}}},
                                                                                   {'$project': {'_id': 0, '__bot': {'a': '$target.a'}}}
                                                                     ]
                                                       }
      }}}}
    result:
      - {'bar': {'_id': 4, 'v': 4}}

  - description: correctness test for gt ALL Operator with NULL in subquery result
    current_db: foo
    query: "SELECT * FROM bar AS bar WHERE v > ALL(SELECT a FROM target)"
    translation_target_db: foo
    translation_target_coll: bar
    translation:
      - {'$project': {'_id': 0, 'bar': '$$ROOT'}}
      - {'$project': {'_id': 0, 'bar': '$bar'}}
      - {'$match': {'$expr': {'$subqueryComparison': {
                                                       'op': 'gt',
                                                       'modifier': 'all',
                                                       'arg': '$bar.v',
                                                       'subquery': {
                                                                     'db': 'foo',
                                                                     'collection': 'target',
                                                                     'let': {'bar_0': '$bar'},
                                                                     'outputPath': ['__bot', 'a'],
                                                                     'pipeline': [
                                                                                   {'$project': {'_id': 0, 'target': '$$ROOT'}},
                                                                                   {'$project': {'_id': 0, 'target': '$target'}},
                                                                                   {'$project': {'_id': 0, '__bot': {'a': '$target.a'}}}
                                                                     ]
                                                       }
      }}}}
    result: []

  - description: correctness test for gte ALL Operator without NULL in subquery result
    current_db: foo
    query: "SELECT * FROM bar AS bar WHERE v >= ALL(SELECT a FROM target AS target WHERE NOT(a IS NULL))"
    skip_reason: "SQL-578"
    translation_target_db: foo
    translation_target_coll: bar
    translation:
      - {'$project': {'_id': 0, 'bar': '$$ROOT'}}
      - {'$project': {'_id': 0, 'bar': '$bar'}}
      - {'$match': {'$expr': {'$subqueryComparison': {
                                                       'op': 'gte',
                                                       'modifier': 'all',
                                                       'arg': '$bar.v',
                                                       'subquery': {
                                                                     'db': 'foo',
                                                                     'collection': 'target',
                                                                     'let': {'bar_0': '$bar'},
                                                                     'outputPath': ['__bot', 'a'],
                                                                     'pipeline': [
                                                                                   {'$project': {'_id': 0, 'target': '$$ROOT'}},
                                                                                   {'$project': {'_id': 0, 'target': '$target'}},
                                                                                   {'$match': {'$expr': {'$sqlNot': [{'$or': [{'$eq': [{'$type': '$target.a'}, 'null']}, {'$eq': [{'$type': '$target.a'}, 'missing']}]}]}}},
                                                                                   {'$project': {'_id': 0, '__bot': {'a': '$target.a'}}}
                                                                     ]
                                                       }
      }}}}
    result:
      - {'bar': {'_id': 3, 'v': 3}}
      - {'bar': {'_id': 4, 'v': 4}}

  - description: correctness test for gte ALL Operator with NULL in subquery result
    current_db: foo
    query: "SELECT * FROM bar AS bar WHERE v >= ALL(SELECT a FROM target)"
    translation_target_db: foo
    translation_target_coll: bar
    translation:
      - {'$project': {'_id': 0, 'bar': '$$ROOT'}}
      - {'$project': {'_id': 0, 'bar': '$bar'}}
      - {'$match': {'$expr': {'$subqueryComparison': {
                                                       'op': 'gte',
                                                       'modifier': 'all',
                                                       'arg': '$bar.v',
                                                       'subquery': {
                                                                     'db': 'foo',
                                                                     'collection': 'target',
                                                                     'let': {'bar_0': '$bar'},
                                                                     'outputPath': ['__bot', 'a'],
                                                                     'pipeline': [
                                                                                   {'$project': {'_id': 0, 'target': '$$ROOT'}},
                                                                                   {'$project': {'_id': 0, 'target': '$target'}},
                                                                                   {'$project': {'_id': 0, '__bot': {'a': '$target.a'}}}
                                                                     ]
                                                       }
      }}}}
    result: []

  - description: ANY subquery comparison in SELECT clause
    current_db: foo
    query: "SELECT VALUE {'v': v, 'x': bar.v = ANY (SELECT a FROM target AS target)} FROM bar AS bar"
    translation_target_db: foo
    translation_target_coll: bar
    translation:
      - {'$project': {'_id': 0, 'bar': '$$ROOT'}}
      - {'$project': {'_id': 0, 'bar': '$bar'}}
      - {'$project': {'_id': 0, '__bot': {'v': '$bar.v', 'x': {'$subqueryComparison': {
                                                                                        'op': 'eq',
                                                                                        'modifier': 'any',
                                                                                        'arg': '$bar.v',
                                                                                        'subquery': {
                                                                                                      'db': 'foo',
                                                                                                      'collection': 'target',
                                                                                                      'let': {'bar_0': '$bar'},
                                                                                                      'outputPath': ['__bot', 'a'],
                                                                                                      'pipeline': [
                                                                                                                    {'$project': {'_id': 0, 'target': '$$ROOT'}},
                                                                                                                    {'$project': {'_id': 0, 'target': '$target'}},
                                                                                                                    {'$project': {'_id': 0, '__bot': {'a': '$target.a'}}}
                                                                                                      ]
                                                                                        }
      }}}}}
      - { '$replaceWith': { '$unsetField': { 'field': '__bot', 'input':
           { '$setField': { 'field': '' , 'input': '$$ROOT', 'value': '$__bot' }
        }}}}
    result:
      - {'': {'v': 1, 'x': null}}
      - {'': {'v': 2, 'x': true}}
      - {'': {'v': 3, 'x': true}}
      - {'': {'v': 4, 'x': null}}
      - {'': {'v': null, 'x': null}}
      - {'': {'x': null}}


  - description: ALL subquery comparison in SELECT clause
    current_db: foo
    query: "SELECT VALUE {'v': v, 'x': bar.v = ALL (SELECT a FROM target AS target WHERE NOT(a IS NULL))} FROM bar AS bar"
    skip_reason: "SQL-593"
    translation_target_db: foo
    translation_target_coll: bar
    translation:
      - {'$project': {'_id': 0, 'bar': '$$ROOT'}}
      - {'$project': {'_id': 0, 'bar': '$bar'}}
      - {'$project': {'_id': 0, '__bot': {'v': '$bar.v', 'x': {'$subqueryComparison': {
                                                                                        'op': 'eq',
                                                                                        'modifier': 'all',
                                                                                        'arg': '$bar.v',
                                                                                        'subquery': {
                                                                                                      'db': 'foo',
                                                                                                      'collection': 'target',
                                                                                                      'let': {'bar_0': '$bar'},
                                                                                                      'outputPath': ['__bot', 'a'],
                                                                                                      'pipeline': [
                                                                                                                    {'$project': {'_id': 0, 'target': '$$ROOT'}},
                                                                                                                    {'$project': {'_id': 0, 'target': '$target'}},
                                                                                                                    {'$match': {'$expr': {'$sqlNot': [{'$or': [{'$eq': [{'$type': '$target.a'}, 'null']}, {'$eq': [{'$type': '$target.a'}, 'missing']}]}]}}},
                                                                                                                    {'$project': {'_id': 0, '__bot': {'a': '$target.a'}}}
                                                                                                      ]
                                                                                        }
      }}}}}
      - { '$replaceWith': { '$unsetField': { 'field': '__bot', 'input':
           { '$setField': { 'field': '' , 'input': '$$ROOT', 'value': '$__bot' }
        }}}}
    result:
      - {'': {'v': 1, 'x': false}}
      - {'': {'v': 2, 'x': false}}
      - {'': {'v': 3, 'x': false}}
      - {'': {'v': 4, 'x': false}}
      - {'': {'v': null, 'x': null}}
      - {'': {'x': null}}

  - description: correctness test for EXISTS Operator
    current_db: foo
    query: "SELECT * FROM bar AS bar WHERE EXISTS(SELECT * FROM target AS target WHERE v = a)"
    skip_reason: SQL-578
    translation_target_db: foo
    translation_target_coll: bar
    translation:
      - {'$project': {'_id': 0, 'bar': '$$ROOT'}}
      - {'$project': {'_id': 0, 'bar': '$bar'}}
      - {'$match': {'$expr': {'$subqueryExists': {
                                                   'db': 'foo',
                                                   'collection': 'target',
                                                   'let': {'bar_0': '$bar'},
                                                   'pipeline': [
                                                                 {'$project': {'_id': 0, 'target': '$$ROOT'}},
                                                                 {'$project': {'_id': 0, 'target': '$target'}},
                                                                 {'$match': {'$expr': {'$sqlEq': ['$$bar_0.v', '$target.a']}}}
                                                   ]
      }}}}
    result:
      - {'bar': {'_id': 2, 'v': 2}}
      - {'bar': {'_id': 3, 'v': 3}}

  - description: correctness test for NOT EXISTS Operator
    current_db: foo
    query: "SELECT * FROM bar AS bar WHERE NOT EXISTS(SELECT * FROM target AS target WHERE v = a)"
    skip_reason: SQL-578
    translation_target_db: foo
    translation_target_coll: bar
    translation:
      - {'$project': {'_id': 0, 'bar': '$$ROOT'}}
      - {'$project': {'_id': 0, 'bar': '$bar'}}
      - {'$match': {'$expr': {'$sqlNot': [{'$subqueryExists': {
                                                               'db': 'foo',
                                                               'collection': 'target',
                                                               'let': {'bar_0': '$bar'},
                                                               'pipeline': [
                                                                             {'$project': {'_id': 0, 'target': '$$ROOT'}},
                                                                             {'$project': {'_id': 0, 'target': '$target'}},
                                                                             {'$match': {'$expr': {'$sqlEq': ['$$bar_0.v', '$target.a']}}}
                                                               ]
      }}]}}}
    result:
      - {'bar': {'_id': 1, 'v': 1}}
      - {'bar': {'_id': 4, 'v': 4}}
      - {'bar': {'_id': 5, 'v': null}}
      - {'bar': {'_id': 6, 'v': null}}

  - description: EXISTS expression in SELECT clause
    current_db: foo
    query: "SELECT VALUE {'v': v, 'x': EXISTS(SELECT * FROM target AS target WHERE target.a = bar.v)} FROM bar AS bar"
    translation_target_db: foo
    translation_target_coll: bar
    translation:
      - {'$project': {'_id': 0, 'bar': '$$ROOT'}}
      - {'$project': {'_id': 0, 'bar': '$bar'}}
      - {'$project': {'_id': 0, '__bot': {'v': '$bar.v', 'x': {'$subqueryExists': {
                                                                                    'db': 'foo',
                                                                                    'collection': 'target',
                                                                                    'let': {'bar_0': '$bar'},
                                                                                    'pipeline': [
                                                                                                  {'$project': {'_id': 0, 'target': '$$ROOT'}},
                                                                                                  {'$project': {'_id': 0, 'target': '$target'}},
                                                                                                  {'$match': {'$expr': {'$sqlEq': ['$target.a', '$$bar_0.v']}}}
                                                                                    ]
      }}}}}
      - { '$replaceWith': { '$unsetField': { 'field': '__bot', 'input':
           { '$setField': { 'field': '' , 'input': '$$ROOT', 'value': '$__bot' }
        }}}}
    result:
      - {'': {'v': 1, 'x': false}}
      - {'': {'v': 2, 'x': true}}
      - {'': {'v': 3, 'x': true}}
      - {'': {'v': 4, 'x': false}}
      - {'': {'v': null, 'x': false}}
      - {'': {'x': false}}

  - description: IN Operator fails if it has different degree on both sides
    current_db: foo
    query: "SELECT * FROM bar AS bar WHERE v IN(SELECT * FROM target)"
    should_compile: false
    algebrize_error: "Operand should contain 1 column(s)"

  - description: ANY Operator fails if it has different degree on both sides
    current_db: foo
    query: "SELECT * FROM bar AS bar WHERE v <> ANY(SELECT * FROM target)"
    should_compile: false
    algebrize_error: "Operand should contain 1 column(s)"

  - description: ALL Operator fails if it has different degree on both sides
    current_db: foo
    query: "SELECT * FROM bar AS bar WHERE v = ALL(SELECT * FROM target)"
    should_compile: false
    algebrize_error: "Operand should contain 1 column(s)"
