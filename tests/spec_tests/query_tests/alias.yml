catalog_data:
  db:
    foo:
      - {'_id': 0, 'a': 1, 'b': 2}

tests:
  - description: Cannot use duplicate implicit aliases for fields
    query: "SELECT a, a FROM [{'a': 1}] arr"
    should_compile: false
    algebrize_error: "alias 'a' used two times"

  - description: Cannot use duplicate explicit aliases for fields
    query: "SELECT a AS alias, a AS alias FROM [{'a': 1}] arr"
    should_compile: false
    algebrize_error: "alias 'alias' used two times"

  - description: Cannot use duplicate generated aliases for fields
    query: "SELECT a AS _2, a+1 FROM [{'a': 1}] arr"
    should_compile: false
    algebrize_error: "alias '_2' used two times"

  - description: Can use different aliases for same field
    query: "SELECT VALUE {'a1': a, 'a2': a} FROM [{'a': 1}] arr"
    translation:
      - {'$array': {'arr': [{'a': 1}]}}
      - {'$project': {'_id': 0, '__bot': {'a1': '$arr.a', 'a2': '$arr.a'}}}
    result:
      - {'__bot': {'a1': 1, 'a2': 1}}

  - description: _id is a valid alias for datasources
    query: "SELECT * FROM [{'a': 1}] _id"
    translation:
      - {'$documents': [{'a': 1}]}
      - {'$project': {'_id': '$$ROOT'}}
    result:
      - {'_id': {'a': 1}}

  - description: Cannot use duplicate implicit aliases for collections
    query: "SELECT * FROM foo, foo"
    should_compile: false
    algebrize_error: "alias 'foo' used two times"

  - description: Cannot use duplicate explicit aliases for collections
    query: "SELECT * FROM foo AS alias, foo AS alias"
    should_compile: false
    algebrize_error: "alias 'alias' used two times"

  - description: Can use different alias for same collection
    current_db: db
    query: "SELECT * FROM foo AS foo1, foo AS foo2"
    translation_target_db: db
    translation_target_coll: foo
    translation:
      - {'$project': {'_id': 0, 'foo': '$$ROOT'}}
      - {'$project': {'_id': 0, 'foo1': '$foo'}}
      - {'$join': {
        'source': 'foo',
        'joinType': 'inner',
        'pipeline': [
          {'$project': {'_id': 0, 'foo': '$$ROOT'}},
          {'$project': {'_id': 0, 'foo2': '$foo'}},
        ],
      }}
    result:
      - {"foo1": {'_id': 0, "a": 1, "b": 2}, "foo2": {'_id': 0, "a": 1, "b": 2}}

  - description: Can use duplicate aliases on both sides of UNION
    current_db: db
    query: "SELECT VALUE {'a': a, 'c': b} FROM foo AS alias UNION ALL SELECT VALUE {'a': a, 'c': b} FROM foo AS alias"
    translation_target_db: db
    translation_target_coll: foo
    translation:
      - {'$project': {'_id': 0, 'foo': '$$ROOT'}}
      - {'$project': {'_id': 0, 'alias': '$foo'}}
      - {'$project': {'_id': 0, '__bot': {'a': '$alias.a', 'c': '$alias.b'}}}
      - {'$unionWith': {'coll': 'foo', 'pipeline': [
          {'$project': {'_id': 0, 'foo': '$$ROOT'}},
          {'$project': {'_id': 0, 'alias': '$foo'}},
          {'$project': {'_id': 0, '__bot': {'a': '$alias.a', 'c': '$alias.b'}}},
        ]}}
    result:
      - {'__bot': {'a': 1, 'c': 2}}
      - {'__bot': {'a': 1, 'c': 2}}
