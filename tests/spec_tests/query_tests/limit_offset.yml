catalog_data:
  foo:
    bar:
      - {'_id': 0, 'a': 1}
      - {'_id': 1, 'a': 2}
      - {'_id': 2, 'a': 3}
    baz:
      - {'_id': 0, 'a': 1}
      - {'_id': 1, 'a': 2}

catalog_schema:
  {
    'foo': {
      'bar': {
        'bsonType': "object",
        'required': [ '_id', 'a' ],
        'additionalProperties': false,
        'properties': {
          '_id': {
            'bsonType': "int"
          },
          'a': {
            'bsonType': "int"
          },
        }
      },
      'baz': {
        'bsonType': "object",
        'required': [ '_id', 'a' ],
        'additionalProperties': false,
        'properties': {
          '_id': {
            'bsonType': "int"
          },
          'a': {
            'bsonType': "int"
          },
        }
      }
    }
  }

tests:
  - description: Simple select with limit clause
    current_db: foo
    query: "SELECT * FROM bar AS bar ORDER BY a LIMIT 1"
    translation_target_db: foo
    translation_target_coll: bar
    translation:
      - {'$project': {'_id': 0, 'bar': '$$ROOT'}}
      - {'$project': {'_id': 0, 'bar': '$bar'}}
      - {'$sort': {'bar.a': 1}}
      - {'$limit': 1}
    result:
      - {'bar': {'_id': 0, 'a': 1}}

  - description: Simple select with offset clause
    current_db: foo
    query: "SELECT * FROM bar AS bar ORDER BY a OFFSET 1"
    translation_target_db: foo
    translation_target_coll: bar
    translation:
      - {'$project': {'_id': 0, 'bar': '$$ROOT'}}
      - {'$project': {'_id': 0, 'bar': '$bar'}}
      - {'$sort': {'bar.a': 1}}
      - {'$skip': 1}
    result:
      - {'bar': {'_id': 1, 'a': 2}}
      - {'bar': {'_id': 2, 'a': 3}}

  - description: Limit number must be positive
    current_db: foo
    query: "SELECT * FROM bar ORDER BY a LIMIT -1"
    should_compile: false
    parse_error: "LIMIT must be positive"

  - description: Limit number must be integer
    current_db: foo
    query: "SELECT * FROM bar ORDER BY a LIMIT 1.1"
    should_compile: false
    parse_error: "LIMIT must be an integer number"

  - description: Offset number must be positive
    current_db: foo
    query: "SELECT * FROM bar ORDER BY a OFFSET -1"
    should_compile: false
    parse_error: "OFFSET must be positive"

  - description: Offset number must be integer
    current_db: foo
    query: "SELECT * FROM bar ORDER BY a OFFSET 1.1"
    should_compile: false
    parse_error: "OFFSET must be an integer number"

  - description: Select with limit and offset
    current_db: foo
    query: "SELECT * FROM bar AS bar ORDER BY a LIMIT 1 OFFSET 1"
    translation_target_db: foo
    translation_target_coll: bar
    translation:
      - {'$project': {'_id': 0, 'bar': '$$ROOT'}}
      - {'$project': {'_id': 0, 'bar': '$bar'}}
      - {'$sort': {'bar.a': 1}}
      - {'$skip': 1}
      - {'$limit': 1}
    result:
      - {'bar': {'_id': 1, 'a': 2}}

  - description: Limit in subquery
    current_db: foo
    query: "SELECT * FROM bar AS bar WHERE a = ANY (SELECT a FROM baz AS baz ORDER BY a LIMIT 1)"
    skip_reason: "SQL-502, SQL-568"
    translation_target_db: foo
    translation_target_coll: bar
    translation:
      - {'$project': {'_id': 0, 'bar': '$$ROOT'}}
      - {'$project': {'_id': 0, 'bar': '$bar'}}
      - {'$match': {'$expr': {'$subqueryComparison': {
                                                       'op': 'eq',
                                                       'modifier': 'any',
                                                       'arg': '$bar.a',
                                                       'subquery': {
                                                                     'collection': 'baz',
                                                                     'let': {},
                                                                     'outputPath': ['__bot', 'a'],
                                                                     'pipeline': [
                                                                                   {'$project': {'_id': 0, 'baz': '$$ROOT'}},
                                                                                   {'$project': {'_id': 0, 'baz': '$baz'}},
                                                                                   {'$project': {'_id': 0, '__bot': {'a': '$baz.a'}}},
                                                                                   {'$sort': {'__bot.a': 1}},
                                                                                   {'$limit': 1}
                                                                     ]
                                                       }
      }}}}
    result:
      - {'bar': {'a': 1}}

  - description: Offset in subquery
    current_db: foo
    query: "SELECT * FROM bar AS bar WHERE a = ANY (SELECT a FROM baz AS baz ORDER BY a OFFSET 1)"
    skip_reason: "SQL-502: remove cardinality check for subquery comparisons"
    translation_target_db: foo
    translation_target_coll: bar
    translation:
      - {'$project': {'_id': 0, 'bar': '$$ROOT'}}
      - {'$project': {'_id': 0, 'bar': '$bar'}}
      - {'$match': {'$expr': {'$subqueryComparison': {
                                                       'op': 'eq',
                                                       'modifier': 'any',
                                                       'arg': '$bar.a',
                                                       'subquery': {
                                                                     'collection': 'baz',
                                                                     'let': {},
                                                                     'outputPath': ['__bot', 'a'],
                                                                     'pipeline': [
                                                                                   {'$project': {'_id': 0, 'baz': '$$ROOT'}},
                                                                                   {'$project': {'_id': 0, 'baz': '$baz'}},
                                                                                   {'$project': {'_id': 0, '__bot': {'a': '$baz.a'}}},
                                                                                   {'$sort': {'__bot.a': 1}},
                                                                                   {'$skip': 1}
                                                                     ]
                                                       }
      }}}}
    result:
      - {'bar': {'a': 2}}
      - {'bar': {'a': 3}}

  - description: Limit and offset in subquery
    current_db: foo
    query: "SELECT * FROM bar AS bar WHERE a = ANY (SELECT a FROM baz AS baz ORDER BY a LIMIT 1 OFFSET 1)"
    skip_reason: "SQL-502, SQL-568"
    translation_target_db: foo
    translation_target_coll: bar
    translation:
      - {'$project': {'_id': 0, 'bar': '$$ROOT'}}
      - {'$project': {'_id': 0, 'bar': '$bar'}}
      - {'$match': {'$expr': {'$subqueryComparison': {
                                                       'op': 'eq',
                                                       'modifier': 'any',
                                                       'arg': '$bar.a',
                                                       'subquery': {
                                                                     'collection': 'baz',
                                                                     'let': {},
                                                                     'outputPath': ['__bot', 'a'],
                                                                     'pipeline': [
                                                                                   {'$project': {'_id': 0, 'baz': '$$ROOT'}},
                                                                                   {'$project': {'_id': 0, 'baz': '$baz'}},
                                                                                   {'$project': {'_id': 0, '__bot': {'a': '$baz.a'}}},
                                                                                   {'$sort': {'__bot.a': 1}},
                                                                                   {'$skip': 1},
                                                                                   {'$limit': 1},
                                                                     ]
                                                       }
      }}}}
    result:
      - {'bar': {'a': 2}}
