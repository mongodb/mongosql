catalog_data:
  test:
    foo:
      - {'_id': 0, 'x': 11, 'y': 12}
    bar:
      - {'_id': 0, 'x': 11, 'y': 12}

tests:
  - description: both unqualified and qualified references to derived table datasource fields are allowed
    query: "SELECT VALUE {'apo': apo, 'bpt': derived.bpt} FROM (SELECT VALUE {'apo': a + 1, 'bpt': b + 2} FROM [{'a': 1, 'b': 1}] AS arr) AS derived"
    skip_reason: "SQL-462: re-enable tests with array datasources"
    translation:
      - {'$documents': {'arr': [{'a': 1, 'b': 1}]}}
      - {'$project': {'_id': 0, '__bot': {'apo': {'$add': ['$arr.a', {'$literal': 1}]}, 'bpt': {'$add': ['$arr.b', {'$literal': 2}]}}}}
      - {'$project': {'_id': 0, 'derived': {'$mergeObjects': ['$__bot']}}}
      - {'$project': {'_id': 0, '__bot': {'apo': '$derived.apo', 'bpt': '$derived.bpt'}}}
      - { '$replaceWith': { '$unsetField': { 'field': '__bot', 'input':
           { '$setField': { 'field': '' , 'input': '$$ROOT', 'value': '$__bot' }
        }}}}
    result:
      - {'': {'apo': 2, 'bpt': 3}}

  - description: derived table cannot reference other datasources in same FROM clause
    query: "SELECT * FROM [{'x': 1}] AS foo CROSS JOIN (SELECT * FROM [{'x': 1}] AS bar WHERE foo.x = bar.x) AS derived"
    skip_reason: "SQL-462: re-enable tests with array datasources"
    should_compile: false
    algebrize_error: "no field 'foo' in datasource 'bar'"

  - description: derived table must have alias
    query: "SELECT * FROM (SELECT * FROM [{a: 1}] AS arr)"
    skip_reason: "SQL-462: re-enable tests with array datasources"
    should_compile: false
    parse_error: "expected <alias>, found EOI"

  - description: datasource names in derived table are not visible outside of derived table query
    query: "SELECT derived.foo.x FROM (SELECT * FROM [{'x': 1}] AS foo, [{'a': 1}] AS bar) AS derived"
    skip_reason: "SQL-462: re-enable tests with array datasources"
    should_compile: false
    algebrize_error: "Unknown field 'foo'"

  - description: derived table query with data sources that statically have ambiguous field must report a static error
    query: "SELECT * FROM (SELECT * FROM [{'x': 1, 'y': 2}] AS foo, [{'a': 1, 'x': 3}] AS bar) AS derived"
    skip_reason: "SQL-462: re-enable tests with array datasources"
    should_compile: false
    algebrize_error: "Ambiguous field 'x' in derived table"

  - description: derived table can result in ambiguous fields when the datasource fields are not enumerable and must report a static error
    query: "SELECT * FROM (SELECT * FROM foo AS foo, bar AS bar) AS derived"
    should_compile: false
    algebrize_error: "The keys of datasources 'foo', 'bar' are not enumerable, and may be ambiguous. Try replacing 'SELECT *' with direct references, or providing schemata for 'foo', 'bar'"

  - description: there is no ambiguity with one schema-less datasource in a derived table
    current_db: test
    query: "SELECT * FROM (SELECT * FROM foo AS foo) AS derived"
    skip_reason: "SQL-515: incorrect schema env when algebrizing derived datasources"
    translation_target_db: test
    translation_target_coll: foo
    translation:
      - {'$project': {'_id': 0, 'foo': '$$ROOT'}}
      - {'$project': {'_id': 0, 'foo': '$foo'}}
      - {'$project': {'_id': 0, 'derived': {'$mergeObjects': ['$foo']}}}
    result:
      - {'derived': {'x': 11, 'y': 12}}

  - description: derived table merges namespaces under alias namespace
    current_db: test
    query: "SELECT * FROM (SELECT foo.*, bar.* FROM [{'a': 1}] foo JOIN [{'b': 2}] bar) AS derived"
    skip_reason: "SQL-462: re-enable tests with array datasources"
    translation_target_db: test
    translation_target_coll: foo
    translation:
      - {'$documents': {'foo': [{'a': 1}]}}
      - {'$join': {
        'joinType': 'inner',
        'pipeline': [{'$documents': {'bar': [{'b': 2}]}}],
      }}
      - {'$project': {'_id': 0, 'foo': '$foo', 'bar': '$bar'}}
      - {'$project': {'_id': 0, 'derived': {'$mergeObjects': ['$foo', '$bar']}}}
    result:
      - {'derived': {'a': 1, 'b': 2}}
