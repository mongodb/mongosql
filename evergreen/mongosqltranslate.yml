functions:
  "mciuploads mongosqltranslate":
    #macos
    - command: s3.put
      params:
        build_variants:
          ["mongosqltranslate-macos", "mongosqltranslate-macos-arm"]
        aws_key: ${aws_key}
        aws_secret: ${aws_secret}
        local_file: mongosql-rs/target/release/libmongosqltranslate.dylib
        remote_file: mongosql-rs/artifacts/${version_id}/${build_variant}/libmongosqltranslate.dylib
        bucket: mciuploads
        permissions: public-read
        content_type: application/octet-stream
    #linux
    - command: s3.put
      params:
        build_variants:
          ["mongosqltranslate-amazon2-arm64", "mongosqltranslate-rhel76"]
        aws_key: ${aws_key}
        aws_secret: ${aws_secret}
        local_file: mongosql-rs/target/release/libmongosqltranslate.so
        remote_file: mongosql-rs/artifacts/${version_id}/${build_variant}/libmongosqltranslate.so
        bucket: mciuploads
        permissions: public-read
        content_type: application/octet-stream
    #windows
    - command: s3.put
      params:
        build_variants: ["mongosqltranslate-windows-64"]
        aws_key: ${aws_key}
        aws_secret: ${aws_secret}
        local_file: mongosql-rs/target/release/mongosqltranslate.dll
        remote_file: mongosql-rs/artifacts/${version_id}/${build_variant}/mongosqltranslate.dll
        bucket: mciuploads
        permissions: public-read
        content_type: application/octet-stream

  "upload mongosqltranslate release":
    #macos x86_64
    - command: s3.get
      params:
        aws_key: ${aws_key}
        aws_secret: ${aws_secret}
        remote_file: mongosql-rs/artifacts/${version_id}/mongosqltranslate-macos/libmongosqltranslate.dylib
        local_file: mongosql-rs/release/mongosqltranslate-macos/libmongosqltranslate.dylib
        bucket: mciuploads
    - command: s3.put
      params:
        aws_key: ${release_aws_key}
        aws_secret: ${release_aws_secret}
        local_file: mongosql-rs/release/mongosqltranslate-macos/libmongosqltranslate.dylib
        remote_file: mongosqltranslate/libmongosqltranslate-macos.dylib
        bucket: translators-connectors-releases
        permissions: public-read
        skip_existing: false
        content_type: application/octet-stream
        display_name: libmongosqltranslate-macos.dylib
    - command: s3.put
      params:
        aws_key: ${release_aws_key}
        aws_secret: ${release_aws_secret}
        local_file: mongosql-rs/release/mongosqltranslate-macos/libmongosqltranslate.dylib
        remote_file: mongosqltranslate/libmongosqltranslate-v${release_version}-macos.dylib
        bucket: translators-connectors-releases
        permissions: public-read
        content_type: application/octet-stream
        display_name: libmongosqltranslate-v${release_version}-macos.dylib
    #macos arm64
    - command: s3.get
      params:
        aws_key: ${aws_key}
        aws_secret: ${aws_secret}
        remote_file: mongosql-rs/artifacts/${version_id}/mongosqltranslate-macos-arm/libmongosqltranslate.dylib
        local_file: mongosql-rs/release/mongosqltranslate-macos-arm/libmongosqltranslate.dylib
        bucket: mciuploads
    - command: s3.put
      params:
        aws_key: ${release_aws_key}
        aws_secret: ${release_aws_secret}
        local_file: mongosql-rs/release/mongosqltranslate-macos-arm/libmongosqltranslate.dylib
        remote_file: mongosqltranslate/libmongosqltranslate-macos-arm.dylib
        bucket: translators-connectors-releases
        permissions: public-read
        skip_existing: false
        content_type: application/octet-stream
        display_name: libmongosqltranslate-macos-arm.dylib
    - command: s3.put
      params:
        aws_key: ${release_aws_key}
        aws_secret: ${release_aws_secret}
        local_file: mongosql-rs/release/mongosqltranslate-macos-arm/libmongosqltranslate.dylib
        remote_file: mongosqltranslate/libmongosqltranslate-v${release_version}-macos-arm.dylib
        bucket: translators-connectors-releases
        permissions: public-read
        content_type: application/octet-stream
        display_name: libmongosqltranslate-v${release_version}-macos-arm.dylib
    # rhel x86_64
    - command: s3.get
      params:
        aws_key: ${aws_key}
        aws_secret: ${aws_secret}
        remote_file: mongosql-rs/artifacts/${version_id}/mongosqltranslate-rhel76/libmongosqltranslate.so
        local_file: mongosql-rs/release/mongosqltranslate-rhel76/libmongosqltranslate.so
        bucket: mciuploads
    - command: s3.put
      params:
        aws_key: ${release_aws_key}
        aws_secret: ${release_aws_secret}
        local_file: mongosql-rs/release/mongosqltranslate-rhel76/libmongosqltranslate.so
        remote_file: mongosqltranslate/libmongosqltranslate-linux.so
        bucket: translators-connectors-releases
        permissions: public-read
        skip_existing: false
        content_type: application/octet-stream
        display_name: libmongosqltranslate-linux.so
    - command: s3.put
      params:
        aws_key: ${release_aws_key}
        aws_secret: ${release_aws_secret}
        local_file: mongosql-rs/release/mongosqltranslate-rhel76/libmongosqltranslate.so
        remote_file: mongosqltranslate/libmongosqltranslate-v${release_version}-linux.so
        bucket: translators-connectors-releases
        permissions: public-read
        content_type: application/octet-stream
        display_name: libmongosqltranslate-v${release_version}-linux.so
    # amazon2 arm64
    - command: s3.get
      params:
        aws_key: ${aws_key}
        aws_secret: ${aws_secret}
        remote_file: mongosql-rs/artifacts/${version_id}/mongosqltranslate-amazon2-arm64/libmongosqltranslate.so
        local_file: mongosql-rs/release/mongosqltranslate-amazon2-arm64/libmongosqltranslate.so
        bucket: mciuploads
    - command: s3.put
      params:
        aws_key: ${release_aws_key}
        aws_secret: ${release_aws_secret}
        local_file: mongosql-rs/release/mongosqltranslate-amazon2-arm64/libmongosqltranslate.so
        remote_file: mongosqltranslate/libmongosqltranslate-linux-arm.so
        bucket: translators-connectors-releases
        permissions: public-read
        skip_existing: false
        content_type: application/octet-stream
        display_name: libmongosqltranslate-linux-arm.so
    - command: s3.put
      params:
        aws_key: ${release_aws_key}
        aws_secret: ${release_aws_secret}
        local_file: mongosql-rs/release/mongosqltranslate-amazon2-arm64/libmongosqltranslate.so
        remote_file: mongosqltranslate/libmongosqltranslate-v${release_version}-linux-arm.so
        bucket: translators-connectors-releases
        permissions: public-read
        content_type: application/octet-stream
        display_name: libmongosqltranslate-v${release_version}-linux-arm.so
    # windows
    - command: s3.get
      params:
        aws_key: ${aws_key}
        aws_secret: ${aws_secret}
        remote_file: mongosql-rs/artifacts/${version_id}/mongosqltranslate-windows-64/mongosqltranslate.dll
        local_file: mongosql-rs/release/mongosqltranslate-windows-64/mongosqltranslate.dll
        bucket: mciuploads
    - command: s3.put
      params:
        aws_key: ${release_aws_key}
        aws_secret: ${release_aws_secret}
        local_file: mongosql-rs/release/mongosqltranslate-windows-64/mongosqltranslate.dll
        remote_file: mongosqltranslate/mongosqltranslate-win.dll
        bucket: translators-connectors-releases
        permissions: public-read
        skip_existing: false
        content_type: application/octet-stream
        display_name: mongosqltranslate-win.dll
    - command: s3.put
      params:
        aws_key: ${release_aws_key}
        aws_secret: ${release_aws_secret}
        local_file: mongosql-rs/release/mongosqltranslate-windows-64/mongosqltranslate.dll
        remote_file: mongosqltranslate/mongosqltranslate-v${release_version}-win.dll
        bucket: translators-connectors-releases
        permissions: public-read
        content_type: application/octet-stream
        display_name: mongosqltranslate-v${release_version}-win.lib

  "upload mongosqltranslate snapshot":
    # macOS x86_64
    - command: s3.get
      params:
        aws_key: ${aws_key}
        aws_secret: ${aws_secret}
        remote_file: mongosql-rs/artifacts/${version_id}/mongosqltranslate-macos/libmongosqltranslate.dylib
        local_file: mongosql-rs/release/mongosqltranslate-macos/libmongosqltranslate.dylib
        bucket: mciuploads
    - command: s3.put
      params:
        aws_key: ${release_aws_key}
        aws_secret: ${release_aws_secret}
        local_file: mongosql-rs/release/mongosqltranslate-macos/libmongosqltranslate.dylib
        remote_file: mongosqltranslate/snapshot/libmongosqltranslate-macos.dylib
        bucket: translators-connectors-releases
        permissions: public-read
        skip_existing: false
        content_type: application/octet-stream
        display_name: libmongosqltranslate-macos.dylib
    # macOS arm64
    - command: s3.get
      params:
        aws_key: ${aws_key}
        aws_secret: ${aws_secret}
        remote_file: mongosql-rs/artifacts/${version_id}/mongosqltranslate-macos-arm/libmongosqltranslate.dylib
        local_file: mongosql-rs/release/mongosqltranslate-macos-arm/libmongosqltranslate.dylib
        bucket: mciuploads
    - command: s3.put
      params:
        aws_key: ${release_aws_key}
        aws_secret: ${release_aws_secret}
        local_file: mongosql-rs/release/mongosqltranslate-macos-arm/libmongosqltranslate.dylib
        remote_file: mongosqltranslate/snapshot/libmongosqltranslate-macos-arm.dylib
        bucket: translators-connectors-releases
        permissions: public-read
        skip_existing: false
        content_type: application/octet-stream
        display_name: libmongosqltranslate-macos-arm.dylib
    # rhel x86_64
    - command: s3.get
      params:
        aws_key: ${aws_key}
        aws_secret: ${aws_secret}
        remote_file: mongosql-rs/artifacts/${version_id}/mongosqltranslate-rhel76/libmongosqltranslate.so
        local_file: mongosql-rs/release/mongosqltranslate-rhel76/libmongosqltranslate.so
        bucket: mciuploads
    - command: s3.put
      params:
        aws_key: ${release_aws_key}
        aws_secret: ${release_aws_secret}
        local_file: mongosql-rs/release/mongosqltranslate-rhel76/libmongosqltranslate.so
        remote_file: mongosqltranslate/snapshot/libmongosqltranslate-linux.so
        bucket: translators-connectors-releases
        permissions: public-read
        skip_existing: false
        content_type: application/octet-stream
        display_name: libmongosqltranslate-linux.so
    # Amazon2 arm64
    - command: s3.get
      params:
        aws_key: ${aws_key}
        aws_secret: ${aws_secret}
        remote_file: mongosql-rs/artifacts/${version_id}/mongosqltranslate-amazon2-arm64/libmongosqltranslate.so
        local_file: mongosql-rs/release/mongosqltranslate-amazon2-arm64/libmongosqltranslate.so
        bucket: mciuploads
    - command: s3.put
      params:
        aws_key: ${release_aws_key}
        aws_secret: ${release_aws_secret}
        local_file: mongosql-rs/release/mongosqltranslate-amazon2-arm64/libmongosqltranslate.so
        remote_file: mongosqltranslate/snapshot/libmongosqltranslate-linux-arm.so
        bucket: translators-connectors-releases
        permissions: public-read
        skip_existing: false
        content_type: application/octet-stream
        display_name: libmongosqltranslate-linux-arm.so
    # Windows
    - command: s3.get
      params:
        aws_key: ${aws_key}
        aws_secret: ${aws_secret}
        remote_file: mongosql-rs/artifacts/${version_id}/mongosqltranslate-windows-64/mongosqltranslate.dll
        local_file: mongosql-rs/release/mongosqltranslate-windows-64/mongosqltranslate.dll
        bucket: mciuploads
    - command: s3.put
      params:
        aws_key: ${release_aws_key}
        aws_secret: ${release_aws_secret}
        local_file: mongosql-rs/release/mongosqltranslate-windows-64/mongosqltranslate.dll
        remote_file: mongosqltranslate/snapshot/mongosqltranslate-win.dll
        bucket: translators-connectors-releases
        permissions: public-read
        skip_existing: false
        content_type: application/octet-stream
        display_name: mongosqltranslate-win.dll

  "run mongosqltranslate tests":
    - command: shell.exec
      type: test
      params:
        shell: bash
        working_dir: mongosql-rs
        script: |
          ${prepare_shell}
          cargo test --package mongosqltranslate

tasks:
  - name: mongosqltranslate-release
    git_tag_only: true
    depends_on:
      - name: compile-mongosqltranslate
        variant: ".mongosqltranslate-release-variant"
    commands:
      - func: "upload mongosqltranslate release"

  - name: mongosqltranslate-snapshot
    depends_on:
      - name: compile-mongosqltranslate
        variant: ".mongosqltranslate-release-variant"
    allowed_requesters: ["commit"]
    commands:
      - func: "upload mongosqltranslate snapshot"

  - name: test-mongosqltranslate
    depends_on:
      - name: compile-mongosqltranslate
    commands:
      - func: "install rust toolchain"
      - func: "run mongosqltranslate tests"

  - name: compile-mongosqltranslate
    commands:
      - func: "install rust toolchain"
      - func: "set and check packages version"
      - func: "compile release"
      - func: "mciuploads mongosqltranslate"

buildvariants:
  - name: mongosqltranslate-release
    display_name: "Mongosqltranslate Release"
    run_on: [ubuntu2004-large]
    tasks:
      - name: mongosqltranslate-release

  - name: mongosqltranslate-snapshot
    display_name: "Mongosqltranslate Snapshot"
    run_on: [ubuntu2004-large]
    tasks:
      - name: mongosqltranslate-snapshot

  - name: mongosqltranslate-macos
    tags: ["mongosqltranslate-release-variant"]
    display_name: "Mongosqltranslate - macOS"
    run_on: [macos-14]
    tasks:
      - name: compile-mongosqltranslate
      - name: test-mongosqltranslate

  - name: mongosqltranslate-macos-arm
    tags: ["mongosqltranslate-release-variant"]
    display_name: "Mongosqltranslate - macOS arm64"
    run_on: [macos-14-arm64]
    tasks:
      - name: compile-mongosqltranslate
      - name: test-mongosqltranslate

  - name: mongosqltranslate-windows-64
    tags: ["mongosqltranslate-release-variant"]
    display_name: "Mongosqltranslate - windows"
    run_on: [windows-64-vs2019-large]
    tasks:
      - name: compile-mongosqltranslate
      - name: test-mongosqltranslate

  - name: mongosqltranslate-rhel76
    tags: ["mongosqltranslate-release-variant"]
    display_name: "Mongosqltranslate - RHEL76 linux"
    run_on: [rhel76-large]
    tasks:
      - name: compile-mongosqltranslate
      - name: test-mongosqltranslate

  - name: mongosqltranslate-amazon2-arm64
    tags: ["mongosqltranslate-release-variant"]
    display_name: "Mongosqltranslate - linux arm"
    run_on: [amazon2-arm64-large]
    tasks:
      - name: compile-mongosqltranslate
      - name: test-mongosqltranslate
