tests:
  - name: "nothing to desugar"
    skip_reason: "SQL-1254"
    input:
      - { "$project": { "_id": 0, "foo": "$$ROOT" } }
    expected:
      - { "$project": { "_id": 0, "foo": "$$ROOT" } }

  - name: "desugar non-distinct $sqlAvg"
    skip_reason: "SQL-1254"
    input:
      - {
        "$group":
          {
            "_id": null,
            "acc": { "$sqlAvg": { "var": "$a", "distinct": false } },
          },
      }
    expected:
      - { "$group": { "_id": null, "acc": { "$avg": "$a" } } }

  - name: "desugar distinct $sqlAvg"
    skip_reason: "SQL-1254"
    input:
      - {
        "$group":
          {
            "_id": null,
            "acc": { "$sqlAvg": { "var": "$a", "distinct": true } },
          },
      }
    expected:
      - { "$group": { "_id": null, "acc": { "$addToSet": "$a" } } }
      - { "$project": { "acc": { "$avg": "$acc" } } }

  - name: "desugar non-distinct $sqlCount"
    skip_reason: "SQL-1254"
    input:
      - {
        "$group":
          {
            "_id": null,
            "acc": { "$sqlCount": { "var": "$a", "distinct": false } },
          },
      }
    expected:
      - {
        "$group":
          {
            "_id": null,
            "acc":
              {
                "$sum":
                  {
                    "$cond":
                      [
                        { "$in": [{ "$type": "$a" }, ["missing", "null"]] },
                        0,
                        1,
                      ],
                  },
              },
          },
      }

  - name: "desugar distinct $sqlCount"
    skip_reason: "SQL-1254"
    input:
      - {
        "$group":
          {
            "_id": null,
            "acc": { "$sqlCount": { "var": "$a", "distinct": true } },
          },
      }
    expected:
      - { "$group": { "_id": null, "acc": { "$addToSet": "$a" } } }
      - {
        "$project":
          {
            "acc":
              {
                "$reduce":
                  {
                    "input": "$acc",
                    "initialValue": 0,
                    "in":
                      {
                        "$add":
                          [
                            "$$value",
                            {
                              "$cond":
                                [
                                  {
                                    "$in":
                                      [
                                        { "$type": "$$this" },
                                        ["missing", "null"],
                                      ],
                                  },
                                  0,
                                  1,
                                ],
                            },
                          ],
                      },
                  },
              },
          },
      }

  - name: "desugar non-distinct $sqlLast"
    skip_reason: "SQL-1254"
    input:
      - {
        "$group":
          {
            "_id": null,
            "acc": { "$sqlLast": { "var": "$a", "distinct": false } },
          },
      }
    expected:
      - { "$group": { "_id": null, "acc": { "$last": "$a" } } }

  - name: "desugar distinct $sqlLast"
    skip_reason: "SQL-1254"
    input:
      - {
        "$group":
          {
            "_id": null,
            "acc": { "$sqlLast": { "var": "$a", "distinct": true } },
          },
      }
    expected:
      - { "$group": { "_id": null, "acc": { "$addToSet": "$a" } } }
      - { "$project": { "acc": { "$last": "$acc" } } }

  - name: "desugar non-distinct $sqlMergeObjects"
    skip_reason: "SQL-1254"
    input:
      - {
        "$group":
          {
            "_id": null,
            "acc": { "$sqlMergeObjects": { "var": "$a", "distinct": false } },
          },
      }
    expected:
      - { "$group": { "_id": null, "acc": { "$mergeObjects": "$a" } } }

  - name: "desugar distinct $sqlMergeObjects"
    skip_reason: "SQL-1254"
    input:
      - {
        "$group":
          {
            "_id": null,
            "acc": { "$sqlMergeObjects": { "var": "$a", "distinct": true } },
          },
      }
    expected:
      - { "$group": { "_id": null, "acc": { "$addToSet": "$a" } } }
      - { "$project": { "acc": { "$mergeObjects": "$acc" } } }

  - name: "desugar non-distinct $sqlStdDevPop"
    skip_reason: "SQL-1254"
    input:
      - {
        "$group":
          {
            "_id": null,
            "acc": { "$sqlStdDevPop": { "var": "$a", "distinct": false } },
          },
      }
    expected:
      - { "$group": { "_id": null, "acc": { "$stdDevPop": "$a" } } }

  - name: "desugar distinct $sqlStdDevPop"
    skip_reason: "SQL-1254"
    input:
      - {
        "$group":
          {
            "_id": null,
            "acc": { "$sqlStdDevPop": { "var": "$a", "distinct": true } },
          },
      }
    expected:
      - { "$group": { "_id": null, "acc": { "$addToSet": "$a" } } }
      - { "$project": { "acc": { "$stdDevPop": "$acc" } } }

  - name: "desugar non-distinct $sqlStdDevSamp"
    skip_reason: "SQL-1254"
    input:
      - {
        "$group":
          {
            "_id": null,
            "acc": { "$sqlStdDevSamp": { "var": "$a", "distinct": false } },
          },
      }
    expected:
      - { "$group": { "_id": null, "acc": { "$stdDevSamp": "$a" } } }

  - name: "desugar distinct $sqlStdDevSamp"
    skip_reason: "SQL-1254"
    input:
      - {
        "$group":
          {
            "_id": null,
            "acc": { "$sqlStdDevSamp": { "var": "$a", "distinct": true } },
          },
      }
    expected:
      - { "$group": { "_id": null, "acc": { "$addToSet": "$a" } } }
      - { "$project": { "acc": { "$stdDevSamp": "$acc" } } }

  - name: "desugar non-distinct $sqlSum"
    skip_reason: "SQL-1254"
    input:
      - {
        "$group":
          {
            "_id": null,
            "acc": { "$sqlSum": { "var": "$a", "distinct": false } },
          },
      }
    expected:
      - { "$group": { "_id": null, "acc": { "$sum": "$a" } } }

  - name: "desugar distinct $sqlSum"
    skip_reason: "SQL-1254"
    input:
      - {
        "$group":
          {
            "_id": null,
            "acc": { "$sqlSum": { "var": "$a", "distinct": true } },
          },
      }
    expected:
      - { "$group": { "_id": null, "acc": { "$addToSet": "$a" } } }
      - { "$project": { "acc": { "$sum": "$acc" } } }

  - name: "desugar mix of distinct $sql, non-distinct $sql, and non-$sql accumulators"
    skip_reason: "SQL-1254"
    input:
      - {
        "$group":
          {
            "_id": null,
            "nonDistinct": { "$sqlAvg": { "var": "$a", "distinct": false } },
            "distinct": { "$sqlLast": { "var": "$b", "distinct": true } },
            "nonSQL": { "$first": "$c" },
          },
      }
    expected:
      - {
        "$group":
          {
            "_id": null,
            "nonDistinct": { "$avg": "$a" },
            "distinct": { "$addToSet": "$b" },
            "nonSQL": { "$first": "$c" },
          },
      }
      - {
        "$project":
          {
            "nonDistinct": 1,
            "distinct": { "$last": "$distinct" },
            "nonSQL": 1,
          },
      }
