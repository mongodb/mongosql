tests:
  - name: "nothing to desugar"
    skip_reason: "SQL-1257"
    input:
      - { "$project": { "_id": 0, "foo": "$$ROOT" } }
    expected:
      - { "$project": { "_id": 0, "foo": "$$ROOT" } }

  - name: "desugar $sqlBetween"
    skip_reason: "SQL-1257"
    input:
      - { "$project": { "_id": 0, "expr": { "$sqlBetween": ["$x", 1, 10] } } }
    expected:
      - {
        "$project":
          {
            "_id": 0,
            "expr":
              {
                "$let":
                  {
                    "vars": { "desugared_sqlBetween_input": "$x" },
                    "in":
                      {
                        "$sqlAnd":
                          [
                            {
                              "$sqlGte": ["$$desugared_sqlBetween_input", 1],
                            },
                            {
                              "$sqlLte": ["$$desugared_sqlBetween_input", 10],
                            },
                          ],
                      },
                  },
              },
          },
      }

  - name: "desugar nested $sqlBetween"
    skip_reason: "SQL-1257"
    input:
      - {
        "$project":
          {
            "_id": 0,
            "expr":
              {
                "$sqlBetween":
                  [
                    "$x",
                    1,
                    {
                      "$cond": [{ "$sqlBetween": ["$y", 50, 100] }, 100, 10],
                    },
                  ],
              },
          },
      }
    expected:
      - {
        "$project":
          {
            "_id": 0,
            "expr":
              {
                "$let":
                  {
                    "vars": { "desugared_sqlBetween_input": "$x" },
                    "in":
                      {
                        "$sqlAnd":
                          [
                            {
                              "$sqlGte": ["$$desugared_sqlBetween_input", 1],
                            },
                            {
                              "$sqlLte":
                                [
                                  "$$desugared_sqlBetween_input",
                                  {
                                    "$cond":
                                      [
                                        {
                                          "$let":
                                            {
                                              "vars":
                                                {
                                                  "desugared_sqlBetween_input": "$y",
                                                },
                                              "in":
                                                {
                                                  "$sqlAnd":
                                                    [
                                                      {
                                                        "$sqlGte":
                                                          [
                                                            "$$desugared_sqlBetween_input",
                                                            50,
                                                          ],
                                                      },
                                                      {
                                                        "$sqlLte":
                                                          [
                                                            "$$desugared_sqlBetween_input",
                                                            100,
                                                          ],
                                                      },
                                                    ],
                                                },
                                            },
                                        },
                                        100,
                                        10,
                                      ],
                                  },
                                ],
                            },
                          ],
                      },
                  },
              },
          },
      }

  - name: "desugar $sqlConvert"
    skip_reason: "SQL-1257"
    input:
      - {
        "$project":
          {
            "_id": 0,
            "expr":
              {
                "$sqlConvert":
                  {
                    "input": "$a",
                    "to": "array",
                    "onNull": null,
                    "onError": [],
                  },
              },
          },
      }
    expected:
      - {
        "$project":
          {
            "_id": 0,
            "expr":
              {
                "$let":
                  {
                    "vars": { "sqlConvert_input": "$a" },
                    "in":
                      {
                        "$switch":
                          {
                            "branches":
                              [
                                {
                                  "case":
                                    {
                                      "$eq":
                                        [
                                          { "$type": "$$sqlConvert_input" },
                                          "array",
                                        ],
                                    },
                                  "then": "$$sqlConvert_input",
                                },
                                {
                                  "case":
                                    { "$lte": ["$$sqlConvert_input", null] },
                                  "then": null,
                                },
                              ],
                            "default": [],
                          },
                      },
                  },
              },
          },
      }

  - name: "desugar $sqlDivide"
    skip_reason: "SQL-1257"
    input:
      - {
        "$project":
          {
            "_id": 0,
            "expr":
              {
                "$sqlDivide":
                  { "dividend": "$a", "divisor": "$b", "onError": null },
              },
          },
      }
    expected:
      - {
        "$project":
          {
            "_id": 0,
            "expr":
              {
                "$cond":
                  [{ "$eq": ["$b", 0] }, null, { "$divide": ["$a", "$b"] }],
              },
          },
      }

  - name: "desugar $sqlDivide non-null onError"
    skip_reason: "SQL-1257"
    input:
      - {
        "$project":
          {
            "_id": 0,
            "expr":
              {
                "$sqlDivide":
                  { "dividend": "$a", "divisor": "$b", "onError": "err" },
              },
          },
      }
    expected:
      - {
        "$project":
          {
            "_id": 0,
            "expr":
              {
                "$cond":
                  [{ "$eq": ["$b", 0] }, "err", { "$divide": ["$a", "$b"] }],
              },
          },
      }

  - name: "desugar $sqlSlice with no start argument"
    skip_reason: "SQL-1257"
    input:
      - { "$project": { "_id": 0, "expr": { "$sqlSlice": ["$arr", "$len"] } } }
    expected:
      - { "$project": { "_id": 0, "expr": { "$slice": ["$arr", "$len"] } } }

  - name: "desugar $sqlSlice with start argument"
    skip_reason: "SQL-1257"
    input:
      - {
        "$project":
          { "_id": 0, "expr": { "$sqlSlice": ["$arr", "$start", "$len"] } },
      }
    expected:
      - {
        "$project":
          {
            "_id": 0,
            "expr":
              {
                "$cond":
                  [
                    { "$lte": ["$len", 0] },
                    null,
                    { "$slice": ["$arr", "$start", "$len"] },
                  ],
              },
          },
      }

  - name: "desugar $coalesce"
    skip_reason: "SQL-1257"
    input:
      - {
        "$project": { "_id": 0, "expr": { "$coalesce": ["$a", "$b", "$c"] } },
      }
    expected:
      - {
        "$project":
          {
            "_id": 0,
            "expr":
              {
                "$switch":
                  {
                    "branches":
                      [
                        { "case": { "$gt": ["$a", null] }, "then": "$a" },
                        { "case": { "$gt": ["$b", null] }, "then": "$b" },
                        { "case": { "$gt": ["$c", null] }, "then": "$c" },
                      ],
                    "default": null,
                  },
              },
          },
      }

  - name: "desugar $like with no escape"
    skip_reason: "SQL-1257"
    input:
      - {
        "$project":
          {
            "_id": 0,
            "expr": { "$like": { "input": "$s", "pattern": "abc" } },
          },
      }
    expected:
      - {
        "$project":
          {
            "_id": 0,
            "expr":
              {
                "$regexMatch":
                  { "input": "$s", "regex": "^abc$", "options": "is" },
              },
          },
      }

  - name: "desugar $like with escape"
    skip_reason: "SQL-1257"
    input:
      - {
        "$project":
          {
            "_id": 0,
            "expr":
              {
                "$like":
                  {
                    "input": "$s",
                    "pattern": "a\\__\\_%\\%",
                    "escape": "\\",
                  },
              },
          },
      }
    expected:
      - {
        "$project":
          {
            "_id": 0,
            "expr":
              {
                "$regexMatch":
                  { "input": "$s", "regex": "^a_._.*%$", "options": "is" },
              },
          },
      }

  - name: "desugar $nullIf"
    skip_reason: "SQL-1257"
    input:
      - { "$project": { "_id": 0, "expr": { "$nullIf": ["$a", "$b"] } } }
    expected:
      - {
        "$project":
          {
            "_id": 0,
            "expr":
              {
                "$let":
                  {
                    "vars": { "expr1": { "$ifNull": ["$a", null] } },
                    "in":
                      {
                        "$cond":
                          [{ "$eq": ["$$expr1", "$b"] }, null, "$$expr1"],
                      },
                  },
              },
          },
      }

  - name: "desugar $sqlLog"
    skip_reason: "SQL-1257"
    input:
      - {
        "$project": { "_id": 0, "expr": { "$sqlLog": ["$number", "$base"] } },
      }
    expected:
      - {
        "$project":
          {
            "_id": { "$numberInt": "0" },
            "expr":
              {
                "$cond":
                  {
                    "if":
                      {
                        "$or":
                          [
                            {
                              "$eq":
                                [
                                  "$number",
                                  { "$literal": { "$numberDouble": "NaN" } },
                                ],
                            },
                            {
                              "$eq":
                                [
                                  "$base",
                                  { "$literal": { "$numberDouble": "NaN" } },
                                ],
                            },
                          ],
                      },
                    "then": { "$literal": { "$numberDouble": "NaN" } },
                    "else":
                      {
                        "$cond":
                          {
                            "if":
                              {
                                "$or":
                                  [
                                    {
                                      "$or":
                                        [
                                          {
                                            "$lte":
                                              [
                                                "$number",
                                                {
                                                  "$literal":
                                                    { "$numberInt": "0" },
                                                },
                                              ],
                                          },
                                          {
                                            "$eq":
                                              [
                                                "$base",
                                                {
                                                  "$literal":
                                                    { "$numberInt": "1" },
                                                },
                                              ],
                                          },
                                        ],
                                    },
                                    {
                                      "$lte":
                                        [
                                          "$base",
                                          {
                                            "$literal": { "$numberInt": "0" },
                                          },
                                        ],
                                    },
                                  ],
                              },
                            "then": { "$literal": null },
                            "else": { "$log": ["$number", "$base"] },
                          },
                      },
                  },
              },
          },
      }

  - name: "desugar $sqlRound"
    skip_reason: "SQL-1257"
    input:
      - {
        "$project":
          { "_id": 0, "expr": { "$sqlRound": ["$number", "$place"] } },
      }
    expected:
      - {
        "$project":
          {
            "_id": { "$numberInt": "0" },
            "expr":
              {
                "$let":
                  {
                    "vars":
                      {
                        "desugared_sqlRound_input0": "$number",
                        "desugared_sqlRound_input1": "$place",
                      },
                    "in":
                      {
                        "$cond":
                          {
                            "if":
                              {
                                "$eq":
                                  [
                                    "$$desugared_sqlRound_input1",
                                    {
                                      "$literal": { "$numberDouble": "NaN" },
                                    },
                                  ],
                              },
                            "then":
                              { "$literal": { "$numberDouble": "NaN" } },
                            "else":
                              {
                                "$cond":
                                  {
                                    "if":
                                      {
                                        "$and":
                                          [
                                            {
                                              "$gte":
                                                [
                                                  "$$desugared_sqlRound_input1",
                                                  {
                                                    "$literal":
                                                      { "$numberInt": "-20" },
                                                  },
                                                ],
                                            },
                                            {
                                              "$lte":
                                                [
                                                  "$$desugared_sqlRound_input1",
                                                  {
                                                    "$literal":
                                                      { "$numberInt": "100" },
                                                  },
                                                ],
                                            },
                                          ],
                                      },
                                    "then":
                                      {
                                        "$round":
                                          [
                                            "$$desugared_sqlRound_input0",
                                            "$$desugared_sqlRound_input1",
                                          ],
                                      },
                                    "else": { "$literal": null },
                                  },
                              },
                          },
                      },
                  },
              },
          },
      }

  - name: "desugar $sqlSplit"
    skip_reason: "SQL-1257"
    input:
      - {
        "$project": { "_id": 0, "expr": { "$sqlSplit": ["$a", "$b", "$c"] } },
      }
    expected:
      - {
        "$project":
          {
            "_id": 0,
            "expr":
              {
                "$let":
                  {
                    "vars":
                      {
                        "desugared_sqlSplit_input0": "$a",
                        "desugared_sqlSplit_input1": "$b",
                        "desugared_sqlSplit_input2": "$c",
                      },
                    "in":
                      {
                        "$cond":
                          {
                            "if":
                              { "$eq": ["$$desugared_sqlSplit_input1", ""] },
                            "then": { "$literal": null },
                            "else":
                              {
                                "$let":
                                  {
                                    "vars":
                                      {
                                        "desugared_sqlSplit_split_expr":
                                          {
                                            "$split":
                                              [
                                                "$$desugared_sqlSplit_input0",
                                                "$$desugared_sqlSplit_input1",
                                              ],
                                          },
                                      },
                                    "in":
                                      {
                                        "$cond":
                                          {
                                            "if":
                                              {
                                                "$lte":
                                                  [
                                                    "$$desugared_sqlSplit_split_expr",
                                                    { "$literal": null },
                                                  ],
                                              },
                                            "then": { "$literal": null },
                                            "else":
                                              {
                                                "$let":
                                                  {
                                                    "vars":
                                                      {
                                                        "desugared_sqlSplit_slice_expr":
                                                          {
                                                            "$slice":
                                                              [
                                                                "$$desugared_sqlSplit_split_expr",
                                                                {
                                                                  "$cond":
                                                                    {
                                                                      "if":
                                                                        {
                                                                          "$gt":
                                                                            [
                                                                              {
                                                                                "$abs":
                                                                                  [
                                                                                    "$$desugared_sqlSplit_input2",
                                                                                  ],
                                                                              },
                                                                              {
                                                                                "$size": "$$desugared_sqlSplit_split_expr",
                                                                              },
                                                                            ],
                                                                        },
                                                                      "then":
                                                                        {
                                                                          "$abs":
                                                                            [
                                                                              "$$desugared_sqlSplit_input2",
                                                                            ],
                                                                        },
                                                                      "else": "$$desugared_sqlSplit_input2",
                                                                    },
                                                                },
                                                                1,
                                                              ],
                                                          },
                                                      },
                                                    "in":
                                                      {
                                                        "$arrayElemAt":
                                                          [
                                                            {
                                                              "$cond":
                                                                {
                                                                  "if":
                                                                    {
                                                                      "$eq":
                                                                        [
                                                                          "$$desugared_sqlSplit_slice_expr",
                                                                          [],
                                                                        ],
                                                                    },
                                                                  "then":
                                                                    [""],
                                                                  "else": "$$desugared_sqlSplit_slice_expr",
                                                                },
                                                            },
                                                            0,
                                                          ],
                                                      },
                                                  },
                                              },
                                          },
                                      },
                                  },
                              },
                          },
                      },
                  },
              },
          },
      }

  - name: "desugar $sqlCos"
    skip_reason: "SQL-1257"
    input:
      - { "$project": { "_id": 0, "expr": { "$sqlCos": ["$v"] } } }
    expected:
      - {
        "$project":
          {
            "_id": { "$numberInt": "0" },
            "expr":
              {
                "$cond":
                  {
                    "if":
                      {
                        "$or":
                          [
                            {
                              "$eq":
                                [
                                  "$v",
                                  {
                                    "$literal":
                                      { "$numberDouble": "Infinity" },
                                  },
                                ],
                            },
                            {
                              "$eq":
                                [
                                  "$v",
                                  {
                                    "$literal":
                                      { "$numberDouble": "-Infinity" },
                                  },
                                ],
                            },
                          ],
                      },
                    "then": { "$literal": null },
                    "else": { "$cos": "$v" },
                  },
              },
          },
      }

  - name: "desugar $sqlSin"
    skip_reason: "SQL-1257"
    input:
      - { "$project": { "_id": 0, "expr": { "$sqlSin": ["$v"] } } }
    expected:
      - {
        "$project":
          {
            "_id": { "$numberInt": "0" },
            "expr":
              {
                "$cond":
                  {
                    "if":
                      {
                        "$or":
                          [
                            {
                              "$eq":
                                [
                                  "$v",
                                  {
                                    "$literal":
                                      { "$numberDouble": "Infinity" },
                                  },
                                ],
                            },
                            {
                              "$eq":
                                [
                                  "$v",
                                  {
                                    "$literal":
                                      { "$numberDouble": "-Infinity" },
                                  },
                                ],
                            },
                          ],
                      },
                    "then": { "$literal": null },
                    "else": { "$sin": "$v" },
                  },
              },
          },
      }

  - name: "desugar $sqlTan"
    skip_reason: "SQL-1257"
    input:
      - { "$project": { "_id": 0, "expr": { "$sqlTan": ["$v"] } } }
    expected:
      - {
        "$project":
          {
            "_id": { "$numberInt": "0" },
            "expr":
              {
                "$cond":
                  {
                    "if":
                      {
                        "$or":
                          [
                            {
                              "$eq":
                                [
                                  "$v",
                                  {
                                    "$literal":
                                      { "$numberDouble": "Infinity" },
                                  },
                                ],
                            },
                            {
                              "$eq":
                                [
                                  "$v",
                                  {
                                    "$literal":
                                      { "$numberDouble": "-Infinity" },
                                  },
                                ],
                            },
                          ],
                      },
                    "then": { "$literal": null },
                    "else": { "$tan": "$v" },
                  },
              },
          },
      }

  - name: "desugar $sqlSqrt"
    skip_reason: "SQL-1257"
    input:
      - { "$project": { "_id": 0, "expr": { "$sqlSqrt": ["$v"] } } }
    expected:
      - {
        "$project":
          {
            "_id": { "$numberInt": "0" },
            "expr":
              {
                "$let":
                  {
                    "vars": { "desugared_sqlSqrt_input": "$v" },
                    "in":
                      {
                        "$cond":
                          {
                            "if":
                              {
                                "$eq":
                                  [
                                    "$$desugared_sqlSqrt_input",
                                    {
                                      "$literal": { "$numberDouble": "NaN" },
                                    },
                                  ],
                              },
                            "then":
                              { "$literal": { "$numberDouble": "NaN" } },
                            "else":
                              {
                                "$cond":
                                  {
                                    "if":
                                      {
                                        "$lt":
                                          [
                                            "$$desugared_sqlSqrt_input",
                                            {
                                              "$literal":
                                                { "$numberInt": "0" },
                                            },
                                          ],
                                      },
                                    "then": { "$literal": null },
                                    "else":
                                      {
                                        "$sqrt": "$$desugared_sqlSqrt_input",
                                      },
                                  },
                              },
                          },
                      },
                  },
              },
          },
      }

  - name: "desugar $sqlMod"
    skip_reason: "SQL-1257"
    input:
      - {
        "$project":
          { "_id": 0, "expr": { "$sqlMod": ["$number", "$divisor"] } },
      }
    expected:
      - {
        "$project":
          {
            "_id": { "$numberInt": "0" },
            "expr":
              {
                "$let":
                  {
                    "vars":
                      {
                        "desugared_sqlMod_input0": "$number",
                        "desugared_sqlMod_input1": "$divisor",
                      },
                    "in":
                      {
                        "$cond":
                          {
                            "if":
                              {
                                "$eq":
                                  [
                                    "$$desugared_sqlMod_input1",
                                    { "$literal": { "$numberInt": "0" } },
                                  ],
                              },
                            "then": { "$literal": null },
                            "else":
                              {
                                "$mod":
                                  [
                                    "$$desugared_sqlMod_input0",
                                    "$$desugared_sqlMod_input1",
                                  ],
                              },
                          },
                      },
                  },
              },
          },
      }
