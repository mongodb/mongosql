tests:
  - name: "nothing to desugar"
    input:
      - { "$project": { "_id": 0, "expr": { "$sqlEq": ["$a", "$b"] } } }
    expected:
      - { "$project": { "_id": 0, "expr": { "$sqlEq": ["$a", "$b"] } } }

  - name: "dynamic desugar $sqlEq in match"
    input:
      - { "$match": { "$expr": { "$sqlEq": ["$a", "$b"] } } }
    expected:
      - {
        "$match":
          {
            "$and":
              [
                { "a": { "$exists": true } },
                { "a": { "$not": { "$type": "null" } } },
                { "b": { "$exists": true } },
                { "b": { "$not": { "$type": "null" } } },
              ],
          },
      }
      - { "$match": { "$expr": { "$eq": ["$a", "$b"] } } }

  - name: "dynamic desugar $sqlEq in match with dotted field paths"
    input:
      - { "$match": { "$expr": { "$sqlEq": ["$a.b", "$b.a"] } } }
    expected:
      - {
        "$match":
          {
            "$and":
              [
                { "a.b": { "$exists": true } },
                { "a.b": { "$not": { "$type": "null" } } },
                { "b.a": { "$exists": true } },
                { "b.a": { "$not": { "$type": "null" } } },
              ],
          },
      }
      - { "$match": { "$expr": { "$eq": ["$a.b", "$b.a"] } } }

  - name: "literal desugar $sqlEq in match"
    input:
      - { "$match": { "$expr": { "$sqlEq": ["$a", 10] } } }
    expected:
      - {
        "$match":
          {
            "$and":
              [
                { "a": { "$exists": true } },
                { "a": { "$not": { "$type": "null" } } },
              ],
          },
      }
      - { "$match": { "$expr": { "$eq": ["$a", { "$numberInt": "10" }] } } }

  - name: "nested $sql null semantic operators"
    input:
      - {
        "$match":
          {
            "$expr":
              { "$sqlEq": [{ "$sqlSize": "$a" }, { "$sqlSize": "$b" }] },
          },
      }
    expected:
      - {
        "$match":
          {
            "$and":
              [
                { "a": { "$exists": true } },
                { "a": { "$not": { "$type": "null" } } },
                { "b": { "$exists": true } },
                { "b": { "$not": { "$type": "null" } } },
              ],
          },
      }
      - {
        "$match":
          { "$expr": { "$eq": [{ "$size": "$a" }, { "$size": "$b" }] } },
      }

  - name: "duplicate values in $match do not get duplicated in schema constraints"
    input:
      - {
        "$match":
          {
            "$expr":
              {
                "$sqlAnd":
                  [{ "$sqlGt": ["$a", 5] }, { "$sqlLt": ["$a", 10] }],
              },
          },
      }
    expected:
      - {
        "$match":
          {
            "$and":
              [
                { "a": { "$exists": true } },
                { "a": { "$not": { "$type": "null" } } },
              ],
          },
      }
      - {
        "$match":
          {
            "$expr":
              {
                "$sqlAnd":
                  [
                    { "$gt": ["$a", { "$numberInt": "5" }] },
                    { "$lt": ["$a", { "$numberInt": "10" }] },
                  ],
              },
          },
      }

  - name: "same fields with different parents in $match show in schema constraints"
    input:
      - { "$match": { "$expr": { "$sqlEq": ["$a.a", "$b.a"] } } }
    expected:
      - {
        "$match":
          {
            "$and":
              [
                { "a.a": { "$exists": true } },
                { "a.a": { "$not": { "$type": "null" } } },
                { "b.a": { "$exists": true } },
                { "b.a": { "$not": { "$type": "null" } } },
              ],
          },
      }
      - { "$match": { "$expr": { "$eq": ["$a.a", "$b.a"] } } }
