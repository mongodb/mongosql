tests:
  - name: "nothing to desugar"
    input:
      - { "$project": { "_id": 0, "expr": { "$sqlEq": ["$a", "$b"] } } }
    expected:
      - { "$project": { "_id": 0, "expr": { "$sqlEq": ["$a", "$b"] } } }

  - name: "dynamic desugar $sqlEq in match"
    input:
      - { "$match": { "$expr": { "$sqlEq": ["$a", "$b"] } } }
    expected:
      - {
        "$match":
          {
            "$expr":
              {
                "$and":
                  [
                    { "$gt": ["$a", null] },
                    { "$gt": ["$b", null] },
                  ]
              }
          },
      }
      - { "$match": { "$expr": { "$eq": ["$a", "$b"] } } }

  - name: "dynamic desugar $sqlEq in match with dotted field paths"
    input:
      - { "$match": { "$expr": { "$sqlEq": ["$a.b", "$b.a"] } } }
    expected:
      - {
        "$match":
          {
            "$expr":
              {
                "$and":
                  [
                    { "$gt": ["$a.b", null] },
                    { "$gt": ["$b.a", null] },
                  ]
              }
          },
      }
      - { "$match": { "$expr": { "$eq": ["$a.b", "$b.a"] } } }

  - name: "literal desugar $sqlEq in match"
    input:
      - { "$match": { "$expr": { "$sqlEq": ["$a", 10] } } }
    expected:
      - { "$match": { "$gt": ["$a", null] } }
      - { "$match": { "$expr": { "$eq": ["$a", 10] } } }

  - name: "nested $sql null semantic operators"
    input:
      - {
        "$match":
          {
            "$expr":
              { "$sqlEq": [{ "$sqlSize": "$a" }, { "$sqlSize": "$b" }] },
          },
      }
    expected:
      - {
        "$match":
          {
            "$expr":
              {
                "$and":
                  [
                    { "$gt": ["$a", null] },
                    { "$gt": ["$b", null] },
                  ]
              }
          },
      }
      - {
        "$match":
          { "$expr": { "$eq": [{ "$size": "$a" }, { "$size": "$b" }] } },
      }

  - name: "duplicate values in $match do not get duplicated in schema constraints"
    input:
      - {
        "$match":
          {
            "$expr":
              {
                "$sqlAnd":
                  [{ "$sqlGt": ["$a", 5] }, { "$sqlLt": ["$a", 10] }],
              },
          },
      }
    expected:
      - { "$match": { "$gt": ["$a", null] } }
      - {
        "$match":
          {
            "$expr":
              {
                "$sqlAnd":
                  [
                    { "$gt": ["$a", 5] },
                    { "$lt": ["$a", 10] },
                  ],
              },
          },
      }

  - name: "same fields with different parents in $match show in schema constraints"
    input:
      - { "$match": { "$expr": { "$sqlEq": ["$a.a", "$b.a"] } } }
    expected:
      - {
        "$match":
          {
            "$expr":
              {
                "$and":
                  [
                    { "$gt": ["$a.a", null] },
                    { "$gt": ["$b.a", null] },
                  ]
              }
          },
      }
      - { "$match": { "$expr": { "$eq": ["$a.a", "$b.a"] } } }
